<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Memory Corner Â· Review Funnel</title>
  <style>
    :root {
      --bg:#0f172a;
      --card:#111827;
      --card-soft:#020617;
      --accent:#f97316;
      --accent-soft:#fed7aa;
      --accent-text:#7c2d12;
      --fg:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2933;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",system-ui,sans-serif;
      background:radial-gradient(circle at top,#1f2937 0,#020617 55%,#000 100%);
      color:var(--fg);
      min-height:100vh;
      padding:24px 16px 32px;
    }
    .shell{
      max-width:960px;
      margin:0 auto;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      margin-bottom:24px;
    }
    .title-block h1{
      margin:0 0 4px;
      font-size:22px;
      letter-spacing:0.02em;
    }
    .title-block p{
      margin:0;
      font-size:13px;
      color:var(--muted);
    }
    .controls{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    select,button{
      font:inherit;
    }
    .select{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.9);
      color:var(--fg);
    }
    .btn{
      padding:6px 14px;
      border-radius:999px;
      border:none;
      background:var(--accent);
      color:#111827;
      font-weight:600;
      cursor:pointer;
    }
    .btn:disabled{
      opacity:0.6;
      cursor:default;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
      margin-bottom:20px;
    }
    @media (max-width:768px){
      .grid{grid-template-columns:1fr;}
      .header{flex-direction:column;align-items:flex-start;}
    }
    .card{
      background:radial-gradient(circle at top left,#1f2937 0,#020617 55%);
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.15);
      padding:14px 14px 12px;
      box-shadow:0 18px 45px rgba(15,23,42,0.8);
      margin-bottom:14px;
    }
    .card-label{
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:6px;
    }
    .card-main{
      display:flex;
      align-items:baseline;
      gap:6px;
    }
    .card-value{
      font-size:22px;
      font-weight:600;
    }
    .card-unit{
      font-size:12px;
      color:var(--muted);
    }
    .card-sub{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }
    .badge-soft{
      display:inline-flex;
      align-items:center;
      gap:4px;
      border-radius:999px;
      padding:3px 8px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.2);
      font-size:11px;
      color:var(--muted);
    }
    .badge-dot{
      width:6px;height:6px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 0 4px rgba(248,153,60,0.25);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    thead{
      background:linear-gradient(to right,rgba(15,23,42,0.9),rgba(15,23,42,0.5));
    }
    th,td{
      padding:8px 10px;
      border-bottom:1px solid rgba(31,41,55,0.9);
      text-align:right;
      white-space:nowrap;
    }
    th:first-child,td:first-child{
      text-align:left;
    }
    th{
      font-weight:500;
      color:var(--muted);
      font-size:11px;
    }
    tbody tr:nth-child(even){
      background:rgba(15,23,42,0.6);
    }
    .empty{
      margin-top:8px;
      font-size:13px;
      color:var(--muted);
    }
    .tag-note{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="header">
      <div class="title-block">
        <h1>Memory Corner Â· Review Funnel</h1>
        <p>å¿«é€Ÿçœ‹å‡ºæ¯å¤©ç”¢ç”Ÿå¹¾å‰‡ã€é»æ“Š Google å¹¾æ¬¡ã€å¹³å‡å¤šä¹…é»æ“Šï¼Œä»¥åŠå“ªäº›æ¨™ç±¤è¡¨ç¾æœ€å¥½ã€‚</p>
      </div>
      <div class="controls">
        <span class="badge-soft">
          <span class="badge-dot"></span>
          <span id="rangeLabel">æœ€è¿‘ 30 å¤©</span>
        </span>
        <select id="daysSelect" class="select">
          <option value="7">æœ€è¿‘ 7 å¤©</option>
          <option value="14">æœ€è¿‘ 14 å¤©</option>
          <option value="30" selected>æœ€è¿‘ 30 å¤©</option>
          <option value="60">æœ€è¿‘ 60 å¤©</option>
        </select>
        <button id="reloadBtn" class="btn">Reload</button>
      </div>
    </header>

    <section class="grid">
      <article class="card">
        <div class="card-label">ç¸½ç”¢ç”Ÿç­†æ•¸</div>
        <div class="card-main">
          <div class="card-value" id="totalGenerated">â€“</div>
          <div class="card-unit">reviews</div>
        </div>
        <div class="card-sub" id="generatedPerDay">â€“</div>
      </article>

      <article class="card">
        <div class="card-label">Google é»æ“Šç‡</div>
        <div class="card-main">
          <div class="card-value" id="avgClickRate">â€“</div>
          <div class="card-unit">%</div>
        </div>
        <div class="card-sub" id="clickSummary">â€“</div>
      </article>

      <article class="card">
        <div class="card-label">å¹³å‡é»æ“Šæ™‚é–“</div>
        <div class="card-main">
          <div class="card-value" id="avgHours">â€“</div>
          <div class="card-unit">hr</div>
        </div>
        <div class="card-sub" id="hoursSummary">â€“</div>
      </article>
    </section>

    <!-- Daily funnel -->
    <section class="card">
      <div class="card-label" style="margin-bottom:8px;">Daily funnel</div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>Day</th>
              <th>Generated</th>
              <th>Clicked</th>
              <th>Posted</th>
              <th>Click %</th>
              <th>Posted %</th>
              <th>Avg hrs to click</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div id="emptyHint" class="empty" style="display:none;">
        ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œå…ˆå»è·‘å¹¾æ¬¡ Memory Corner çš„è¡¨å–®å§ ğŸ£
      </div>
    </section>

    <!-- Tag performance -->
    <section class="card">
      <div class="card-label" style="margin-bottom:8px;">Tag performance</div>
      <div style="overflow-x:auto;">
        <table>
         <thead>
  <tr>
    <th>Tag</th>
    <th>Times selected</th>
    <th>Google clicks</th>
    <th>Click-through rate</th>
  </tr>
</thead>
          <tbody id="tagTableBody"></tbody>
        </table>
      </div>
      <div id="tagEmptyHint" class="empty" style="display:none;">
        ç›®å‰é€™å€‹æœŸé–“æ²’æœ‰ä»»ä½•å¸¶æ¨™ç±¤çš„äº‹ä»¶ã€‚
      </div>
      <div class="tag-note">
 è¨»ï¼šTimes selected = ç”¢ç”Ÿè©•è«–æ™‚ï¼Œæœ‰å‹¾é¸åˆ°æ­¤æ¨™ç±¤çš„æ¬¡æ•¸ã€‚
  Google clicks = ä½¿ç”¨æ­¤æ¨™ç±¤ä¸”é»æ“Šã€Œè¤‡è£½ä¸¦é–‹å•Ÿ Google è©•è«–ã€çš„æ¬¡æ•¸ã€‚
  Click-through rate = é»æ“Šç‡ï¼ˆGoogle clicks Ã· Times selectedï¼‰ã€‚
      </div>
    </section>
  </div>

  <script>
    const daysSelect = document.getElementById('daysSelect');
    const reloadBtn = document.getElementById('reloadBtn');
    const rangeLabel = document.getElementById('rangeLabel');

    const totalGeneratedEl = document.getElementById('totalGenerated');
    const generatedPerDayEl = document.getElementById('generatedPerDay');
    const avgClickRateEl = document.getElementById('avgClickRate');
    const clickSummaryEl = document.getElementById('clickSummary');
    const avgHoursEl = document.getElementById('avgHours');
    const hoursSummaryEl = document.getElementById('hoursSummary');

    const tableBody = document.getElementById('tableBody');
    const emptyHint = document.getElementById('emptyHint');

    const tagTableBody = document.getElementById('tagTableBody');
    const tagEmptyHint = document.getElementById('tagEmptyHint');

    async function fetchFunnel(days) {
      const url = `/.netlify/functions/funnel?days=${encodeURIComponent(days)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Fetch funnel failed: ' + res.status);
      return res.json();
    }

    async function fetchTagFunnel(days) {
      const url = `/.netlify/functions/tag_funnel?days=${encodeURIComponent(days)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Fetch tag funnel failed: ' + res.status);
      return res.json();
    }

    function formatNumber(n, digits = 0) {
      if (n === null || n === undefined || isNaN(n)) return 'â€“';
      return Number(n).toLocaleString('en-US', {
        minimumFractionDigits: digits,
        maximumFractionDigits: digits,
      });
    }

    function computeSummary(rows, days) {
      if (!rows.length) {
        totalGeneratedEl.textContent = '0';
        generatedPerDayEl.textContent = 'æœ€è¿‘ ' + days + ' å¤©å°šç„¡è³‡æ–™';
        avgClickRateEl.textContent = 'â€“';
        clickSummaryEl.textContent = 'å°šæœªç”¢ç”Ÿä»»ä½•è©•è«–';
        avgHoursEl.textContent = 'â€“';
        hoursSummaryEl.textContent = 'å°šç„¡é»æ“Šè¡Œç‚º';
        return;
      }

      let totalGenerated = 0;
      let totalClicked = 0;
      let totalPosted = 0;
      let sumClickRate = 0;
      let countClickRate = 0;
      let sumHours = 0;
      let countHours = 0;

      rows.forEach((r) => {
        const g = Number(r.generated_count || 0);
        const c = Number(r.clicked_count || 0);
        const p = Number(r.posted_count || 0);
        const cr = r.click_rate_pct !== null ? Number(r.click_rate_pct) : null;
        const h = r.avg_hours_to_click !== null ? Number(r.avg_hours_to_click) : null;

        totalGenerated += g;
        totalClicked += c;
        totalPosted += p;
        if (cr !== null && !isNaN(cr)) {
          sumClickRate += cr;
          countClickRate += 1;
        }
        if (h !== null && !isNaN(h)) {
          sumHours += h;
          countHours += 1;
        }
      });

      const daysWithData = rows.length;
      const genPerDay = totalGenerated / daysWithData;
      const avgClickRate = countClickRate ? sumClickRate / countClickRate : null;
      const avgHours = countHours ? sumHours / countHours : null;

      totalGeneratedEl.textContent = formatNumber(totalGenerated);
      generatedPerDayEl.textContent = `å¹³å‡æ¯å¤©ç´„ ${formatNumber(genPerDay, 1)} å‰‡è©•è«–ç”¢ç”Ÿ`;

      avgClickRateEl.textContent = avgClickRate === null ? 'â€“' : formatNumber(avgClickRate, 1);
      if (totalGenerated > 0) {
        const overallRate = (totalClicked / totalGenerated) * 100;
        clickSummaryEl.textContent =
          `å…± ${formatNumber(totalClicked)} æ¬¡é»æ“Šï¼Œæ•´é«”é»æ“Šç‡ç´„ ${formatNumber(overallRate, 1)}%`;
      } else {
        clickSummaryEl.textContent = 'å°šæœªç”¢ç”Ÿä»»ä½•è©•è«–';
      }

      if (avgHours === null) {
        avgHoursEl.textContent = 'â€“';
        hoursSummaryEl.textContent = 'å°šç„¡é»æ“Šè³‡æ–™';
      } else {
        avgHoursEl.textContent = formatNumber(avgHours, 2);
        hoursSummaryEl.textContent = 'å¾ç”¢ç”Ÿåˆ°é»æ“Š Google çš„å¹³å‡æ™‚é–“';
      }
    }

    function renderDailyTable(rows) {
      tableBody.innerHTML = '';

      if (!rows.length) {
        emptyHint.style.display = 'block';
        return;
      }
      emptyHint.style.display = 'none';

      rows.forEach((r) => {
        const tr = document.createElement('tr');

        const dayTd = document.createElement('td');
        dayTd.textContent = r.day;
        tr.appendChild(dayTd);

        const genTd = document.createElement('td');
        genTd.textContent = formatNumber(r.generated_count);
        tr.appendChild(genTd);

        const clickTd = document.createElement('td');
        clickTd.textContent = formatNumber(r.clicked_count);
        tr.appendChild(clickTd);

        const postedTd = document.createElement('td');
        postedTd.textContent = formatNumber(r.posted_count);
        tr.appendChild(postedTd);

        const clickRateTd = document.createElement('td');
        clickRateTd.textContent = r.click_rate_pct === null
          ? 'â€“'
          : formatNumber(r.click_rate_pct, 1) + '%';
        tr.appendChild(clickRateTd);

        const postedRateTd = document.createElement('td');
        postedRateTd.textContent = r.posted_rate_pct === null
          ? 'â€“'
          : formatNumber(r.posted_rate_pct, 1) + '%';
        tr.appendChild(postedRateTd);

        const hoursTd = document.createElement('td');
        hoursTd.textContent = r.avg_hours_to_click === null
          ? 'â€“'
          : formatNumber(r.avg_hours_to_click, 2);
        tr.appendChild(hoursTd);

        tableBody.appendChild(tr);
      });
    }

    function renderTagTable(rows) {
      tagTableBody.innerHTML = '';

      if (!rows.length) {
        tagEmptyHint.style.display = 'block';
        return;
      }
      tagEmptyHint.style.display = 'none';

      rows.forEach((r) => {
        const tr = document.createElement('tr');

        const tagTd = document.createElement('td');
        tagTd.textContent = r.tag;
        tr.appendChild(tagTd);

        const genTd = document.createElement('td');
        genTd.textContent = formatNumber(r.generated_count);
        tr.appendChild(genTd);

        const clickTd = document.createElement('td');
        clickTd.textContent = formatNumber(r.clicked_count);
        tr.appendChild(clickTd);

        const rateTd = document.createElement('td');
        rateTd.textContent = r.click_rate_pct === null
          ? 'â€“'
          : formatNumber(r.click_rate_pct, 1) + '%';
        tr.appendChild(rateTd);

        tagTableBody.appendChild(tr);
      });
    }

    async function loadAndRender() {
      const days = parseInt(daysSelect.value, 10);
      rangeLabel.textContent = `æœ€è¿‘ ${days} å¤©`;
      reloadBtn.disabled = true;
      reloadBtn.textContent = 'Loadingâ€¦';

      try {
        const [dailyRows, tagRows] = await Promise.all([
          fetchFunnel(days),
          fetchTagFunnel(days),
        ]);
        renderDailyTable(dailyRows);
        computeSummary(dailyRows, days);
        renderTagTable(tagRows);
      } catch (err) {
        console.error(err);
        alert('è¼‰å…¥æ¼æ–—è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      } finally {
        reloadBtn.disabled = false;
        reloadBtn.textContent = 'Reload';
      }
    }

    reloadBtn.addEventListener('click', loadAndRender);
    daysSelect.addEventListener('change', loadAndRender);

    // åˆæ¬¡è¼‰å…¥
    loadAndRender();
  </script>
</body>
</html>

