<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Memory Corner Â· Review Funnel</title>
  <style>
    :root {
      --bg:#0f172a;
      --card:#111827;
      --card-soft:#020617;
      --accent:#f97316;
      --accent-soft:#fed7aa;
      --accent-text:#7c2d12;
      --fg:#e5e7eb;
      --muted:#9ca3af;
      --border:#1f2933;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",system-ui,sans-serif;
      background:radial-gradient(circle at top,#1f2937 0,#020617 55%,#000 100%);
      color:var(--fg);
      min-height:100vh;
      padding:24px 16px 32px;
    }
    .shell{
      max-width:960px;
      margin:0 auto;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      margin-bottom:24px;
    }
    .title-block h1{
      margin:0 0 4px;
      font-size:22px;
      letter-spacing:0.02em;
    }
    .title-block p{
      margin:0;
      font-size:13px;
      color:var(--muted);
    }
    .controls{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    select,button{
      font:inherit;
    }
    .select{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.9);
      color:var(--fg);
    }
    .btn{
      padding:6px 14px;
      border-radius:999px;
      border:none;
      background:var(--accent);
      color:#111827;
      font-weight:600;
      cursor:pointer;
    }
    .btn:disabled{
      opacity:0.6;
      cursor:default;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
      margin-bottom:20px;
    }
    @media (max-width:768px){
      .grid{grid-template-columns:1fr;}
      .header{flex-direction:column;align-items:flex-start;}
    }
    .card{
      background:radial-gradient(circle at top left,#1f2937 0,#020617 55%);
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.15);
      padding:14px 14px 12px;
      box-shadow:0 18px 45px rgba(15,23,42,0.8);
      margin-bottom:14px;
    }
    .card-label{
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:6px;
    }
    .card-main{
      display:flex;
      align-items:baseline;
      gap:6px;
    }
    .card-value{
      font-size:22px;
      font-weight:600;
    }
    .card-unit{
      font-size:12px;
      color:var(--muted);
    }
    .card-sub{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }
    .badge-soft{
      display:inline-flex;
      align-items:center;
      gap:4px;
      border-radius:999px;
      padding:3px 8px;
      background:rgba(15,23,42,0.9);
      border:1px solid rgba(148,163,184,0.2);
      font-size:11px;
      color:var(--muted);
    }
    .badge-dot{
      width:6px;height:6px;border-radius:999px;
      background:var(--accent);
      box-shadow:0 0 0 4px rgba(248,153,60,0.25);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    thead{
      background:linear-gradient(to right,rgba(15,23,42,0.9),rgba(15,23,42,0.5));
    }
    th,td{
      padding:8px 10px;
      border-bottom:1px solid rgba(31,41,55,0.9);
      text-align:right;
      white-space:nowrap;
    }
    th:first-child,td:first-child{
      text-align:left;
    }
    th{
      font-weight:500;
      color:var(--muted);
      font-size:11px;
    }
    tbody tr:nth-child(even){
      background:rgba(15,23,42,0.6);
    }
    .empty{
      margin-top:8px;
      font-size:13px;
      color:var(--muted);
    }
    .tag-note{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }

    /* sortable headers */
    th.sortable{
      cursor:pointer;
      user-select:none;
    }
    .sort-label{
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .sort-indicator{
      font-size:10px;
      opacity:0.4;
    }
    th.sort-asc .sort-indicator,
    th.sort-desc .sort-indicator{
      opacity:0.8;
    }

    /* insights */
    .insights-list{
      margin:6px 0 0;
      padding-left:18px;
      font-size:12px;
      color:var(--muted);
    }
    .insights-list li{
      margin-bottom:4px;
      line-height:1.6;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="header">
      <div class="title-block">
        <h1>Memory Corner Â· Review Funnel</h1>
        <p>å¿«é€Ÿçœ‹å‡ºæ¯å¤©ç”¢ç”Ÿå¹¾å‰‡ã€é»æ“Š Google å¹¾æ¬¡ã€å¹³å‡å¤šä¹…é»æ“Šï¼Œä»¥åŠå“ªäº›æ¨™ç±¤è¡¨ç¾æœ€å¥½ã€‚</p>
      </div>
      <div class="controls">
        <span class="badge-soft">
          <span class="badge-dot"></span>
          <span id="rangeLabel">æœ€è¿‘ 30 å¤©</span>
        </span>
        <select id="daysSelect" class="select">
          <option value="7">æœ€è¿‘ 7 å¤©</option>
          <option value="14">æœ€è¿‘ 14 å¤©</option>
          <option value="30" selected>æœ€è¿‘ 30 å¤©</option>
          <option value="60">æœ€è¿‘ 60 å¤©</option>
        </select>
        <button id="reloadBtn" class="btn">Reload</button>
      </div>
    </header>

    <section class="grid">
      <article class="card">
        <div class="card-label">ç¸½ç”¢ç”Ÿç­†æ•¸</div>
        <div class="card-main">
          <div class="card-value" id="totalGenerated">â€“</div>
          <div class="card-unit">reviews</div>
        </div>
        <div class="card-sub" id="generatedPerDay">â€“</div>
      </article>

      <article class="card">
        <div class="card-label">Google é»æ“Šç‡</div>
        <div class="card-main">
          <div class="card-value" id="avgClickRate">â€“</div>
          <div class="card-unit">%</div>
        </div>
        <div class="card-sub" id="clickSummary">â€“</div>
      </article>

      <article class="card">
        <div class="card-label">å¹³å‡é»æ“Šæ™‚é–“</div>
        <div class="card-main">
          <div class="card-value" id="avgHours">â€“</div>
          <div class="card-unit">hr</div>
        </div>
        <div class="card-sub" id="hoursSummary">â€“</div>
      </article>
    </section>

    <!-- Daily funnel -->
    <section class="card">
      <div class="card-label" style="margin-bottom:8px;">Daily funnel</div>
      <div style="overflow-x:auto;">
        <table id="dailyTable">
          <thead>
            <tr>
              <th class="sortable" data-sort-type="date">
                <span class="sort-label">Day<span class="sort-indicator">â†•</span></span>
              </th>
              <th class="sortable" data-sort-type="number">
                <span class="sort-label">Generated<span class="sort-indicator">â†•</span></span>
              </th>
              <th class="sortable" data-sort-type="number">
                <span class="sort-label">Clicked<span class="sort-indicator">â†•</span></span>
              </th>
              <th class="sortable" data-sort-type="number">
                <span class="sort-label">Posted<span class="sort-indicator">â†•</span></span>
              </th>
              <th class="sortable" data-sort-type="number">
                <span class="sort-label">Click %<span class="sort-indicator">â†•</span></span>
              </th>
              <th class="sortable" data-sort-type="number">
                <span class="sort-label">Posted %<span class="sort-indicator">â†•</span></span>
              </th>
              <th class="sortable" data-sort-type="number">
                <span class="sort-label">Avg hrs to click<span class="sort-indicator">â†•</span></span>
              </th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div id="emptyHint" class="empty" style="display:none;">
        ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œå…ˆå»è·‘å¹¾æ¬¡ Memory Corner çš„è¡¨å–®å§ ğŸ£
      </div>
    </section>

    <!-- Tag performance -->
    <section class="card">
      <div class="card-label" style="margin-bottom:8px;">Tag performance</div>
      <div style="overflow-x:auto;">
        <table id="tagTable">
          <thead>
            <tr>
              <th class="sortable" data-sort-type="text">
                <span class="sort-label">Tag<span class="sort-indicator">â†•</span></span>
              </th>
              <th class="sortable" data-sort-type="number">
                <span class="sort-label">Times selected<span class="sort-indicator">â†•</span></span>
              </th>
              <th class="sortable" data-sort-type="number">
                <span class="sort-label">Google clicks<span class="sort-indicator">â†•</span></span>
              </th>
              <th class="sortable" data-sort-type="number">
                <span class="sort-label">Click-through rate<span class="sort-indicator">â†•</span></span>
              </th>
            </tr>
          </thead>
          <tbody id="tagTableBody"></tbody>
        </table>
      </div>
      <div id="tagEmptyHint" class="empty" style="display:none;">
        ç›®å‰é€™å€‹æœŸé–“æ²’æœ‰ä»»ä½•å¸¶æ¨™ç±¤çš„äº‹ä»¶ã€‚
      </div>
      <div class="tag-note">
        è¨»ï¼šTimes selected = ç”¢ç”Ÿè©•è«–æ™‚ï¼Œæœ‰å‹¾é¸åˆ°æ­¤æ¨™ç±¤çš„æ¬¡æ•¸ã€‚<br/>
        Google clicks = ä½¿ç”¨æ­¤æ¨™ç±¤ä¸”é»æ“Šã€Œè¤‡è£½ä¸¦é–‹å•Ÿ Google è©•è«–ã€çš„æ¬¡æ•¸ã€‚<br/>
        Click-through rate = é»æ“Šç‡ï¼ˆGoogle clicks Ã· Times selectedï¼‰ã€‚
      </div>
    </section>

    <!-- Key insights -->
    <section class="card">
      <div class="card-label" style="margin-bottom:8px;">Key insights</div>
      <ul id="insightsList" class="insights-list"></ul>
    </section>
  </div>

  <script>
    const daysSelect = document.getElementById('daysSelect');
    const reloadBtn = document.getElementById('reloadBtn');
    const rangeLabel = document.getElementById('rangeLabel');

    const totalGeneratedEl = document.getElementById('totalGenerated');
    const generatedPerDayEl = document.getElementById('generatedPerDay');
    const avgClickRateEl = document.getElementById('avgClickRate');
    const clickSummaryEl = document.getElementById('clickSummary');
    const avgHoursEl = document.getElementById('avgHours');
    const hoursSummaryEl = document.getElementById('hoursSummary');

    const tableBody = document.getElementById('tableBody');
    const emptyHint = document.getElementById('emptyHint');

    const tagTableBody = document.getElementById('tagTableBody');
    const tagEmptyHint = document.getElementById('tagEmptyHint');

    const insightsList = document.getElementById('insightsList');

    async function fetchFunnel(days) {
      const url = `/.netlify/functions/funnel?days=${encodeURIComponent(days)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Fetch funnel failed: ' + res.status);
      return res.json();
    }

    async function fetchTagFunnel(days) {
      const url = `/.netlify/functions/tag_funnel?days=${encodeURIComponent(days)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('Fetch tag funnel failed: ' + res.status);
      return res.json();
    }

    function formatNumber(n, digits = 0) {
      if (n === null || n === undefined || isNaN(n)) return 'â€“';
      return Number(n).toLocaleString('en-US', {
        minimumFractionDigits: digits,
        maximumFractionDigits: digits,
      });
    }

    function computeSummary(rows, days) {
      if (!rows.length) {
        totalGeneratedEl.textContent = '0';
        generatedPerDayEl.textContent = 'æœ€è¿‘ ' + days + ' å¤©å°šç„¡è³‡æ–™';
        avgClickRateEl.textContent = 'â€“';
        clickSummaryEl.textContent = 'å°šæœªç”¢ç”Ÿä»»ä½•è©•è«–';
        avgHoursEl.textContent = 'â€“';
        hoursSummaryEl.textContent = 'å°šç„¡é»æ“Šè¡Œç‚º';
        return;
      }

      let totalGenerated = 0;
      let totalClicked = 0;
      let totalPosted = 0;
      let sumClickRate = 0;
      let countClickRate = 0;
      let sumHours = 0;
      let countHours = 0;

      rows.forEach((r) => {
        const g = Number(r.generated_count || 0);
        const c = Number(r.clicked_count || 0);
        const p = Number(r.posted_count || 0);
        const cr = r.click_rate_pct !== null ? Number(r.click_rate_pct) : null;
        const h = r.avg_hours_to_click !== null ? Number(r.avg_hours_to_click) : null;

        totalGenerated += g;
        totalClicked += c;
        totalPosted += p;
        if (cr !== null && !isNaN(cr)) {
          sumClickRate += cr;
          countClickRate += 1;
        }
        if (h !== null && !isNaN(h)) {
          sumHours += h;
          countHours += 1;
        }
      });

      const daysWithData = rows.length;
      const genPerDay = totalGenerated / daysWithData;
      const avgClickRate = countClickRate ? sumClickRate / countClickRate : null;
      const avgHours = countHours ? sumHours / countHours : null;

      totalGeneratedEl.textContent = formatNumber(totalGenerated);
      generatedPerDayEl.textContent = `å¹³å‡æ¯å¤©ç´„ ${formatNumber(genPerDay, 1)} å‰‡è©•è«–ç”¢ç”Ÿ`;

      avgClickRateEl.textContent = avgClickRate === null ? 'â€“' : formatNumber(avgClickRate, 1);
      if (totalGenerated > 0) {
        const overallRate = (totalClicked / totalGenerated) * 100;
        clickSummaryEl.textContent =
          `å…± ${formatNumber(totalClicked)} æ¬¡é»æ“Šï¼Œæ•´é«”é»æ“Šç‡ç´„ ${formatNumber(overallRate, 1)}%`;
      } else {
        clickSummaryEl.textContent = 'å°šæœªç”¢ç”Ÿä»»ä½•è©•è«–';
      }

      if (avgHours === null) {
        avgHoursEl.textContent = 'â€“';
        hoursSummaryEl.textContent = 'å°šç„¡é»æ“Šè³‡æ–™';
      } else {
        avgHoursEl.textContent = formatNumber(avgHours, 2);
        hoursSummaryEl.textContent = 'å¾ç”¢ç”Ÿåˆ°é»æ“Š Google çš„å¹³å‡æ™‚é–“';
      }
    }

    function renderDailyTable(rows) {
      tableBody.innerHTML = '';

      if (!rows.length) {
        emptyHint.style.display = 'block';
        return;
      }
      emptyHint.style.display = 'none';

      rows.forEach((r) => {
        const tr = document.createElement('tr');

        // Dayï¼šåªé¡¯ç¤º YYYY-MM-DDï¼Œä½† dataset ä¿ç•™åŸå§‹å€¼çµ¦æ’åºç”¨
        const dayTd = document.createElement('td');
        const rawDay = r.day || '';
        dayTd.dataset.sortValue = rawDay;
        const displayDay = rawDay && rawDay.length >= 10 ? rawDay.slice(0, 10) : rawDay;
        dayTd.textContent = displayDay;
        tr.appendChild(dayTd);

        const genTd = document.createElement('td');
        genTd.dataset.sortValue = r.generated_count ?? 0;
        genTd.textContent = formatNumber(r.generated_count);
        tr.appendChild(genTd);

        const clickTd = document.createElement('td');
        clickTd.dataset.sortValue = r.clicked_count ?? 0;
        clickTd.textContent = formatNumber(r.clicked_count);
        tr.appendChild(clickTd);

        const postedTd = document.createElement('td');
        postedTd.dataset.sortValue = r.posted_count ?? 0;
        postedTd.textContent = formatNumber(r.posted_count);
        tr.appendChild(postedTd);

        const clickRateTd = document.createElement('td');
        if (r.click_rate_pct === null || r.click_rate_pct === undefined) {
          clickRateTd.dataset.sortValue = '';
          clickRateTd.textContent = 'â€“';
        } else {
          clickRateTd.dataset.sortValue = r.click_rate_pct;
          clickRateTd.textContent = formatNumber(r.click_rate_pct, 1) + '%';
        }
        tr.appendChild(clickRateTd);

        const postedRateTd = document.createElement('td');
        if (r.posted_rate_pct === null || r.posted_rate_pct === undefined) {
          postedRateTd.dataset.sortValue = '';
          postedRateTd.textContent = 'â€“';
        } else {
          postedRateTd.dataset.sortValue = r.posted_rate_pct;
          postedRateTd.textContent = formatNumber(r.posted_rate_pct, 1) + '%';
        }
        tr.appendChild(postedRateTd);

        const hoursTd = document.createElement('td');
        if (r.avg_hours_to_click === null || r.avg_hours_to_click === undefined) {
          hoursTd.dataset.sortValue = '';
          hoursTd.textContent = 'â€“';
        } else {
          hoursTd.dataset.sortValue = r.avg_hours_to_click;
          hoursTd.textContent = formatNumber(r.avg_hours_to_click, 2);
        }
        tr.appendChild(hoursTd);

        tableBody.appendChild(tr);
      });
    }

    function renderTagTable(rows) {
      tagTableBody.innerHTML = '';

      if (!rows.length) {
        tagEmptyHint.style.display = 'block';
        return;
      }
      tagEmptyHint.style.display = 'none';

      rows.forEach((r) => {
        const tr = document.createElement('tr');

        const tagTd = document.createElement('td');
        tagTd.dataset.sortValue = r.tag || '';
        tagTd.textContent = r.tag;
        tr.appendChild(tagTd);

        const genTd = document.createElement('td');
        genTd.dataset.sortValue = r.generated_count ?? 0;
        genTd.textContent = formatNumber(r.generated_count);
        tr.appendChild(genTd);

        const clickTd = document.createElement('td');
        clickTd.dataset.sortValue = r.clicked_count ?? 0;
        clickTd.textContent = formatNumber(r.clicked_count);
        tr.appendChild(clickTd);

        const rateTd = document.createElement('td');
        if (r.click_rate_pct === null || r.click_rate_pct === undefined) {
          rateTd.dataset.sortValue = '';
          rateTd.textContent = 'â€“';
        } else {
          rateTd.dataset.sortValue = r.click_rate_pct;
          rateTd.textContent = formatNumber(r.click_rate_pct, 1) + '%';
        }
        tr.appendChild(rateTd);

        tagTableBody.appendChild(tr);
      });
    }

    // ------ Insightsï¼šç¸½çµ + é€™é€± vs ä¸Šé€± + ç†±é–€ï¼å¾…å„ªåŒ–æ¨™ç±¤ ------
    function buildInsights(dailyRows, tagRows, days) {
      if (!insightsList) return;
      insightsList.innerHTML = '';

      const add = (text) => {
        const li = document.createElement('li');
        li.textContent = text;
        insightsList.appendChild(li);
      };

      // æ²’ä»»ä½•è³‡æ–™
      if (!dailyRows.length) {
        add(`æœ€è¿‘ ${days} å¤©é‚„æ²’æœ‰ä»»ä½•è©•è«–ï¼Œå…ˆé‚€è«‹å¹¾ä½ç†Ÿå®¢ä¾†å¹«å¿™ç•™ä¸‹ç¬¬ä¸€æ‰¹ Google è©•è«–å§ã€‚`);
        return;
      }

      // æ•´é«”çµ±è¨ˆ
      let totalGenerated = 0;
      let totalClicked = 0;
      let totalPosted = 0;

      dailyRows.forEach((r) => {
        totalGenerated += Number(r.generated_count || 0);
        totalClicked  += Number(r.clicked_count || 0);
        totalPosted   += Number(r.posted_count || 0);
      });

      const clickRate  = totalGenerated ? (totalClicked / totalGenerated) * 100 : null;
      const postedRate = totalGenerated ? (totalPosted  / totalGenerated) * 100 : null;

      add(
        `æœ€è¿‘ ${days} å¤©å…±ç”¢ç”Ÿ ${formatNumber(totalGenerated)} å‰‡è©•è«–ï¼Œå…¶ä¸­ ` +
        `${formatNumber(totalClicked)} æ¬¡é»æ“Šå‰å¾€ Googleï¼Œæ•´é«”é»æ“Šç‡ç´„ ` +
        `${clickRate === null ? 'â€“' : formatNumber(clickRate, 1)}%ã€‚`
      );

      if (postedRate !== null) {
        add(
          `åœ¨æ‰€æœ‰å·²é»æ“Šçš„è©•è«–ä¸­ï¼Œå¤§ç´„æœ‰ ${formatNumber(postedRate, 1)}% è¢«æ¨™è¨˜ç‚ºã€Œå·²ç™¼ä½ˆã€ã€‚`
        );
      }

      // é€™é€± vs ä¸Šé€±ï¼ˆç”¨æœ€è¿‘ 7 å¤© vs å¾€å‰æ¨çš„ 7 å¤©ï¼Œåªè¦è³‡æ–™å¤ å°±ç®—ï¼‰
      const sorted = [...dailyRows].sort((a, b) => {
        const da = Date.parse(a.day || '');
        const db = Date.parse(b.day || '');
        return da - db;
      });

      if (sorted.length >= 4) { // è‡³å°‘æœ‰ä¸€äº›è³‡æ–™æ‰æœ‰æ„ç¾©
        const last7 = sorted.slice(-7);
        const prev7 = sorted.slice(-14, -7);

        const lastLen = last7.length;
        const prevLen = prev7.length;

        if (lastLen > 0 && prevLen > 0) {
          const lastTotal = last7.reduce((sum, r) => sum + Number(r.generated_count || 0), 0);
          const prevTotal = prev7.reduce((sum, r) => sum + Number(r.generated_count || 0), 0);
          const lastPerDay = lastTotal / lastLen;
          const prevPerDay = prevTotal / prevLen;

          if (prevPerDay > 0) {
            const diff = lastPerDay - prevPerDay;
            const pct = (diff / prevPerDay) * 100;

            if (pct > 5) {
              add(
                `æœ€è¿‘ 7 å¤©å¹³å‡æ¯å¤©ç´„ ${formatNumber(lastPerDay, 1)} å‰‡è©•è«–ï¼Œ` +
                `æ¯”å‰ 7 å¤©çš„ ${formatNumber(prevPerDay, 1)} å‰‡å¤šäº†ç´„ ${formatNumber(pct, 1)}%ï¼Œ` +
                `è©•è«–ç”¢ç”Ÿé‡æ­£åœ¨å¾€ä¸Šèµ°ã€‚`
              );
            } else if (pct < -5) {
              add(
                `æœ€è¿‘ 7 å¤©å¹³å‡æ¯å¤©ç´„ ${formatNumber(lastPerDay, 1)} å‰‡è©•è«–ï¼Œ` +
                `æ¯”å‰ 7 å¤©çš„ ${formatNumber(prevPerDay, 1)} å‰‡å°‘äº†ç´„ ${formatNumber(-pct, 1)}%ï¼Œ` +
                `å¯ä»¥è€ƒæ…®åœ¨ç¾å ´å¤šä¸€é»å¼•å°å®¢äººç•™ä¸‹è©•è«–ã€‚`
              );
            } else {
              add(
                `æœ€è¿‘ 7 å¤©èˆ‡å‰ 7 å¤©çš„å¹³å‡ç”¢ç”Ÿé‡å¤§è‡´ç›¸è¿‘ï¼ˆç´„ ` +
                `${formatNumber(lastPerDay, 1)} vs ${formatNumber(prevPerDay, 1)} å‰‡ï¼å¤©ï¼‰ï¼Œ` +
                `æ•´é«”è¡¨ç¾ç®—æ˜¯ç©©å®šã€‚`
              );
            }
          }
        }
      }

      // æ¨™ç±¤è¡¨ç¾ï¼šæœ€å¤šä½¿ç”¨ + é»æ“Šç‡æœ€é«˜çš„ç†±é–€æ¨™ç±¤ + é»æ“Šç‡åä½çš„æ¨™ç±¤
      if (tagRows && tagRows.length) {
        const sortedByGenerated = [...tagRows].sort(
          (a, b) => (b.generated_count || 0) - (a.generated_count || 0)
        );
        const topByUsed = sortedByGenerated[0];
        if (topByUsed && topByUsed.generated_count > 0) {
          add(
            `ä½¿ç”¨æ¬¡æ•¸æœ€å¤šçš„æ¨™ç±¤æ˜¯ã€Œ${topByUsed.tag}ã€ï¼Œå…±è¢«é¸æ“‡ ` +
            `${formatNumber(topByUsed.generated_count)} æ¬¡ï¼Œæ˜¯ç›®å‰å®¢äººæœ€å¸¸æåˆ°çš„äº®é»ã€‚`
          );
        }

        // ç¯©å‡ºã€Œæœ‰ä¸€å®šæ¨£æœ¬æ•¸ã€çš„æ¨™ç±¤
        const withSample = tagRows.filter((t) => (t.generated_count || 0) >= 3);

        if (withSample.length) {
          // é«˜è¡¨ç¾ç†±é–€æ¨™ç±¤ï¼šTimes selected >=3 ä¸” Click-through rate >= 80%
          const strong = withSample
            .filter((t) => (t.click_rate_pct || 0) >= 80)
            .sort((a, b) => (b.click_rate_pct || 0) - (a.click_rate_pct || 0));

          if (strong.length) {
            const names = strong.slice(0, 3).map((t) => `ã€Œ${t.tag}ã€`).join('ã€');
            add(
              `${names} çš„é»æ“Šç‡è¡¨ç¾ç‰¹åˆ¥å¥½ï¼Œå¯ä»¥å¤šé¼“å‹µåº—å…§å¤¥ä¼´åœ¨ä»‹ç´¹èœè‰²æ™‚å¤šæåˆ°é€™äº›äº®é»ã€‚`
            );
          }

          // éœ€è¦å„ªåŒ–çš„æ¨™ç±¤ï¼šTimes selected >=3 ä¸” Click-through rate < 60%
          const under = withSample
            .filter((t) => (t.click_rate_pct || 0) < 60)
            .sort((a, b) => (a.click_rate_pct || 0) - (b.click_rate_pct || 0));

          if (under.length) {
            const names = under.slice(0, 3).map((t) => `ã€Œ${t.tag}ã€`).join('ã€');
            add(
              `${names} çš„é»æ“Šç‡ç›¸å°è¼ƒä½ï¼Œå»ºè­°æª¢æŸ¥é€™äº›æ¨™ç±¤çš„æ–‡æ¡ˆæ˜¯å¦æ¸…æ¥šï¼Œ` +
              `æˆ–æ˜¯åœ¨ç¾å ´å¤šä¸€é»å£é ­å¼•å°ï¼Œå¹«åŠ©å®¢äººç†è§£é€™äº›è³£é»ã€‚`
            );
          }
        }
      }
    }

    // ------ é€šç”¨æ’åºåŠŸèƒ½ ------
    function setupSortableTable(tableId) {
      const table = document.getElementById(tableId);
      if (!table) return;
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      if (!thead || !tbody) return;

      thead.addEventListener('click', (e) => {
        const th = e.target.closest('th.sortable');
        if (!th) return;

        const ths = Array.from(thead.querySelectorAll('th.sortable'));
        const columnIndex = ths.indexOf(th);
        if (columnIndex === -1) return;

        const type = th.dataset.sortType || 'text';

        // æ±ºå®šæ’åºæ–¹å‘
        let direction = th.dataset.sortDir === 'asc' ? 'desc' : 'asc';
        ths.forEach((h) => {
          if (h !== th) {
            h.dataset.sortDir = '';
            h.classList.remove('sort-asc', 'sort-desc');
            const span = h.querySelector('.sort-indicator');
            if (span) span.textContent = 'â†•';
          }
        });
        th.dataset.sortDir = direction;
        th.classList.toggle('sort-asc', direction === 'asc');
        th.classList.toggle('sort-desc', direction === 'desc');
        const indicator = th.querySelector('.sort-indicator');
        if (indicator) indicator.textContent = direction === 'asc' ? 'â–²' : 'â–¼';

        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
          const aCell = a.children[columnIndex];
          const bCell = b.children[columnIndex];
          const aRaw = aCell?.dataset.sortValue ?? aCell?.textContent ?? '';
          const bRaw = bCell?.dataset.sortValue ?? bCell?.textContent ?? '';

          let aVal = aRaw;
          let bVal = bRaw;

          if (type === 'number') {
            aVal = aRaw === '' ? NaN : Number(aRaw);
            bVal = bRaw === '' ? NaN : Number(bRaw);
          } else if (type === 'date') {
            aVal = aRaw ? Date.parse(aRaw) : NaN;
            bVal = bRaw ? Date.parse(bRaw) : NaN;
          } else { // text
            aVal = String(aRaw).toLowerCase();
            bVal = String(bRaw).toLowerCase();
          }

          if (isNaN(aVal) && type !== 'text') return 1;
          if (isNaN(bVal) && type !== 'text') return -1;

          if (aVal < bVal) return direction === 'asc' ? -1 : 1;
          if (aVal > bVal) return direction === 'asc' ? 1 : -1;
          return 0;
        });

        tbody.innerHTML = '';
        rows.forEach((row) => tbody.appendChild(row));
      });
    }

    async function loadAndRender() {
      const days = parseInt(daysSelect.value, 10);
      rangeLabel.textContent = `æœ€è¿‘ ${days} å¤©`;
      reloadBtn.disabled = true;
      reloadBtn.textContent = 'Loadingâ€¦';

      try {
        const [dailyRows, tagRows] = await Promise.all([
          fetchFunnel(days),
          fetchTagFunnel(days),
        ]);
        renderDailyTable(dailyRows);
        computeSummary(dailyRows, days);
        renderTagTable(tagRows);
        buildInsights(dailyRows, tagRows, days);
      } catch (err) {
        console.error(err);
        alert('è¼‰å…¥æ¼æ–—è³‡æ–™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
      } finally {
        reloadBtn.disabled = false;
        reloadBtn.textContent = 'Reload';
      }
    }

    reloadBtn.addEventListener('click', loadAndRender);
    daysSelect.addEventListener('change', loadAndRender);

    // åˆæ¬¡è¼‰å…¥ + å•Ÿç”¨æ’åº
    loadAndRender().then(() => {
      setupSortableTable('dailyTable');
      setupSortableTable('tagTable');
    });
  </script>
</body>
</html>



