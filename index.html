<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Google Review</title>
  <style>
    :root{--bg:#f6f4ef;--ink:#111827;--muted:#6b7280;--card:#fff;--pill:#eef2f7;--brand:#111827}
    *{box-sizing:border-box} html,body{margin:0;height:100%}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:820px;margin:0 auto;padding:18px}
    header{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .logo{width:32px;height:32px;border-radius:10px;background:conic-gradient(from 0deg,#38bdf8,#a78bfa,#22c55e,#38bdf8)}
    h1{font-size:clamp(22px,4.2vw,32px);margin:0}
    .muted{color:var(--muted)}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:14px;box-shadow:0 8px 30px -20px rgba(0,0,0,.25)}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .pill{padding:10px 12px;border-radius:999px;border:1px solid #e5e7eb;background:var(--pill);cursor:pointer;user-select:none}
    .pill.selected{outline:3px solid #bae6fd;background:#e0f2fe}
    textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb;min-height:120px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:12px;border:1px solid #111827;color:#fff;background:var(--brand);font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:#111827}
    .alert{display:none;margin-top:8px;color:#ef4444}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo"></div>
    <div>
      <div style="font-weight:800">Smart Google Review</div>
      <div class="muted" id="storeLine">è¼‰å…¥ä¸­â€¦ / Loadingâ€¦</div>
    </div>
  </header>

  <div class="card">
    <h1 id="title">ç‚ºæ­¤åº—å¯«ä¸€å‰‡çŸ­è©•</h1>

    <div id="tags" class="row" style="margin:6px 0 10px"></div>

    <div class="row" style="margin:8px 0">
      <button id="gen" class="btn">âœ¨ ç”Ÿæˆï¼ˆAIï¼‰</button>
      <button id="copy" class="btn secondary">ğŸ“‹ è¤‡è£½</button>
    </div>

    <textarea id="review" placeholder="ç”Ÿæˆæ–‡å­—æœƒå‡ºç¾åœ¨é€™è£¡â€¦"></textarea>

    <div class="row" style="margin:10px 0 0">
      <a id="open" class="btn" href="#" target="_blank" rel="noopener">ğŸ”— é–‹å•Ÿ Google è©•è«–</a>
    </div>

    <div class="alert" id="err"></div>
  </div>
</div>

<script>
const SHEET_ID = (new URLSearchParams(location.search).get('sheet_id')) || "1XxJtStsls55XyeMwSZuPEKX_lo6YidMRj2qtmkXsC80";
const SHEET_NAME = (new URLSearchParams(location.search).get('sheet')) || "stores";

const qs=(s)=>document.querySelector(s);
const qsa=(s)=>Array.from(document.querySelectorAll(s));
const getParam=(k)=>new URLSearchParams(location.search).get(k);
function csvParse(text){ const rows=[]; let i=0,cur='',inQ=false,row=[]; while(i<text.length){ const ch=text[i];
  if(inQ){ if(ch=='"' && text[i+1]=='"'){cur+='"'; i++;} else if(ch=='"'){inQ=false;} else cur+=ch; }
  else{ if(ch=='"') inQ=true; else if(ch==','){row.push(cur);cur='';} else if(ch=='\n'){row.push(cur);rows.push(row);row=[];cur='';} else cur+=ch; }
  i++; } if(cur.length||row.length){row.push(cur);rows.push(row);} return rows; }
function uniq(arr){return [...new Set(arr.filter(Boolean).map(s=>s.trim()).filter(Boolean))];}
function splitTags(s){ if(!s) return []; return s.split(/[ã€,]/).map(x=>x.trim()).filter(Boolean); }
function err(msg){ const el=qs('#err'); el.textContent=msg; el.style.display='block'; }

async function loadSheetRows(sheetName){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('Network '+res.status);
  const txt = await res.text();
  const rows = csvParse(txt);
  const headers = rows[0].map(h=>h.trim());
  return rows.slice(1).map(r=>Object.fromEntries(headers.map((h,i)=>[h, r[i]||''])));
}

function buildUI(row){
  const store=row.StoreName||'';
  const pid=row.PlaceID||'';
  const tags = uniq([
    ...splitTags(row.Top3Items||''),
    ...splitTags(row.StoreFeatures||''),
    ...splitTags(row.Ambiance||''),
    ...splitTags(row['æ–°å“']||row.tags_new||'')
  ]);
  qs('#storeLine').textContent = store?`æ­£åœ¨ç‚ºã€Œ${store}ã€å¯«ä¸€å‰‡çŸ­è©•`:'ç„¡åº—å';
  qs('#title').textContent = store?`ç‚ºã€Œ${store}ã€å¯«ä¸€å‰‡çŸ­è©•`:'ç‚ºæ­¤åº—å¯«ä¸€å‰‡çŸ­è©•';
  qs('#open').href = pid?`https://search.google.com/local/writereview?placeid=${encodeURIComponent(pid)}`:'#';
  const wrap = qs('#tags'); wrap.innerHTML='';
  if(!tags.length){ wrap.innerHTML='<span class="muted">æ­¤åº—å°šç„¡æ¨™ç±¤</span>'; }
  tags.forEach(t=>{ const el=document.createElement('div'); el.className='pill'; el.textContent=t; el.onclick=()=>el.classList.toggle('selected'); wrap.appendChild(el); });
}

function sample(a){return a[Math.floor(Math.random()*a.length)]}
function genLocal(tags, store){
  const openers=[`å‰›åˆ°è¨ª${store||'é€™å®¶åº—'}ï¼Œæ•´é«”é«”é©—å¾ˆä¸éŒ¯ã€‚`,`ä»Šå¤©åœ¨${store||'é€™è£¡'}çš„é«”é©—è®“äººé©šå–œã€‚`,`${store||'é€™é–“åº—'}è®“æˆ‘å°è±¡å¾ˆå¥½ã€‚`];
  const feels=['é †å£','åˆ°ä½','è®“äººæ”¾é¬†','å€¼å¾—æ¨è–¦'];
  const picked=tags.slice(0,6).join('ã€');
  const line2=tags.length?`é‡é»ï¼šã€Œ${picked}ã€ã€‚`:'';
  return `${sample(openers)} ${line2}${sample(feels)}ã€‚`.trim();
}

(async()=>{
  try{
    const all = await loadSheetRows(SHEET_NAME);
    const sid=(getParam('storeid')||'').toLowerCase();
    const row = all.find(d => (d.StoreID||'').toLowerCase()===sid) || all[0];
    if(!row){ err('æ‰¾ä¸åˆ°å°æ‡‰åº—å®¶'); return; }
    buildUI(row);

    qs('#gen').onclick=async()=>{
      const picked=qsa('.pill.selected').map(x=>x.textContent);
      try{
        const resp = await fetch('/.netlify/functions/generate', {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            storeid: row.StoreID,
            selectedTags: picked,
            lang: 'zh-Hant',
            tone: 'friendly'
          })
        });
        if(!resp.ok) throw new Error('API error '+resp.status);
        const data = await resp.json();
        qs('#review').value = data.reviewText || genLocal(picked, row.StoreName||'');
      }catch(e){
        qs('#review').value = genLocal(picked, row.StoreName||'');
      }
    };

    qs('#copy').onclick=async()=>{
      const t=qs('#review').value.trim(); if(!t) return;
      try{ await navigator.clipboard.writeText(t); alert('å·²è¤‡è£½ï¼Œæ‰“é–‹ Google å¾Œè²¼ä¸Šå³å¯ã€‚'); }catch{ alert('ç„¡æ³•è‡ªå‹•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é•·æŒ‰è¤‡è£½ã€‚'); }
    };
  }catch(e){ err('è¼‰å…¥è¡¨å–®å¤±æ•—æˆ–è¡¨å–®æœªå…¬é–‹ï¼ˆAnyone with the link â†’ Viewerï¼‰'); console.error(e); }
})();
</script>
</body>
</html>
