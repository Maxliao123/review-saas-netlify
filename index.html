<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Smart Google Review Â· AI ä¸€å‰‡çŸ­è©•</title>
  <style>
    :root{
      /* Neutrals */
      --bg:#F5F7FB;
      --card:#FFFFFF;
      --fg:#0F172A;
      --muted:#64748B;

      /* åŸºè‰²ï¼ˆæœƒè¢« JS ä¾ AD æ¬„è¦†è“‹ï¼‰ */
      --blue:#0A84FF;

      /* å…¶é¤˜ token å…ˆçµ¦é è¨­ï¼Œé¦–å±é¿å… FOUTï¼›ç¨å¾Œç”± JS è¦†è“‹ */
      --blue-600:#0A84FF; /* = baseï¼Œä¸èµ°æ›´æ·± */
      --blue-500:#0A84FF; /* = base */
      --blue-400:#49A2FF; /* è®Šäº® */
      --blue-300:#7CB9FF; /* è®Šäº® */
      --blue-200:#CDE5FF; /* è®Šäº® */
      --blue-100:#EAF4FF; /* è®Šäº® */
      --blue-050:#F3F9FF; /* è®Šäº® */
      --blue-hover:#49A2FF;  /* æ¯” base æ·ºä¸€é» */
      --blue-active:#0A84FF; /* å›åˆ° baseï¼Œä¸æ›´æ·± */
      --on-blue:#FFFFFF;

      /* Components */
      --chip-bg:var(--blue-100);
      --chip-bg-on:var(--blue-500);
      --chip-fg:#0F172A;
      --chip-fg-on:#FFFFFF;

      --fs-title-max: 28px;
      --fs-title-min: 18px;
      --fs-body:  clamp(13px, 1.2vw + 10px, 16px);
      --fs-chip:  clamp(12px, 1vw  + 8px, 14px);
      --fs-btn:   clamp(14px, 1.2vw + 11px, 16px);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 10px;

      --shadow: 0 10px 30px rgba(15,23,42,0.08);
      --shadow-soft: 0 6px 20px rgba(15,23,42,0.06);

      --ring: 0 0 0 3px color-mix(in oklab, var(--blue-300) 60%, transparent);
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{margin:0; background:var(--bg); color:var(--fg); font:var(--fs-body)/1.55 system-ui, -apple-system, 'Inter','PingFang TC','Noto Sans TC',sans-serif;}
    .wrap{max-width:760px; margin:auto; padding:12px;}
    .card{background:var(--card); border-radius:20px; box-shadow:var(--shadow); overflow:hidden; position:relative;}

    /* HERO */
    .hero-wrap{position:relative;}
    .hero{width:100%; height:220px; object-fit:cover; display:none;}
    @media (max-width:520px){ .hero{height:180px;} }

    /* Lang pill */
    .lang-pill{
      position:absolute; right:12px; top:12px; display:flex; gap:6px; padding:6px;
      border-radius:999px; background:rgba(15,23,42,.45); backdrop-filter:blur(6px);
    }
    .lang-pill button{
      border:0; background:transparent; padding:6px 12px; border-radius:999px; font-weight:700;
      color:#fff; min-width:42px; font-size:12px; cursor:pointer;
    }
    .lang-pill button.active{background:#0B1020; color:#fff;}

    /* Logo badge */
    .logo-badge{
      position:absolute; left:50%; bottom:-22px; transform:translateX(-50%);
      width:64px; height:64px; border-radius:14px; background:#fff; padding:8px;
      box-shadow:0 10px 30px rgba(15,23,42,.18), 0 2px 6px rgba(15,23,42,.1);
      display:none;
    }
    .logo-badge img{width:100%; height:100%; object-fit:contain;}
    @media (max-width:520px){ .logo-badge{width:56px; height:56px; bottom:-20px;} }

    /* Content */
    .content{padding:26px 16px 14px; margin-top:14px;}
    .title{margin:0 0 6px 0; font-weight:800; line-height:1.2; font-size:var(--fs-title-max);}
    .title.fit{white-space:normal;}
    .sub{color:var(--muted); margin:0 0 10px 0;}

    /* Chips */
    #chips{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px; margin:10px 0 12px; }
    @media (min-width:540px){ #chips{ grid-template-columns:repeat(3, minmax(0,1fr)); } }

    .chip{
      border-radius:999px; padding:10px 14px; background:var(--chip-bg); color:var(--chip-fg);
      display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none;
      border:1px solid var(--blue-200); transition:all .15s ease; box-shadow:var(--shadow-soft);
      min-height:48px;
    }
    .chip:hover{transform:translateY(-1px); background:color-mix(in oklab, var(--blue-100) 60%, white);}
    .chip.on{ background:var(--chip-bg-on); color:var(--chip-fg-on); border-color:transparent; }
    .chip:focus-visible{ outline:none; box-shadow:var(--ring); }

    .chip-text{
      font-size:var(--fs-chip); font-weight:600; text-align:center; line-height:1.25;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
      max-width:95%;
    }

    /* Actions */
    .actions{display:flex; gap:10px; margin:8px 0 8px;}
    .btn{
      flex:1; height:46px; border:0; border-radius:14px; font-weight:800; font-size:var(--fs-btn);
      display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--shadow-soft);
      transition:transform .08s ease, background-color .12s ease, box-shadow .12s ease;
    }

    /* ä¸»è¦ CTAï¼šå¯¦å¿ƒå“ç‰Œè‰²ï¼Œé™°å½±å¾ˆæ·¡ï¼ˆå“ç‰Œè‰²æ··é€æ˜ï¼‰ */
    .btn.primary{
      color:var(--on-blue);
      background:var(--blue-500);
      box-shadow:0 6px 16px color-mix(in oklab, var(--blue-500) 14%, transparent);
    }
    .btn.primary:hover{
      background:var(--blue-hover); /* æ¯” base æ›´äº® */
      box-shadow:0 6px 16px color-mix(in oklab, var(--blue-500) 18%, transparent);
    }
    .btn.primary:active{
      transform:translateY(1px);
      background:var(--blue-active); /* å›åˆ° baseï¼ˆä¸æ›´æ·±ï¼‰ */
      box-shadow:0 4px 10px color-mix(in oklab, var(--blue-500) 12%, transparent);
    }
    .btn.primary:focus-visible{ outline:none; box-shadow:var(--ring); }

    .btn.ghost{
      background:var(--blue-050); color:var(--blue-600); border:1px solid var(--blue-200);
    }
    .btn.ghost:hover{ background:var(--blue-100); }

    .btn.secondary{
      background:#0B1220; color:#fff; height:52px; border-radius:16px;
    }
    .btn:disabled{opacity:.7; cursor:not-allowed;}

    .spinner{
      width:18px; height:18px;
      border:2px solid color-mix(in oklab, var(--on-blue) 45%, transparent);
      border-top-color:var(--on-blue);
      border-radius:50%; margin-right:8px; display:none; animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn.loading .spinner{display:inline-block;}

    textarea{
      width:100%; margin:0; padding:12px 14px; min-height:120px;
      border:1px solid var(--blue-200); border-radius:14px; font-size:var(--fs-body); box-shadow:var(--shadow-soft);
    }
    .footer-actions{display:flex; justify-content:center; margin-top:12px;}
    .status{color:var(--muted); font-size:12px; text-align:center; padding:10px 0 4px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hero-wrap">
        <img id="hero" class="hero" alt="hero"/>
        <div id="langBar" class="lang-pill" aria-label="language switch"></div>
        <div id="logoBadge" class="logo-badge"><img id="logo" alt="logo"/></div>
      </div>

      <div class="content">
        <h1 id="title" class="title fit">ç‚ºã€Œ<span id="title-store-name">é–€å¸‚</span>ã€å¯«ä¸€å‰‡çŸ­è©•</h1>
        <p id="subtitle" class="sub">æŒ‘é¸ä»Šå¤©ä½ æœ€æœ‰æ„Ÿçš„å¹¾å€‹é‡é»ï¼Œé»ä¸€ä¸‹ä¸‹æ–¹æŒ‰éˆ•ï¼Œæˆ‘å€‘æœƒå¹«ä½ æ•´ç†æˆçŸ­è©•ã€‚</p>

        <div id="step1-generate">
          <div id="chips"></div>

          <div class="actions">
            <button id="gen" class="btn primary"></button>
            <button id="copy" class="btn ghost"><span id="btnCopy">ğŸ“‹ è¤‡è£½</span></button>
          </div>

          <textarea id="output" placeholder="é€™è£¡æœƒé¡¯ç¤ºæ•´ç†å¾Œçš„ä¸€æ®µçŸ­è©•â€¦"></textarea>

          <div class="footer-actions">
            <a id="openGoogle" class="btn secondary" target="_blank" rel="noopener noreferrer">ğŸ” <span id="btnOpen">é–‹å•Ÿ Google è©•è«–</span></a>
          </div>
        </div>
        
        <div id="step2-reward" style="display: none;">
          
          <h3 id="step2-title" style="margin: 0 0 12px; text-align: center; font-weight: 700;">æ„Ÿè¬æ‚¨çš„å›é¥‹ï¼</h3>
          
          <div id="reviewTextDisplay" style="background:var(--blue-050); border:1px solid var(--blue-200); border-radius:14px; padding:12px 14px; min-height:100px; font-size:var(--fs-body); line-height:1.5; margin-bottom:12px; box-shadow:var(--shadow-soft); white-space: pre-wrap; word-break: break-word;">
            </div>

          <div class="actions">
            <button id="primaryStep2Btn" class="btn primary" style="flex: 1;">
              <span id="btnCopyAndOpen">ğŸ“‹ è¤‡è£½è©•è«–ä¸¦é–‹å•Ÿ Google</span>
            </button>
          </div>
          <div id="rewardNotice" style="margin-top:24px; padding:14px; background:var(--bg); border-radius:var(--radius-md); text-align:center;">
            <div style="font-size:16px; font-weight:700; margin-bottom:4px;">ğŸ æ‚¨çš„å°ˆå±¬çå‹µ</div>
            <div id="rewardText" style="font-size:14px; color:var(--muted); line-height: 1.4;">
              æ„Ÿè¬æ‚¨æä¾›å¯¶è²´å›é¥‹ã€‚<br/>
              **è«‹å‡ºç¤ºæ­¤ç•«é¢** å³å¯å‘åº—å“¡å…Œæ›ï¼š<br/>
              <strong style="color:var(--fg); font-size: 16px;">ã€Œå…è²»é£²æ–™ä¸€æ¯ã€</strong>
            </div>
          </div>
        </div>
        
        <div id="status" class="status" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <script>
    /* ------------------- è‰²å½©å·¥å…·ï¼ˆ...ï¼‰ ------------------- */
    function hexToRgb(hex){ hex = hex.replace('#',''); if(hex.length===3){ hex = hex.split('').map(c=>c+c).join(''); }
      const num = parseInt(hex,16); return { r:(num>>16)&255, g:(num>>8)&255, b:num&255 }; }
    function rgbToHex(r,g,b){ const to=h=>('0'+h.toString(16)).slice(-2); return '#'+to(r)+to(g)+to(b); }
    function rgbToHsl(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h,s,l=(max+min)/2;
      if(max===min){ h=s=0; } else{
        const d=max-min;
        s=l>0.5 ? d/(2-max-min) : d/(max+min);
        switch(max){
          case r: h=(g-b)/d+(g<b?6:0); break;
          case g: h=(b-r)/d+2; break;
          case b: h=(r-g)/d+4; break;
        }
        h/=6;
      }
      return { h, s, l };
    }
    function hslToRgb(h,s,l){
      let r, g, b;
      if(s===0){ r=g=b=l; }
      else{
        const hue2rgb=(p,q,t)=>{ if(t<0) t+=1; if(t>1) t-=1;
          if(t<1/6) return p+(q-p)*6*t; if(t<1/2) return q;
          if(t<2/3) return p+(q-p)*(2/3 - t)*6; return p; };
        const q=l<0.5 ? l*(1+s) : l+s-l*s;
        const p=2*l-q;
        r=hue2rgb(p,q,h+1/3); g=hue2rgb(p,q,h); b=hue2rgb(p,q,h-1/3);
      }
      return { r:Math.round(r*255), g:Math.round(g*255), b:Math.round(b*255) };
    }
    function normHex(h){
      if(!h) return '';
      let s=String(h).trim();
      if(!s.startsWith('#')) s='#'+s;
      if(/^#([0-9a-fA-F]{3})$/.test(s)){
        const [,r,g,b]=s.match(/^#(.)(.)(.)$/);
        s = '#'+r+r+g+g+b+b;
      }
      return /^#([0-9a-fA-F]{6})$/.test(s)? s.toUpperCase() : '';
    }
    function lighten(hex, deltaL){
      const {r,g,b}=hexToRgb(hex); const hsl=rgbToHsl(r,g,b);
      hsl.l = Math.max(0, Math.min(1, hsl.l + Math.abs(deltaL)));
      hsl.s = Math.max(0, Math.min(0.92, hsl.s*1.00));
      const rgb=hslToRgb(hsl.h,hsl.s,hsl.l);
      return rgbToHex(rgb.r,rgb.g,rgb.b);
    }
    function autoOnColor(bgHex){
      const {r,g,b}=hexToRgb(bgHex);
      const L = 0.2126*(r/255) + 0.7152*(g/255) + 0.0722*(b/255);
      return (L < 0.56) ? '#FFFFFF' : '#0B1220';
    }
    function applyBlueScale(baseHex, onHex){
      const base = normHex(baseHex) || '#0A84FF';
      const on   = normHex(onHex)   || autoOnColor(base);
      const root = document.documentElement;
      const vars = {
        '--blue-600': base,
        '--blue-500': base,
        '--blue-450': lighten(base, 0.04),
        '--blue-400': lighten(base, 0.10),
        '--blue-300': lighten(base, 0.20),
        '--blue-200': lighten(base, 0.30),
        '--blue-100': lighten(base, 0.38),
        '--blue-050': lighten(base, 0.45),
        '--blue-hover': lighten(base, 0.06),
        '--blue-active': base,
        '--on-blue': on,
      };
      Object.entries(vars).forEach(([k,v])=> root.style.setProperty(k, v));
      root.style.setProperty('--chip-bg', 'var(--blue-100)');
      root.style.setProperty('--chip-bg-on', 'var(--blue-450)');
      root.style.setProperty('--chip-fg-on', 'var(--on-blue)');
    }

    /* ------------------- helpers ------------------- */
    function getStoreFromURL(){
      const url = new URL(location.href);
      const byQuery = (url.searchParams.get('store') || url.searchParams.get('storeid') || '').trim();
      if (byQuery) return byQuery;
      const parts = url.pathname.replace(/^\/+/, '').split('/');
      const first = (parts[0] || '').trim().toLowerCase();
      if (!first || first === 'index.html' || first === 'favicon.ico' || first === 'api') return '';
      if (first === 's' && parts[1]) return (parts[1] || '').trim();
      return parts[0] || '';
    }
    const uniq = a => Array.from(new Set((a||[]).map(s => String(s||'').trim()).filter(Boolean)));
    const pick = (obj, ...keys) => { for (const k of keys){ const v = obj && obj[k]; if (v!==undefined && v!==null && String(v).trim()!=='') return v; } return ''; };
    const withBuster = u => (!u ? '' : (u + (u.includes('?') ? '&' : '?') + 'v=' + Date.now()));

    function setImgEl(imgEl, url, fallback, wrapper){
      const show = ok => (wrapper||imgEl).style.display = ok ? ((wrapper||imgEl).classList.contains('hero')?'block':'flex') : 'none';
      const src = url || fallback;
      if (!src) return show(false);
      imgEl.onload  = () => show(true);
      imgEl.onerror = () => show(false);
      imgEl.src = withBuster(src);
    }

    /* -------- store name parsing & localization -------- */
    function parseStoreNameMulti(s){
      const out = { zh:'', en:'', ko:'', ja:'', fr:'', es:'', _raw:(s||'').trim() };
      if (!s) return out;
      const str = String(s).trim();
      if (/[a-z]{2}\s*=/.test(str)){
        str.split(',').forEach(pair=>{
          const [kRaw,vRaw] = pair.split('=');
          if (!kRaw || !vRaw) return;
          const k = kRaw.trim().toLowerCase();
          const v = vRaw.trim();
          if (out.hasOwnProperty(k)) out[k] = v;
        });
        return out;
      }
      const parts = str.split(',').map(x=>x.trim()).filter(Boolean);
      const isLatin = t => /[A-Za-z]/.test(t);
      const isKorean = t => /[ê°€-í£]/.test(t);
      const isJapanese = t => /[\u3040-\u30ff\u31f0-\u31ff\uFF66-\uFF9D]/.test(t);
      parts.forEach(p=>{
        if (!out.en && isLatin(p)) { out.en = p; return; }
        if (!out.ko && isKorean(p)) { out.ko = p; return; }
        if (!out.ja && isJapanese(p)) { out.ja = p; return; }
        if (!out.zh) { out.zh = p; return; }
      });
      return out;
    }
    function storeNameForLang(nameMap, lang){
      if (!nameMap) return '';
      const order = {
        zh:['zh','en','ko','ja','fr','es'],
        en:['en','zh','ko','ja','fr','es'],
        ko:['ko','zh','en','ja','fr','es'],
        ja:['ja','zh','en','ko','fr','es'],
        fr:['fr','en','zh','ko','ja','es'],
        es:['es','en','zh','ko','ja','fr'],
      }[lang] || ['en','zh','ko','ja','fr','es'];
      for (const k of order){ const v=(nameMap[k]||'').trim(); if (v) return v; }
      return (nameMap._raw||'').trim();
    }

    /* ---------- i18n config (âœ… V3/V5) ---------- */
    const LANGS = {
      en: { label:'EN', chips:['top3En','featuresEn','ambianceEn','newItemsEn','top3','features','ambiance','newItems'],
        ui:{title:'Write a short review for â€œ{name}â€', sub:'Pick what stood out today. Weâ€™ll generate a review & prepare your reward.',
            gen:'âœï¸ Generate & Claim Reward', copy:'ğŸ“‹ Copy', open:'Open Google Reviews', placeholder:'Your summarized review will appear hereâ€¦'} },
      zh: { label:'ä¸­', chips:['top3Cn','featuresCn','ambianceCn','newItemsCn','top3','features','ambiance','newItems'],
        ui:{title:'ç‚ºã€Œ{name}ã€å¯«ä¸€å‰‡çŸ­è©•', sub:'æŒ‘é¸ä»Šå¤©ä½ æœ€æœ‰æ„Ÿçš„å¹¾å€‹é‡é»ï¼Œæˆ‘å€‘æœƒå¹«ä½ æ•´ç†çŸ­è©•ä¸¦æº–å‚™çå‹µã€‚',
            gen:'âœï¸ ç”¢ç”Ÿè©•è«–ä¸¦é ˜å–çå‹µ', copy:'ğŸ“‹ è¤‡è£½', open:'é–‹å•Ÿ Google è©•è«–', placeholder:'é€™è£¡æœƒé¡¯ç¤ºæ•´ç†å¾Œçš„ä¸€æ®µçŸ­è©•â€¦'} },
      ko: { label:'í•œêµ­ì–´', chips:['top3Ko','featuresKo','ambianceKo','newItemsKo','top3','features','ambiance','newItems'],
        ui:{title:'â€œ{name}â€ ë¦¬ë·° í•œ ì¤„', sub:'ì˜¤ëŠ˜ ì¸ìƒ ê¹Šì—ˆë˜ í¬ì¸íŠ¸ë¥¼ ê³ ë¥´ê³  â€˜ì‘ì„±â€™ì„ ëˆŒëŸ¬ì£¼ì‹œë©´, ë¦¬ë·°ì™€ ë¦¬ì›Œë“œë¥¼ ì¤€ë¹„í•´ ë“œë¦½ë‹ˆë‹¤.',
            gen:'âœï¸ ì‘ì„± ë° ë¦¬ì›Œë“œ ë°›ê¸°', copy:'ğŸ“‹ ë³µì‚¬', open:'Google ë¦¬ë·° ì—´ê¸°', placeholder:'ìš”ì•½ëœ ë¦¬ë·°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤â€¦'} },
      ja: { label:'æ—¥æœ¬èª', chips:['top3Ja','featuresJa','ambianceJa','newItemsJa','top3','features','ambiance','newItems'],
        ui:{title:'ã€Œ{name}ã€ã¸ä¸€è¨€ãƒ¬ãƒ“ãƒ¥ãƒ¼', sub:'ä»Šæ—¥å°è±¡ã«æ®‹ã£ãŸãƒã‚¤ãƒ³ãƒˆã‚’é¸ã³ã€ã€Œä½œæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ç‰¹å…¸ã‚’ã”ç”¨æ„ã—ã¾ã™ã€‚',
            gen:'âœï¸ ä½œæˆã—ã¦ç‰¹å…¸ã‚’å—ã‘å–ã‚‹', copy:'ğŸ“‹ ã‚³ãƒ”ãƒ¼', open:'Google å£ã‚³ãƒŸã‚’é–‹ã', placeholder:'è¦ç´„ã—ãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™â€¦'} },
      fr: { label:'FR', chips:['top3Fr','featuresFr','ambianceFr','newItemsFr','top3','features','ambiance','newItems'],
        ui:{title:'Ã‰crire un avis court pour Â« {name} Â»', sub:'Choisissez ce qui vous a marquÃ©, touchez Â« RÃ©diger Â» pour gÃ©nÃ©rer l\'avis et recevoir votre rÃ©compense.',
            gen:'âœï¸ RÃ©diger & Recevoir RÃ©compense', copy:'ğŸ“‹ Copier', open:'Ouvrir les avis Google', placeholder:'Votre avis synthÃ©tisÃ© sâ€™affichera iciâ€¦'} },
      es: { label:'ES', chips:['top3Es','featuresEs','ambianceEs','newItemsEs','top3','features','ambiance','newItems'],
        ui:{title:'Escribe una reseÃ±a corta para Â«{name}Â»', sub:'Elige lo que mÃ¡s te llamÃ³ la atenciÃ³n y pulsa Â«RedactarÂ» para generar tu reseÃ±a y reclamar tu recompensa.',
            gen:'âœï¸ Redactar y Reclamar Recompensa', copy:'ğŸ“‹ Copiar', open:'Abrir reseÃ±as de Google', placeholder:'AquÃ­ aparecerÃ¡ tu reseÃ±a resumidaâ€¦'} },
    };

    /* ---------- DOM (âœ… V5 MODIFIED) ---------- */
    const $chips = document.getElementById('chips');
    const $gen = document.getElementById('gen');
    const $copy = document.getElementById('copy');
    const $output = document.getElementById('output');
    const $status = document.getElementById('status');
    const $openGoogle = document.getElementById('openGoogle');
    const $logo = document.getElementById('logo');
    const $logoBadge = document.getElementById('logoBadge');
    const $hero = document.getElementById('hero');
    const $langBar = document.getElementById('langBar');
    const $title = document.getElementById('title');
    const $subtitle = document.getElementById('subtitle');
    const $btnCopy = document.getElementById('btnCopy');
    const $btnOpen = document.getElementById('btnOpen');
    const $titleStoreName = document.getElementById('title-store-name');

    // âœ… V5 DOM Elements
    const $step1 = document.getElementById('step1-generate');
    const $step2 = document.getElementById('step2-reward');
    const $reviewTextDisplay = document.getElementById('reviewTextDisplay');
    const $primaryStep2Btn = document.getElementById('primaryStep2Btn'); // âœ… V5 New
    
    // âœ… V5 i18n DOM Elements
    const $step2Title = document.getElementById('step2-title');
    // $step2Sub is removed
    const $btnCopyAndOpen = document.getElementById('btnCopyAndOpen'); // âœ… V5 New
    const $rewardText = document.getElementById('rewardText');


    let selected = new Set();
    let currentStore = getStoreFromURL() || 'leegarnei';
    let currentLang = 'zh';
    let storeMeta = null;
    let availableLangs = [];
    let storeNames = null;

    const genButtonTemplate = () => `<span class="spinner"></span><span id="btnGen">${LANGS[currentLang].ui.gen}</span>`;

    function applyBasicLinks(nameText){
      $titleStoreName.textContent = nameText || currentStore || 'Store';
      const q = encodeURIComponent(currentStore || 'Big Way');
      $openGoogle.href = 'https://www.google.com/search?q=' + q + '+google+reviews';
    }

    function langHasContent(langKey, data){
      const cfg = LANGS[langKey]; if(!cfg) return false;
      return cfg.chips.some(k => (data && String(data[k]||'').trim()));
    }

    function buildLangBar(){
      $langBar.innerHTML = '';
      availableLangs.forEach(k=>{
        const btn = document.createElement('button');
        btn.textContent = LANGS[k].label;
        btn.className = (k===currentLang)?'active':'';
        btn.onclick = ()=>{ currentLang = k; renderUI(); buildLangBar(); buildChipsFromMeta(); };
        $langBar.appendChild(btn);
      });
    }

    function fitTitle(){
      const max = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fs-title-max')) || 28;
      const min = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fs-title-min')) || 18;
      let size = max;
      $title.style.fontSize = size + 'px';
      const w = $title.clientWidth;
      while ($title.scrollWidth > w && size > min) { size -= 1; $title.style.fontSize = size + 'px'; }
    }

    /* âœ… V5 MODIFIED renderUI function */
    function renderUI(){
      const ui = LANGS[currentLang].ui;
      const localizedName = storeNameForLang(storeNames, currentLang) || pick(storeMeta,'name') || currentStore || 'Store';
      
      // Step 1
      $title.innerHTML = ui.title.replace('{name}', `<span id="title-store-name">${localizedName}</span>`);
      $subtitle.textContent = ui.sub;
      $btnCopy.textContent = ui.copy;
      $btnOpen.textContent = ui.open;
      $output.placeholder = ui.placeholder;
      $gen.innerHTML = genButtonTemplate();
      
      // Step 2
      $step2Title.textContent = { en:'Thank You!', zh:'æ„Ÿè¬æ‚¨çš„å›é¥‹ï¼', ko:'ê°ì‚¬í•©ë‹ˆë‹¤!', ja:'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼', fr:'Merci!', es:'Â¡Gracias!' }[currentLang] || 'Thank You!';
      // $step2Sub removed
      $btnCopyAndOpen.textContent = { 
        en:'ğŸ“‹ Copy & Open Google', 
        zh:'ğŸ“‹ è¤‡è£½è©•è«–ä¸¦é–‹å•Ÿ Google', 
        ko:'ğŸ“‹ ë³µì‚¬ ë° Google ì—´ê¸°', 
        ja:'ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¦ Google ã‚’é–‹ã', 
        fr:'ğŸ“‹ Copier & Ouvrir Google', 
        es:'ğŸ“‹ Copiar y Abrir Google' 
      }[currentLang] || 'ğŸ“‹ Copy & Open Google';
      
      $rewardText.innerHTML = {
        en: `Thank you for your feedback.<br/>**Show this screen** to redeem:<br/><strong style="color:var(--fg); font-size: 16px;">"One Free Drink"</strong>`,
        zh: `æ„Ÿè¬æ‚¨æä¾›å¯¶è²´å›é¥‹ã€‚<br/>**è«‹å‡ºç¤ºæ­¤ç•«é¢** å³å¯å‘åº—å“¡å…Œæ›ï¼š<br/><strong style="color:var(--fg); font-size: 16px;">ã€Œå…è²»é£²æ–™ä¸€æ¯ã€</strong>`,
        ko: `ì†Œì¤‘í•œ í”¼ë“œë°± ê°ì‚¬í•©ë‹ˆë‹¤.<br/>**ì´ í™”ë©´ì„ ë³´ì—¬ì£¼ì‹œë©´** êµí™˜ ê°€ëŠ¥í•©ë‹ˆë‹¤:<br/><strong style="color:var(--fg); font-size: 16px;">"ë¬´ë£Œ ìŒë£Œ 1ì”"</strong>`,
        ja: `è²´é‡ãªã”æ„è¦‹ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<br/>**ã“ã®ç”»é¢ã‚’ã”æç¤ºãã ã•ã„**:<br/><strong style="color:var(--fg); font-size: 16px;">ã€Œç„¡æ–™ãƒ‰ãƒªãƒ³ã‚¯1æ¯ã€</strong>`,
        fr: `Merci pour votre avis.<br/>**Montrez cet Ã©cran** pour Ã©changer:<br/><strong style="color:var(--fg); font-size: 16px;">"Une Boisson Gratuite"</strong>`,
        es: `Gracias por tu opiniÃ³n.<br/>**Muestra esta pantalla** para canjear:<br/><strong style="color:var(--fg); font-size: 16px;">"Una Bebida Gratis"</strong>`
      }[currentLang] || `Show this screen...`;

      requestAnimationFrame(fitTitle);
    }

    function buildChipsFromMeta(){
      const cfg = LANGS[currentLang];
      const data = storeMeta || {};
      let tags = [];
      cfg.chips.forEach(k=>{ const raw = pick(data, k); if (raw) tags = tags.concat(String(raw).split(',')); });
      tags = uniq(tags).slice(0,18);
      if (tags.length===0){
        tags = ['boba','rice','dumpling','Nice service','clean environment','Couple date','family reunion','Fried noodles'];
      }
      selected.clear();
      $chips.innerHTML = '';
      tags.forEach(tag=>{
        const el = document.createElement('div'); el.className='chip';
        el.innerHTML = `<span class="chip-text">${tag.trim()}</span>`;
        el.onclick=()=>{ if(selected.has(tag)) selected.delete(tag); else selected.add(tag); el.classList.toggle('on'); };
        $chips.appendChild(el);
      });
    }

    function applyThemeFromMeta(data){
      const apiBlue = (pick(data,'themeBlue') || '').trim();
      const apiOn   = (pick(data,'themeOnBlue') || '').trim();
      const cssBase = getComputedStyle(document.documentElement).getPropertyValue('--blue').trim() || '#0A84FF';
      applyBlueScale(apiBlue || cssBase, apiOn);
    }

    async function loadStoreMeta(){
      try{
        const res = await fetch('/api/store?storeid=' + encodeURIComponent(currentStore));
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || ('HTTP '+res.status));
        storeMeta = data;
        applyThemeFromMeta(data);
        storeNames = parseStoreNameMulti(pick(data,'name','storeName','title') || currentStore);
        applyBasicLinks(storeNameForLang(storeNames, currentLang));
        const order = ['zh','en','ko','ja','fr','es'];
        availableLangs = order.filter(k => langHasContent(k, data));
        if (availableLangs.length===0) availableLangs = ['zh','en'];
        if (!availableLangs.includes(currentLang)) currentLang = availableLangs[0];
        const heroUrl = pick(data,'heroUrl','cover','banner','placePhotoUrl','photoUrl');
        const logoUrl = pick(data,'logoUrl','logo','image','icon');
        setImgEl($hero, heroUrl, pick(data,'placePhotoUrl','photoUrl'));
        setImgEl($logo, logoUrl, pick(data,'placePhotoUrl','photoUrl'), $logoBadge);
        if (data.placeId) $openGoogle.href = 'https://search.google.com/local/writereview?placeid=' + encodeURIComponent(data.placeId);
        renderUI(); buildLangBar(); buildChipsFromMeta();
      }catch(e){
        console.error('loadStoreMeta error:', e);
        const cssBase = getComputedStyle(document.documentElement).getPropertyValue('--blue').trim() || '#0A84FF';
        applyBlueScale(cssBase, '');
        storeNames = parseStoreNameMulti(currentStore);
        applyBasicLinks(storeNameForLang(storeNames, currentLang));
        renderUI(); buildLangBar(); buildChipsFromMeta();
      }
    }

    (function initThemeFirstPaint(){
      const cssBase = getComputedStyle(document.documentElement).getPropertyValue('--blue').trim() || '#0A84FF';
      applyBlueScale(cssBase, '');
    })();

    applyBasicLinks('Store');
    renderUI();
    loadStoreMeta();
    addEventListener('resize', ()=> requestAnimationFrame(fitTitle));

    /* âœ… V5 NEW HELPER FUNCTION */
    async function copyAndOpen(textToCopy, urlToOpen) {
      // 1. è¤‡è£½æ–‡å­—
      try {
        await navigator.clipboard.writeText(textToCopy);
        $status.textContent = { en:'ğŸ“‹ Copied!', zh:'ğŸ“‹ å·²è¤‡è£½ï¼', ko:'ğŸ“‹ ë³µì‚¬ ì™„ë£Œ!', ja:'ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', fr:'ğŸ“‹ CopiÃ© !', es:'ğŸ“‹ Â¡Copiado!' }[currentLang] || 'Copied!';
      } catch (err) {
        $status.textContent = { en:'Please copy manually', zh:'è«‹æ‰‹å‹•è¤‡è£½', ko:'ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ ì£¼ì„¸ìš”', ja:'æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', fr:'Copiez manuellement', es:'Copia manually' }[currentLang] || 'Please copy manually';
        // å°±ç®—è¤‡è£½å¤±æ•—ï¼Œæˆ‘å€‘é‚„æ˜¯è¦ç¹¼çºŒ
      }
      
      // 2. é–‹å•Ÿ Google (åœ¨è¤‡è£½ä¹‹å¾Œ)
      try {
        window.open(urlToOpen, '_blank');
      } catch (e) {
        // å¦‚æœè¢«é˜»æ“‹ï¼Œè‡³å°‘æ–‡å­—å·²ç¶“è¤‡è£½äº†
        $status.textContent = { en:'Copied! Please open Google manually.', zh:'å·²è¤‡è£½ï¼è«‹æ‰‹å‹•é–‹å•Ÿ Googleã€‚', ko:'ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! Googleì„ ìˆ˜ë™ìœ¼ë¡œ ì—´ì–´ì£¼ì„¸ìš”.', ja:'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼Google ã‚’æ‰‹å‹•ã§é–‹ã„ã¦ãã ã•ã„ã€‚', fr:'CopiÃ© ! Veuillez ouvrir Google manuellement.', es:'Â¡Copiado! Abre Google manualmente.' }[currentLang] || 'Copied! Please open Google manually.';
      }
    }

    /* âœ… V5 MODIFIED actions */
    async function generate(){
      const storeid = (currentStore || '').trim();
      if (!storeid){ $status.textContent = (currentLang==='zh')?'è«‹å…ˆæŒ‡å®š StoreIDã€‚':'Please set StoreID first.'; return; }
      const selectedTags = Array.from(selected);
      const body = { storeid, selectedTags, variant:1, minChars:90, maxChars:160, lang: currentLang };

      $gen.classList.add('loading'); $gen.disabled=true; $copy.disabled=true;
      const loadingText = { en:'Composingâ€¦', zh:'æ’°å¯«ä¸­â€¦', ko:'ì‘ì„± ì¤‘â€¦', ja:'ä½œæˆä¸­â€¦', fr:'RÃ©dactionâ€¦', es:'Redactandoâ€¦' }[currentLang] || 'Composingâ€¦';
      $gen.innerHTML = `<span class="spinner"></span>${loadingText}`;
      $status.textContent='';

      try{
        const res = await fetch('/api/generate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || ('HTTP '+res.status));

        // ğŸ›‘ğŸ›‘ğŸ›‘ V5 Logic Starts Here ğŸ›‘ğŸ›‘ğŸ›‘

        const reviewText = data.reviewText || '';
        const placeId = data?.store?.placeId || storeMeta?.placeId || '';
        const googleReviewUrl = placeId
          ? 'https://search.google.com/local/writereview?placeid=' + encodeURIComponent(placeId)
          : $openGoogle.href; // Fallback

        // 1. (åˆè¦) ç§»é™¤è‡ªå‹•é–‹å•Ÿ
        // window.open(...) removed

        // 2. å¡«å…… Step 2 (çå‹µ/å¼•å°é ) çš„å…§å®¹
        $reviewTextDisplay.textContent = reviewText;
        $primaryStep2Btn.onclick = () => copyAndOpen(reviewText, googleReviewUrl); // âœ… ç¶å®š V5 æ–°åŠŸèƒ½

        // 3. (åˆè¦) åˆ‡æ›è¦–åœ–ï¼šéš±è— Step 1ï¼Œé¡¯ç¤º Step 2 (çå‹µé é¢)
        $step1.style.display = 'none';
        $step2.style.display = 'block';

        // 4. æ›´æ–°ç‹€æ…‹åˆ—æ–‡å­—
        const okText = { en:'âœ… Review generated!', zh:'âœ… è©•è«–å·²ç”¢ç”Ÿï¼', ko:'âœ… ë¦¬ë·° ìƒì„± ì™„ë£Œ!', ja:'âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒä½œæˆã•ã‚Œã¾ã—ãŸï¼', fr:'âœ… Avis gÃ©nÃ©rÃ© !', es:'âœ… Â¡ReseÃ±a generada!' }[currentLang] || 'âœ… Done';
        $status.textContent = okText + ' (' + (data.latencyMs || '-') + ' ms)';

        // ğŸ›‘ğŸ›‘ğŸ›‘ V5 Logic Ends Here ğŸ›‘ğŸ›‘ğŸ›‘

      }catch(err){
        const errPrefix = { en:'âŒ Error: ', zh:'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š', ko:'âŒ ì˜¤ë¥˜: ', ja:'âŒ ã‚¨ãƒ©ãƒ¼: ', fr:'âŒ Erreur : ', es:'âŒ Error: ' }[currentLang] || 'âŒ Error: ';
        $output.value=''; $status.textContent = errPrefix + err.message;
      }finally{
        // âœ… MODIFIED: åªåœ¨ç™¼ç”ŸéŒ¯èª¤ (é‚„åœåœ¨ Step 1) æ™‚æ‰é‡è¨­æŒ‰éˆ•
        if ($step2.style.display === 'none') {
          $gen.classList.remove('loading'); $gen.disabled=false; $copy.disabled=false;
          $gen.innerHTML = genButtonTemplate();
        }
      }
    }
    
    /* âœ… V5 MODIFIED copyText function (åƒæ•¸åŒ–) */
    async function copyText(textToCopy){ // å¢åŠ  textToCopy åƒæ•¸
      const t = (textToCopy || $output.value || '').trim(); // å„ªå…ˆä½¿ç”¨å‚³å…¥çš„åƒæ•¸
      const msgOK = { en:'ğŸ“‹ Copied to clipboard', zh:'ğŸ“‹ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', ko:'ğŸ“‹ ë³µì‚¬ ì™„ë£Œ', ja:'ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼', fr:'ğŸ“‹ CopiÃ© dans le presse-papiers', es:'ğŸ“‹ Copiado al portapapeles' }[currentLang];
      const msgNG = { en:'Please copy manually', zh:'è«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½', ko:'ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ ì£¼ì„¸ìš”', ja:'æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', fr:'Copiez manuellement, svp', es:'Copia manually, por favor' }[currentLang];
      if(!t){ $status.textContent = { en:'Nothing to copy', zh:'å°šç„¡å…§å®¹å¯è¤‡è£½', ko:'ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', ja:'ã‚³ãƒ”ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', fr:'Rien Ã  copier', es:'Nada para copiar' }[currentLang]; return; }
      try{ await navigator.clipboard.writeText(t); $status.textContent = msgOK; }
      catch{ $status.textContent = msgNG; }
    }

    document.getElementById('gen').addEventListener('click', generate);
    document.getElementById('copy').addEventListener('click', () => copyText()); // èˆŠæŒ‰éˆ•çš„ç¶å®š
  </script>
</body>
</html>
