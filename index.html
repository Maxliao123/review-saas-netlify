<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Google Review Â· AI ä¸€å‰‡çŸ­è©•</title>
  <style>
    :root { --bg:#f5f4f2; --fg:#1f2937; --card:#ffffff; --muted:#6b7280; --pri:#0ea5e9; --chip:#e5f2fb; --chip-on:#0ea5e9; --chip-on-fg:#fff; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font:16px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"PingFang TC","Noto Sans TC","Microsoft JhengHei",sans-serif; }
    .wrap { max-width:980px; margin:56px auto; padding:0 20px; }
    .card { background:var(--card); border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.06); padding:28px; }
    h1 { margin:0 0 6px; font-size:28px; }
    .sub { color:var(--muted); margin-bottom:18px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .field { display:flex; gap:10px; align-items:center; }
    .field input { height:36px; padding:0 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none; }
    .field input:focus { border-color:var(--pri); box-shadow:0 0 0 3px rgba(14,165,233,.15); }
    .chip { padding:8px 12px; background:var(--chip); border-radius:999px; cursor:pointer; user-select:none; transition:.15s; }
    .chip.on { background:var(--chip-on); color:var(--chip-on-fg); }
    .btn { height:40px; padding:0 14px; border:0; border-radius:12px; cursor:pointer; background:var(--pri); color:#fff; font-weight:600; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .btn.secondary { background:#111827; }
    .btn.ghost { background:#eef2f7; color:#111827; }
    /* è®“ a æŒ‰éˆ•åœ¨åœç”¨æ™‚ä¸å¯é»æ“Š */
    .btn[aria-disabled="true"] { opacity:.6; pointer-events:none; }
    textarea { width:100%; min-height:140px; resize:vertical; padding:12px; border:1px solid #e5e7eb; border-radius:12px; outline:none; }
    textarea:focus { border-color:var(--pri); box-shadow:0 0 0 3px rgba(14,165,233,.15); }
    .muted { color:var(--muted); font-size:13px; }
    .spacer { height:10px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>ç‚ºã€Œ<span id="storeName">æå®¶</span>ã€å¯«ä¸€å‰‡çŸ­è©•</h1>
      <div class="sub">å‹¾é¸å¹¾å€‹é‡é»ï¼Œå†æŒ‰ã€Œç”Ÿæˆï¼ˆAIï¼‰ã€å°±æœƒå¹«ä½ å¯«å‡ºè‡ªç„¶çš„ä¸€æ®µè©•è«–ã€‚</div>

      <!-- storeid èˆ‡è‡ªè¨‚æ¨™ç±¤ -->
      <div class="row" style="margin-bottom:10px;">
        <div class="field">
          <label for="storeid" class="muted">StoreIDï¼š</label>
          <input id="storeid" value="leegarnei" />
        </div>
        <div class="field">
          <label for="addTag" class="muted">æ–°å¢æ¨™ç±¤ï¼š</label>
          <input id="addTag" placeholder="è¼¸å…¥å¾ŒæŒ‰ Enter" />
        </div>
      </div>

      <!-- æ¨™ç±¤ Chips -->
      <div id="chips" class="row" style="margin-bottom:16px;"></div>

      <!-- æ“ä½œæŒ‰éˆ•ï¼ˆä¿ç•™ ç”Ÿæˆ / è¤‡è£½ï¼‰ -->
      <div class="actions" style="margin-bottom:12px;">
        <button id="gen" class="btn">âœ¨ ç”Ÿæˆï¼ˆAIï¼‰</button>
        <button id="copy" class="btn ghost">ğŸ“‹ è¤‡è£½</button>
      </div>

      <!-- çµæœ -->
      <textarea id="output" placeholder="é€™è£¡æœƒé¡¯ç¤º AI ç”Ÿæˆçš„çŸ­è©•â€¦" ></textarea>

      <!-- âœ… é–‹å•Ÿ Google è©•è«–ï¼šç§»åˆ°è¼¸å‡ºæ¡†ä¸‹æ–¹ï¼›å°šæœªæœ‰ place_id å‰ç‚ºåœç”¨ç‹€æ…‹ -->
      <div class="actions" style="margin-top:10px;">
        <a id="openGoogle" class="btn secondary" target="_blank" rel="noopener noreferrer"
           href="javascript:void(0)" aria-disabled="true">ğŸ” é–‹å•Ÿ Google è©•è«–</a>
      </div>

      <div class="muted" id="status" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // åˆå§‹å¯é¸æ¨™ç±¤ï¼ˆå…ˆå¯«æ­»ï¼›ä¹‹å¾Œå¯æ”¹æˆå¾å¾Œç«¯æˆ– Sheet è®€å–ï¼‰
    const seedTags = [
      'é»‘ç³–é¹¿ä¸¸é®®å¥¶','çš‡å®¶ä¹è™Ÿå¥¶èŒ¶','ç™½æ¡ƒçƒé¾','æœå‹™è¶…è¦ªåˆ‡','ç’°å¢ƒå¾ˆèˆ’æœ','é©åˆæ‹ç…§',
      'é©åˆæƒ…ä¾¶ç´„æœƒ','å®¶åº­èšé¤','æœ‹å‹å°é…Œ','é¹¹é…¥é›éºµ'
    ];

    const $chips = document.getElementById('chips');
    const $storeid = document.getElementById('storeid');
    const $addTag = document.getElementById('addTag');
    const $gen = document.getElementById('gen');
    const $copy = document.getElementById('copy');
    const $output = document.getElementById('output');
    const $status = document.getElementById('status');
    const $storeName = document.getElementById('storeName');
    const $openGoogle = document.getElementById('openGoogle');

    let selected = new Set();

    function renderChips(list){
      $chips.innerHTML = '';
      list.forEach(tag=>{
        const el = document.createElement('div');
        el.className = 'chip';
        el.textContent = tag;
        el.onclick = () => {
          if(selected.has(tag)) selected.delete(tag);
          else selected.add(tag);
          el.classList.toggle('on');
        };
        $chips.appendChild(el);
      });
    }

    // æ–°å¢è‡ªè¨‚æ¨™ç±¤ï¼ˆEnterï¼‰
    $addTag.addEventListener('keydown', e=>{
      if(e.key === 'Enter'){
        const v = $addTag.value.trim();
        if(!v) return;
        if(!seedTags.includes(v)){
          seedTags.unshift(v);
          renderChips(seedTags);
          // è‡ªå‹•é¸å–æ–°æ¨™ç±¤
          const chip = [...$chips.children].find(c=>c.textContent===v);
          if(chip){ chip.click(); }
        }
        $addTag.value = '';
      }
    });

    // è¨­å®šã€Œé–‹å•Ÿ Google è©•è«–ã€çš„é€£çµ
    // è‹¥æœ‰ place_id -> ç›´æ¥é–‹è©•è«–ç·¨è¼¯ï¼›å¦å‰‡å›é€€åˆ°æœå°‹çµæœä¸¦è¨­ç‚ºåœç”¨
    function setGoogleLink(store) {
      if (store?.placeId) {
        $openGoogle.href = `https://search.google.com/local/writereview?placeid=${encodeURIComponent(store.placeId)}`;
        $openGoogle.removeAttribute('aria-disabled');
      } else {
        const q = encodeURIComponent(store?.name || $storeid.value || 'Big Way');
        $openGoogle.href = `https://www.google.com/search?q=${q}+google+reviews`;
        $openGoogle.setAttribute('aria-disabled', 'true');
      }
    }

    // ä¾ storeid èª¿æ•´é¡¯ç¤ºåç¨± + é è¨­æœå°‹é€£çµï¼ˆæœªç”Ÿæˆå‰çš„ fallbackï¼‰
    $storeid.addEventListener('input', ()=>{
      const name = $storeid.value || 'é–€å¸‚';
      $storeName.textContent = name;

      const q = encodeURIComponent(name);
      $openGoogle.href = `https://www.google.com/search?q=${q}+google+reviews`;
      $openGoogle.setAttribute('aria-disabled', 'true');  // å°šæœªç”¢ç”Ÿã€ç„¡ place_id å‰å…ˆåœç”¨
    });
    $storeid.dispatchEvent(new Event('input')); // è§¸ç™¼ä¸€æ¬¡ä»¥åˆå§‹åŒ–

    renderChips(seedTags);

    async function generate(){
      const storeid = ($storeid.value || '').trim();
      if(!storeid){
        $status.textContent = 'è«‹å…ˆè¼¸å…¥ StoreIDã€‚';
        return;
      }
      const selectedTags = Array.from(selected);
      $gen.disabled = true; $copy.disabled = true;
      const prevTxt = $gen.textContent;
      $gen.textContent = 'ç”Ÿæˆä¸­â€¦';
      $status.textContent = '';

      try{
        const res = await fetch('/api/generate', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ storeid, selectedTags })
        });
        const data = await res.json();
        if(!res.ok){
          throw new Error(data?.error || ('HTTP '+res.status));
        }

        // é¡¯ç¤º AI æ–‡å­—
        $output.value = data.reviewText || JSON.stringify(data, null, 2);
        $status.textContent = `âœ… å®Œæˆï¼ˆå»¶é² ${data.latencyMs ?? '-'} msï¼‰`;

        // ç”¨å¾Œç«¯å›å‚³çš„æ­£å¼åç¨± / place_id æ›´æ–°æ¨™é¡Œèˆ‡æŒ‰éˆ•
        if (data.store?.name) $storeName.textContent = data.store.name;
        setGoogleLink(data.store); // â† é€™è£¡æ±ºå®šæ˜¯å¦èƒ½ä¸€éµç›´é”è©•è«–ç·¨è¼¯
      }catch(err){
        $output.value = '';
        $status.textContent = 'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message;
        setGoogleLink(null);
      }finally{
        $gen.disabled = false; $copy.disabled = false;
        $gen.textContent = prevTxt;
      }
    }

    async function copyText(){
      const t = $output.value.trim();
      if(!t){ $status.textContent = 'å°šç„¡å…§å®¹å¯è¤‡è£½'; return; }
      await navigator.clipboard.writeText(t);
      $status.textContent = 'ğŸ“‹ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿';
    }

    $gen.addEventListener('click', generate);
    $copy.addEventListener('click', copyText);
  </script>
</body>
</html>

