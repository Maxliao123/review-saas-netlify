<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Smart Google Review Â· AI ä¸€å‰‡çŸ­è©•</title>
  <style>
    :root{
      --bg:#f6f8fa; --card:#fff; --fg:#1f2937; --muted:#6b7280;
      --pri:#0ea5e9; --chip:#e5f2fb; --chip-on:#0ea5e9; --chip-on-fg:#fff;

      --fs-title: clamp(18px, 2.2vw + 12px, 26px);
      --fs-body:  clamp(13px, 1.2vw + 10px, 16px);
      --fs-chip:  clamp(12px, 1vw  + 9px, 14px);
      --fs-btn:   clamp(14px, 1.2vw + 11px, 16px);
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{margin:0; background:var(--bg); color:var(--fg); font:var(--fs-body)/1.5 'Inter','PingFang TC','Noto Sans TC',sans-serif;}

    .wrap{max-width:480px; margin:auto; padding:12px;}
    .card{background:var(--card); border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.06); overflow:hidden;}

    /* Heroï¼šè¡Œå‹• 120pxï¼Œæ¡Œé¢ 180px */
    .hero{width:100%; height:120px; object-fit:cover; display:none;}
    @media (min-width:768px){ .hero{height:180px;} }

    .title{display:flex; align-items:center; gap:8px; padding:12px 14px 6px;}
    .title h1{margin:0; font-size:var(--fs-title); line-height:1.25; font-weight:800; flex:1;}
    .logo{width:36px; height:36px; border-radius:8px; object-fit:cover; display:none;}
    .lang-select{
      height:32px; border:1px solid #e5e7eb; border-radius:8px; padding:0 8px; background:#fff; color:#111;
      font-size:13px;
    }

    .sub{color:var(--muted); padding:0 14px 10px;}

    /* â¬‡ åªçµ¦ Chips ç”¨ï¼šå›ºå®šä¸‰æ¬„ï¼Œç­‰å¯¬ä¸çˆ†ç‰ˆ */
    #chips{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:8px;
      padding:0 14px 6px;
    }
    .chip{
      width:100%;
      padding:9px 8px;
      border-radius:999px;
      text-align:center;
      background:var(--chip);
      color:var(--fg);
      cursor:pointer;
      font-size:var(--fs-chip);
      user-select:none;
      white-space:nowrap;
      transition:.15s;
    }
    .chip.on{background:var(--chip-on); color:var(--chip-on-fg);}

    .actions{display:flex; gap:8px; padding:10px 14px 8px;}
    .btn{
      flex:1; height:44px; border:0; border-radius:12px; font-weight:700;
      font-size:var(--fs-btn); display:flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .btn.primary{background:var(--pri); color:#fff;}
    .btn.secondary{background:#111827; color:#fff;}
    .btn:disabled{opacity:.7; cursor:not-allowed;}

    /* ç”Ÿæˆä¸­ Loading */
    .spinner{
      width:18px; height:18px; border:2px solid rgba(255,255,255,.45);
      border-top-color:#fff; border-radius:50%; margin-right:8px; display:none;
      animation:spin .9s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn.loading .spinner{display:inline-block;}

    textarea{
      width:calc(100% - 28px); margin:0 14px 10px; padding:10px; min-height:64px; resize:vertical;
      border:1px solid #e5e7eb; border-radius:10px; font-size:var(--fs-body);
    }

    .footer-actions{display:flex; justify-content:center; padding:0 14px 16px;}
    .status{color:var(--muted); font-size:12px; text-align:center; padding:0 14px 14px;}
    /* è‹¥æ²’å¸¶ store åƒæ•¸æ‰é¡¯ç¤ºèˆŠæ¬„ä½ï¼ˆç›¸å®¹ä¿ç•™ï¼‰ */
    #storeRow{display:none;}
    .row{display:flex; flex-wrap:wrap; gap:6px; padding:0 14px 6px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- heroï¼ˆDriveâ†’Places å‚™æ´ï¼Œè¼‰ä¸åˆ°å°±éš±è—ï¼‰ -->
      <img id="hero" class="hero" alt="hero" onerror="this.style.display='none'"/>

      <!-- æ¨™é¡Œï¼ˆå« logo + èªè¨€åˆ‡æ›ï¼‰ -->
      <div class="title">
        <img id="logo" class="logo" alt="logo" onerror="this.style.display='none'"/>
        <h1>ç‚ºã€Œ<span id="title-store-name">é–€å¸‚</span>ã€å¯«ä¸€å‰‡çŸ­è©•</h1>
        <select id="langSelect" class="lang-select" title="Language">
          <option value="zh">ä¸­æ–‡</option>
        </select>
      </div>

      <div class="sub" id="subtitle">æŒ‘å¹¾å€‹é‡é»ï¼ŒæŒ‰ã€Œç”Ÿæˆï¼ˆAIï¼‰ã€å°±èƒ½å¾—åˆ°è‡ªç„¶çš„ä¸€æ®µè©•è«–ã€‚</div>

      <!-- åªæœ‰æ²’å¸¶ store åƒæ•¸æ‰æœƒé¡¯ç¤ºï¼ˆä¿ç•™çµæ§‹ä»¥ç›¸å®¹èˆŠæµç¨‹ï¼‰ -->
      <div id="storeRow" class="row" style="margin-bottom:10px;">
        <div class="field"><label class="status">StoreIDï¼š</label><input id="store-input" placeholder="ä¾‹å¦‚ leegarnei" /></div>
        <div class="field"><label class="status">æ–°å¢æ¨™ç±¤ï¼š</label><input id="addTag" placeholder="è¼¸å…¥å¾ŒæŒ‰ Enter" /></div>
      </div>

      <!-- æ¨™ç±¤ Chips -->
      <div id="chips" style="margin-bottom:6px;"></div>

      <!-- å‹•ä½œæŒ‰éˆ• -->
      <div class="actions">
        <button id="gen" class="btn primary"><span class="spinner"></span>âœ¨ ç”Ÿæˆï¼ˆAIï¼‰</button>
        <button id="copy" class="btn">ğŸ“‹ è¤‡è£½</button>
      </div>

      <!-- çµæœ -->
      <textarea id="output" placeholder="é€™è£¡æœƒé¡¯ç¤º AI ç”Ÿæˆçš„çŸ­è©•â€¦"></textarea>

      <!-- Google è©•è«– -->
      <div class="footer-actions">
        <a id="openGoogle" class="btn secondary" target="_blank" rel="noopener noreferrer">ğŸ” é–‹å•Ÿ Google è©•è«–</a>
      </div>

      <div id="status" class="status" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // ===== URL store åƒæ•¸ =====
    function getStoreFromURL() {
      var url = new URL(location.href);
      var byQuery = (url.searchParams.get('store') || url.searchParams.get('storeid') || '').trim();
      if (byQuery) return byQuery;
      var parts = url.pathname.replace(/^\/+/, '').split('/');
      var first = (parts[0] || '').trim().toLowerCase();
      if (!first || first === 'index.html' || first === 'favicon.ico' || first === 'api') return '';
      if (first === 's' && parts[1]) return (parts[1] || '').trim();
      return parts[0] || '';
    }

    // ===== DOM =====
    var $chips = document.getElementById('chips');
    var $storeRow = document.getElementById('storeRow');
    var $storeInput = document.getElementById('store-input');
    var $addTag = document.getElementById('addTag');
    var $gen = document.getElementById('gen');
    var $copy = document.getElementById('copy');
    var $output = document.getElementById('output');
    var $status = document.getElementById('status');
    var $titleStoreName = document.getElementById('title-store-name');
    var $openGoogle = document.getElementById('openGoogle');
    var $logo = document.getElementById('logo');
    var $hero = document.getElementById('hero');
    var $langSelect = document.getElementById('langSelect');
    var $subtitle = document.getElementById('subtitle');

    // ===== ç‹€æ…‹ =====
    var selected = new Set();
    var currentStore = getStoreFromURL() || 'leegarnei';
    var currentLang = 'zh';
    var storeMeta = null;   // ä¿ç•™æ•´ä»½ /api/store çš„è³‡æ–™
    var availableLangs = [{code:'zh', label:'ä¸­æ–‡'}];

    if (!getStoreFromURL()) {
      $storeRow.style.display = 'flex';
      if ($storeInput) $storeInput.value = currentStore;
    }

    // ===== å·¥å…· =====
    function uniq(arr) {
      var out = [], seen = {};
      for (var i=0;i<arr.length;i++){
        var s = (arr[i] || '').trim();
        if (!s) continue;
        if (!seen[s]) { seen[s] = true; out.push(s); }
      }
      return out;
    }
    function withBuster(u){ if(!u) return ''; var sep = u.indexOf('?')>=0?'&':'?'; return u + sep + 'v=' + Date.now(); }
    function setImg(img, primary, fallback){
      if (primary) {
        img.onerror = function(){
          if (fallback && img.src !== fallback) {
            img.onerror = function(){ img.style.display='none'; };
            img.src = withBuster(fallback);
          } else img.style.display='none';
        };
        img.src = withBuster(primary);
        img.style.display='block';
        return;
      }
      if (fallback) {
        img.onerror = function(){ img.style.display='none'; };
        img.src = withBuster(fallback);
        img.style.display='block';
        return;
      }
      img.style.display='none';
    }

    // ===== èªè¨€åµæ¸¬ï¼ˆæ”¯æ´ En/Ko/Ja/Fr/Esï¼‰=====
    var suffixMap = {
      En: {code:'en', label:'EN'},
      Ko: {code:'ko', label:'í•œêµ­ì–´'},
      Ja: {code:'ja', label:'æ—¥æœ¬èª'},
      Fr: {code:'fr', label:'FR'},
      Es: {code:'es', label:'ES'}
    };
    function detectAvailableLangs(data){
      availableLangs = [{code:'zh', label:'ä¸­æ–‡'}]; // base
      var baseKeys = ['top3','features','ambiance','newItems'];
      var keys = Object.keys(data||{});
      // æ‰¾å‡º top3X / featuresX / ambianceX / newItemsX
      keys.forEach(function(k){
        var m = k.match(/^(top3|features|ambiance|newItems)([A-Z][a-z]+)$/);
        if (m && suffixMap[m[2]]) {
          var code = suffixMap[m[2]].code;
          if (!availableLangs.some(l=>l.code===code) && data[k] && String(data[k]).trim()){
            availableLangs.push({code:code, label:suffixMap[m[2]].label});
          }
        }
      });
      // é‡å»ºä¸‹æ‹‰
      $langSelect.innerHTML = availableLangs.map(function(l){
        return '<option value="'+l.code+'">'+l.label+'</option>';
      }).join('');
      // é è¨­è‹¥æœ‰ EN å°±æä¾›é¸é …ï¼Œä½†ä»é è¨­ä¸­æ–‡
      currentLang = 'zh';
      $langSelect.value = 'zh';
    }

    function tagsForLang(data, lang){
      function pick(suffix){
        var t = [];
        var a = data['top3'+suffix];
        var b = data['features'+suffix];
        var c = data['ambiance'+suffix];
        var d = data['newItems'+suffix];
        if (a) t = t.concat(String(a).split(','));
        if (b) t = t.concat(String(b).split(','));
        if (c) t = t.concat(String(c).split(','));
        if (d) t = t.concat(String(d).split(','));
        return uniq(t).slice(0,18);
      }
      if (lang==='zh') {
        var z = pick('');
        if (z.length) return z;
      }
      // å…¶é¤˜èªè¨€ï¼šæ‰¾å°æ‡‰çš„å°¾ç¢¼
      var suffixByCode = { en:'En', ko:'Ko', ja:'Ja', fr:'Fr', es:'Es' };
      var suf = suffixByCode[lang] || 'En';
      return pick(suf);
    }

    // ===== Chips =====
    function toggleTag(t) {
      if (selected.has(t)) selected.delete(t); else selected.add(t);
      var children = $chips.children;
      for (var i=0;i<children.length;i++) {
        var el = children[i];
        if (el.textContent === t) el.classList.toggle('on');
      }
    }
    function renderTagChips(list) {
      selected.clear();
      $chips.innerHTML = '';
      if (!list || !list.length){
        list = ['é»‘ç³–é¹¿ä¸¸é®®å¥¶','çš‡å®¶ä¹è™Ÿå¥¶èŒ¶','ç™½æ¡ƒçƒé¾','æœå‹™è¶…è¦ªåˆ‡','ç’°å¢ƒå¾ˆèˆ’æœ','é©åˆæ‹ç…§','é©åˆæƒ…ä¾¶ç´„æœƒ','å®¶åº­èšé¤','æœ‹å‹å°é…Œ','é¹¹é…¥é›éºµ'];
      }
      list.forEach(function(tag){
        var el = document.createElement('div');
        el.className = 'chip';
        el.textContent = tag;
        el.onclick = function(){ toggleTag(tag); };
        $chips.appendChild(el);
      });
    }

    // ===== åŸºæœ¬é€£çµ / æ–‡æ¡ˆ =====
    function applyBasicLinks(nameText) {
      $titleStoreName.textContent = nameText || currentStore || 'é–€å¸‚';
      var q = encodeURIComponent(currentStore || 'Big Way');
      $openGoogle.href = 'https://www.google.com/search?q=' + q + '+google+reviews';
    }
    function renderSubtitle(){
      var textMap = {
        zh: 'æŒ‘å¹¾å€‹é‡é»ï¼ŒæŒ‰ã€Œç”Ÿæˆï¼ˆAIï¼‰ã€å°±èƒ½å¾—åˆ°è‡ªç„¶çš„ä¸€æ®µè©•è«–ã€‚',
        en: 'Pick a few highlights, tap â€œGenerate (AI)â€ to get a natural review.',
        ko: 'ëª‡ ê°€ì§€ í¬ì¸íŠ¸ë¥¼ ê³ ë¥¸ ë’¤ â€œìƒì„±(AI)â€ì„ ëˆ„ë¥´ë©´ ìì—°ìŠ¤ëŸ¬ìš´ ë¦¬ë·°ê°€ ì™„ì„±ë¼ìš”.',
        ja: 'ã„ãã¤ã‹ã®ãƒã‚¤ãƒ³ãƒˆã‚’é¸ã‚“ã§ã€Œç”Ÿæˆï¼ˆAIï¼‰ã€ã‚’æŠ¼ã™ã ã‘ã§ã€è‡ªç„¶ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã§ãã¾ã™ã€‚',
        fr: 'Choisissez quelques points forts, puis cliquez sur Â« GÃ©nÃ©rer (IA) Â» pour obtenir un avis naturel.',
        es: 'Elige algunos puntos y pulsa Â«Generar (IA)Â» para obtener una reseÃ±a natural.'
      };
      $subtitle.textContent = textMap[currentLang] || textMap.zh;
    }

    // ===== è¼‰å…¥ meta =====
    async function loadStoreMeta() {
      try {
        var res = await fetch('/api/store?storeid=' + encodeURIComponent(currentStore));
        var data = await res.json();
        if (!res.ok) throw new Error((data && data.error) ? data.error : ('HTTP ' + res.status));
        storeMeta = data;

        applyBasicLinks(data.name || currentStore);

        detectAvailableLangs(data);
        renderSubtitle();
        renderTagChips(tagsForLang(data, currentLang));

        // åœ–ç‰‡ï¼ˆLogo / Heroï¼‰
        if (data.logoUrl || data.placePhotoUrl) setImg($logo, data.logoUrl, data.placePhotoUrl);
        else $logo.style.display='none';
        if (data.heroUrl || data.placePhotoUrl) setImg($hero, data.heroUrl, data.placePhotoUrl);
        else $hero.style.display='none';

        if (data.placeId) {
          $openGoogle.href = 'https://search.google.com/local/writereview?placeid=' + encodeURIComponent(data.placeId);
        }
      } catch (e) {
        console.error('loadStoreMeta error:', e);
        applyBasicLinks('é–€å¸‚');
        $logo.style.display='none';
        $hero.style.display='none';
        renderTagChips(null);
      }
    }

    // ===== äº‹ä»¶ï¼šèªè¨€åˆ‡æ› =====
    $langSelect.addEventListener('change', function(){
      currentLang = $langSelect.value || 'zh';
      renderSubtitle();
      if (storeMeta) renderTagChips(tagsForLang(storeMeta, currentLang));
    });

    // è‹¥æ‰‹å‹•è¼¸å…¥ storeï¼ˆèˆŠæµç¨‹ç›¸å®¹ï¼‰
    if ($storeInput) {
      $storeInput.addEventListener('input', function(){
        currentStore = ($storeInput.value || '').trim();
        applyBasicLinks();
      });
    }
    if ($addTag) {
      $addTag.addEventListener('keydown', function(e){
        if (e.key === 'Enter') {
          var v = ($addTag.value || '').trim();
          if (!v) return;
          var list = Array.from($chips.children).map(function(el){ return el.textContent; });
          if (list.indexOf(v) === -1) {
            list.unshift(v);
            renderTagChips(list);
            // é è¨­é¸å–æ–°åŠ å…¥çš„
            var kids = $chips.children;
            for (var j=0;j<kids.length;j++){ if (kids[j].textContent === v) { kids[j].click(); break; } }
          }
          $addTag.value = '';
        }
      });
    }

    // ===== åˆå§‹åŒ– =====
    applyBasicLinks('é–€å¸‚');
    loadStoreMeta();

    // ===== ç”Ÿæˆ / è¤‡è£½ =====
    async function generate(){
      var storeid = (currentStore || '').trim();
      if (!storeid) { $status.textContent = 'è«‹å…ˆæŒ‡å®š StoreIDã€‚'; return; }
      var selectedTags = Array.from(selected);
      var body = { storeid: storeid, selectedTags: selectedTags, variant: 1, minChars: 90, maxChars: 160, lang: currentLang };

      // loading ç‹€æ…‹
      $gen.classList.add('loading'); $gen.disabled = true; $copy.disabled = true;
      var prevTxt = $gen.innerHTML;
      $gen.innerHTML = '<span class="spinner"></span>' + (currentLang==='en' ? 'Generatingâ€¦' : 'ç”Ÿæˆä¸­â€¦');
      $status.textContent = '';

      try {
        var res = await fetch('/api/generate', {
          method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(body)
        });
        var data = await res.json();
        if (!res.ok) throw new Error((data && data.error) ? data.error : ('HTTP ' + res.status));

        $output.value = data.reviewText || JSON.stringify(data, null, 2);
        $status.textContent = 'âœ… ' + (currentLang==='en' ? 'Done' : 'å®Œæˆ') + 'ï¼ˆ' + (data.latencyMs || '-') + ' msï¼‰';
        if (data && data.store && data.store.placeId) {
          $openGoogle.href = 'https://search.google.com/local/writereview?placeid=' + encodeURIComponent(data.store.placeId);
        }
      } catch (err) {
        $output.value = '';
        $status.textContent = 'âŒ ' + ((currentLang==='en') ? ('Error: ' + err.message) : ('ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message));
      } finally {
        $gen.classList.remove('loading'); $gen.disabled = false; $copy.disabled = false; $gen.innerHTML = prevTxt;
      }
    }

    async function copyText(){
      var t = ($output.value || '').trim();
      if(!t){ $status.textContent = (currentLang==='en') ? 'Nothing to copy' : 'å°šç„¡å…§å®¹å¯è¤‡è£½'; return; }
      try {
        await navigator.clipboard.writeText(t);
        $status.textContent = (currentLang==='en') ? 'Copied' : 'ğŸ“‹ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿';
      } catch(_e) {
        $status.textContent = (currentLang==='en') ? 'Please copy manually' : 'è«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½';
      }
    }

    document.getElementById('gen').addEventListener('click', generate);
    document.getElementById('copy').addEventListener('click', copyText);
  </script>
</body>
</html>
