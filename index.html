<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Smart Google Review Â· AI ä¸€å‰‡çŸ­è©•</title>
  <style>
    :root{
      --bg:#F5F7FB; --card:#FFFFFF; --fg:#0F172A; --muted:#64748B;
      --blue:#0A84FF; --blue-600:#0A84FF; --blue-500:#0A84FF; --blue-400:#49A2FF;
      --blue-300:#7CB9FF; --blue-200:#CDE5FF; --blue-100:#EAF4FF; --blue-050:#F3F9FF;
      --blue-hover:#49A2FF; --blue-active:#0A84FF; --on-blue:#FFFFFF;
      --chip-bg:var(--blue-100); --chip-bg-on:var(--blue-500); --chip-fg:#0F172A; --chip-fg-on:#FFFFFF;
      --fs-title-max:28px; --fs-title-min:18px; --fs-body:clamp(13px,1.2vw+10px,16px);
      --fs-chip:clamp(12px,1vw+8px,14px); --fs-btn:clamp(14px,1.2vw+11px,16px);
      --radius-lg:16px; --radius-md:12px; --radius-sm:10px;
      --shadow:0 10px 30px rgba(15,23,42,0.08); --shadow-soft:0 6px 20px rgba(15,23,42,0.06);
      --ring:0 0 0 3px color-mix(in oklab, var(--blue-300) 60%, transparent);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{margin:0; background:var(--bg); color:var(--fg); font:var(--fs-body)/1.55 system-ui,-apple-system,Inter,'PingFang TC','Noto Sans TC',sans-serif;}
    .wrap{max-width:760px; margin:auto; padding:12px;}
    .card{background:var(--card); border-radius:20px; box-shadow:var(--shadow); overflow:hidden; position:relative;}
    .hero-wrap{position:relative;}
    .hero{width:100%; height:220px; object-fit:cover; display:none;}
    @media (max-width:520px){ .hero{height:180px;} }
    .lang-pill{position:absolute; right:12px; top:12px; display:flex; gap:6px; padding:6px; border-radius:999px; background:rgba(15,23,42,.45); backdrop-filter:blur(6px);}
    .lang-pill button{border:0; background:transparent; padding:6px 12px; border-radius:999px; font-weight:700; color:#fff; min-width:42px; font-size:12px; cursor:pointer;}
    .lang-pill button.active{background:#0B1020; color:#fff;}
    .logo-badge{position:absolute; left:50%; bottom:-22px; transform:translateX(-50%); width:64px; height:64px; border-radius:14px; background:#fff; padding:8px; box-shadow:0 10px 30px rgba(15,23,42,.18), 0 2px 6px rgba(15,23,42,.1); display:none;}
    .logo-badge img{width:100%; height:100%; object-fit:contain;}
    @media (max-width:520px){ .logo-badge{width:56px; height:56px; bottom:-20px;} }
    .content{padding:26px 16px 14px; margin-top:14px;}
    .title{margin:0 0 6px 0; font-weight:800; line-height:1.2; font-size:var(--fs-title-max);}
    .sub{color:var(--muted); margin:0 0 10px 0;}
    #chips{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin:10px 0 12px;}
    @media (min-width:540px){ #chips{grid-template-columns:repeat(3,minmax(0,1fr));}}
    .chip{border-radius:999px; padding:10px 14px; background:var(--chip-bg); color:var(--chip-fg); display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; border:1px solid var(--blue-200); transition:all .15s; box-shadow:var(--shadow-soft); min-height:48px;}
    .chip:hover{transform:translateY(-1px); background:color-mix(in oklab, var(--blue-100) 60%, white);}
    .chip.on{background:var(--chip-bg-on); color:var(--chip-fg-on); border-color:transparent;}
    .chip:focus-visible{outline:none; box-shadow:var(--ring);}
    .chip-text{font-size:var(--fs-chip); font-weight:600; text-align:center; line-height:1.25; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;}
    .actions{display:flex; gap:10px; margin:8px 0 8px;}
    .btn{flex:1; height:46px; border:0; border-radius:14px; font-weight:800; font-size:var(--fs-btn); display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:var(--shadow-soft); transition:transform .08s, background-color .12s, box-shadow .12s;}
    .btn.primary{color:var(--on-blue); background:var(--blue-500); box-shadow:0 6px 16px color-mix(in oklab,var(--blue-500) 14%,transparent);}
    .btn.primary:hover{background:var(--blue-hover);}
    .btn.primary:active{transform:translateY(1px); background:var(--blue-active);}
    .btn.secondary{background:#0B1220; color:#fff; height:52px; border-radius:16px;}
    .btn:disabled{opacity:.7; cursor:not-allowed;}
    .spinner{width:18px; height:18px; border:2px solid color-mix(in oklab, var(--on-blue) 45%, transparent); border-top-color:var(--on-blue); border-radius:50%; margin-right:8px; display:none; animation:spin .9s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    textarea{width:100%; margin:0; padding:12px 14px; min-height:120px; border:1px solid var(--blue-200); border-radius:14px; font-size:var(--fs-body); box-shadow:var(--shadow-soft);}
    .thanks-notice{margin:12px 0 0; padding:14px; border-radius:var(--radius-md); background:var(--blue-050); color:var(--fg); box-shadow:var(--shadow-soft); font-size:14px; line-height:1.5; text-align:center;}
    .footer-actions{display:flex; justify-content:center; margin-top:12px;}
    .status{color:var(--muted); font-size:12px; text-align:center; padding:10px 0 4px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hero-wrap">
        <img id="hero" class="hero" alt="hero"/>
        <div id="langBar" class="lang-pill" aria-label="language switch"></div>
        <div id="logoBadge" class="logo-badge"><img id="logo" alt="logo"/></div>
      </div>

      <div class="content">
        <h1 id="title" class="title">ç‚ºã€Œ<span id="title-store-name">é–€å¸‚</span>ã€å¯«ä¸€å‰‡çŸ­è©•</h1>
        <p id="subtitle" class="sub">æŒ‘é¸ä»Šå¤©ä½ æœ€æœ‰æ„Ÿçš„å¹¾å€‹é‡é»ï¼Œæˆ‘å€‘æœƒå¹«ä½ æ•´ç†æˆçŸ­è©•ã€‚</p>

        <div id="chips"></div>

        <div class="actions">
          <button id="gen" class="btn primary"></button>
        </div>

        <textarea id="output" placeholder="é€™è£¡æœƒé¡¯ç¤ºæ•´ç†å¾Œçš„ä¸€æ®µçŸ­è©•â€¦" style="display:none;"></textarea>

        <!-- è¤‡è£½ä¸¦é–‹å•Ÿï¼šä¸€é–‹å§‹éš±è—ï¼Œç”¢ç”Ÿå¾Œé¡¯ç¤ºï¼›ç¨‹å¼æœƒæŠŠå®ƒç§»åˆ° textarea ä¸‹æ–¹ -->
        <div class="footer-actions">
          <a id="openGoogle" class="btn secondary" target="_blank" rel="noopener noreferrer">ğŸ“‹ è¤‡è£½ä¸¦é–‹å•Ÿgoogleè©•è«–</a>
        </div>

        <!-- æˆåŠŸæç¤ºï¼šä¿æŒåœ¨ä¸‹æ–¹å€åŸŸ -->
        <div id="thanksNotice" class="thanks-notice" data-keep-thanks="true" style="display:none;">
          <div id="thanksMessage"></div>
        </div>

        <div id="status" class="status" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- color utils ---------- */
    const hexToRgb=h=>{h=h.replace('#',''); if(h.length===3)h=h.split('').map(c=>c+c).join(''); const n=parseInt(h,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}};
    const rgbToHex=(r,g,b)=>'#'+[r,g,b].map(v=>('0'+v.toString(16)).slice(-2)).join('');
    function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const M=Math.max(r,g,b),m=Math.min(r,g,b);let h,s,l=(M+m)/2;if(M===m){h=s=0}else{const d=M-m;s=l>0.5?d/(2-M-m):d/(M+m);switch(M){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}h/=6}return{h,s,l}}
    function hslToRgb(h,s,l){let r,g,b;if(s===0){r=g=b=l}else{const q=l<0.5?l*(1+s):l+s-l*s,p=2*l-q,f=t=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p};r=f(h+1/3);g=f(h);b=f(h-1/3)}return{r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255)}}
    const normHex=h=>{if(!h)return'';let s=String(h).trim();if(!s.startsWith('#'))s='#'+s;if(/^#([0-9a-fA-F]{3})$/.test(s)){const[,r,g,b]=s.match(/^#(.)(.)(.)$/);s='#'+r+r+g+g+b+b}return /^#([0-9a-fA-F]{6})$/.test(s)?s.toUpperCase():''};
    const lighten=(hex,d)=>{const {r,g,b}=hexToRgb(hex),hsl=rgbToHsl(r,g,b);hsl.l=Math.max(0,Math.min(1,hsl.l+Math.abs(d)));hsl.s=Math.max(0,Math.min(0.92,hsl.s*1.00));const rgb=hslToRgb(hsl.h,hsl.s,hsl.l);return rgbToHex(rgb.r,rgb.g,rgb.b)}
    const autoOnColor=bg=>{const {r,g,b}=hexToRgb(bg);const L=0.2126*(r/255)+0.7152*(g/255)+0.0722*(b/255);return (L<0.56)?'#FFFFFF':'#0B1220'}
    function applyBlueScale(baseHex,onHex){const base=normHex(baseHex)||'#0A84FF';const on=normHex(onHex)||autoOnColor(base);const root=document.documentElement;const vars={'--blue-600':base,'--blue-500':base,'--blue-450':lighten(base,.04),'--blue-400':lighten(base,.10),'--blue-300':lighten(base,.20),'--blue-200':lighten(base,.30),'--blue-100':lighten(base,.38),'--blue-050':lighten(base,.45),'--blue-hover':lighten(base,.06),'--blue-active':base,'--on-blue':on};Object.entries(vars).forEach(([k,v])=>root.style.setProperty(k,v));root.style.setProperty('--chip-bg','var(--blue-100)');root.style.setProperty('--chip-bg-on','var(--blue-450)');root.style.setProperty('--chip-fg-on','var(--on-blue)')}

    /* ---------- helpers ---------- */
    function getStoreFromURL(){const url=new URL(location.href);const byQuery=(url.searchParams.get('store')||url.searchParams.get('storeid')||'').trim();if(byQuery)return byQuery;const parts=url.pathname.replace(/^\/+/,'').split('/');const first=(parts[0]||'').trim().toLowerCase();if(!first||first==='index.html'||first==='favicon.ico'||first==='api')return'';if(first==='s'&&parts[1])return(parts[1]||'').trim();return parts[0]||''}
    const uniq=a=>Array.from(new Set((a||[]).map(s=>String(s||'').trim()).filter(Boolean)));
    const pick=(o,...keys)=>{for(const k of keys){const v=o&&o[k];if(v!==undefined&&v!==null&&String(v).trim()!=='')return v}return''}
    const withBuster=u=>(!u?'':(u+(u.includes('?')?'&':'?')+'v='+Date.now()))
    function setImgEl(imgEl,url,fallback,wrapper){const show=ok=>((wrapper||imgEl).style.display= ok?((wrapper||imgEl).classList.contains('hero')?'block':'flex'):'none');const src=url||fallback;if(!src)return show(false);imgEl.onload=()=>show(true);imgEl.onerror=()=>show(false);imgEl.src=withBuster(src)}

    function parseStoreNameMulti(s){
      const out={zh:'',en:'',ko:'',ja:'',fr:'',es:'',_raw:(s||'').trim()}; if(!s) return out;
      const str=String(s).trim();
      if(/[a-z]{2}\s*=/.test(str)){str.split(',').forEach(p=>{const[k,v]=p.split('=');if(!k||!v)return;const kk=k.trim().toLowerCase();const vv=v.trim();if(out.hasOwnProperty(kk))out[kk]=vv});return out;}
      const parts=str.split(',').map(x=>x.trim()).filter(Boolean);
      const isLatin=t=>/[A-Za-z]/.test(t), isKo=t=>/[ê°€-í£]/.test(t), isJa=t=>/[\u3040-\u30ff\u31f0-\u31ff\uFF66-\uFF9D]/.test(t);
      parts.forEach(p=>{ if(!out.en&&isLatin(p)){out.en=p;return} if(!out.ko&&isKo(p)){out.ko=p;return} if(!out.ja&&isJa(p)){out.ja=p;return} if(!out.zh){out.zh=p;return}});
      return out;
    }
    function storeNameForLang(map,lang){
      if(!map) return '';
      const order={zh:['zh','en','ko','ja','fr','es'],en:['en','zh','ko','ja','fr','es'],ko:['ko','zh','en','ja','fr','es'],ja:['ja','zh','en','ko','fr','es'],fr:['fr','en','zh','ko','ja','es'],es:['es','en','zh','ko','ja','fr']}[lang]||['en','zh','ko','ja','fr','es'];
      for(const k of order){const v=(map[k]||'').trim(); if(v) return v} return (map._raw||'').trim();
    }

    const LANGS={
      en:{label:'EN',chips:['top3En','featuresEn','ambianceEn','newItemsEn','top3','features','ambiance','newItems'],ui:{title:'Write a short review for â€œ{name}â€',sub:'Pick what stood out today. Weâ€™ll generate a review.',gen:'âœï¸ Generate & Claim Reward',open:'Copy & Open Google',placeholder:'Your summarized review will appear hereâ€¦'}},
      zh:{label:'ä¸­',chips:['top3Cn','featuresCn','ambianceCn','newItemsCn','top3','features','ambiance','newItems'],ui:{title:'ç‚ºã€Œ{name}ã€å¯«ä¸€å‰‡çŸ­è©•',sub:'æŒ‘é¸ä»Šå¤©ä½ æœ€æœ‰æ„Ÿçš„å¹¾å€‹é‡é»ï¼Œæˆ‘å€‘æœƒå¹«ä½ æ•´ç†çŸ­è©•ã€‚',gen:'âœï¸ ç”¢ç”Ÿè©•è«–ä¸¦é ˜å–çå‹µ',open:'ğŸ“‹ è¤‡è£½ä¸¦é–‹å•Ÿgoogleè©•è«–',placeholder:'é€™è£¡æœƒé¡¯ç¤ºæ•´ç†å¾Œçš„ä¸€æ®µçŸ­è©•â€¦'}},
      ko:{label:'í•œêµ­ì–´',chips:['top3Ko','featuresKo','ambianceKo','newItemsKo','top3','features','ambiance','newItems'],ui:{title:'â€œ{name}â€ ë¦¬ë·° í•œ ì¤„',sub:'ì˜¤ëŠ˜ ì¸ìƒ ê¹Šì—ˆë˜ í¬ì¸íŠ¸ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”.',gen:'âœï¸ ì‘ì„± ë° ë¦¬ì›Œë“œ ë°›ê¸°',open:'ğŸ“‹ ë³µì‚¬ ë° Google ì—´ê¸°',placeholder:'ìš”ì•½ëœ ë¦¬ë·°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤â€¦'}},
      ja:{label:'æ—¥æœ¬èª',chips:['top3Ja','featuresJa','ambianceJa','newItemsJa','top3','features','ambiance','newItems'],ui:{title:'ã€Œ{name}ã€ã¸ä¸€è¨€ãƒ¬ãƒ“ãƒ¥ãƒ¼',sub:'å°è±¡ã«æ®‹ã£ãŸãƒã‚¤ãƒ³ãƒˆã‚’é¸ã‚“ã§ãã ã•ã„ã€‚',gen:'âœï¸ ä½œæˆã—ã¦ç‰¹å…¸ã‚’å—ã‘å–ã‚‹',open:'ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¦ Google ã‚’é–‹ã',placeholder:'è¦ç´„ã—ãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™â€¦'}},
      fr:{label:'FR',chips:['top3Fr','featuresFr','ambianceFr','newItemsFr','top3','features','ambiance','newItems'],ui:{title:'Ã‰crire un avis court pour Â« {name} Â»',sub:'Choisissez les points marquants, nous gÃ©nÃ©rons un avis.',gen:'âœï¸ RÃ©diger & RÃ©compense',open:'ğŸ“‹ Copier & Ouvrir Google',placeholder:'Votre avis synthÃ©tisÃ© sâ€™affichera iciâ€¦'}},
      es:{label:'ES',chips:['top3Es','featuresEs','ambianceEs','newItemsEs','top3','features','ambiance','newItems'],ui:{title:'Escribe una reseÃ±a para Â«{name}Â»',sub:'Elige lo que destacÃ³ hoy.',gen:'âœï¸ Redactar y Reclamar',open:'ğŸ“‹ Copiar y Abrir Google',placeholder:'AquÃ­ aparecerÃ¡ tu reseÃ±aâ€¦'}}
    };

    /* ---------- DOM ---------- */
    const $chips=document.getElementById('chips');
    const $gen=document.getElementById('gen');
    const $openGoogle=document.getElementById('openGoogle');
    const $output=document.getElementById('output');
    const $status=document.getElementById('status');
    const $logo=document.getElementById('logo');
    const $logoBadge=document.getElementById('logoBadge');
    const $hero=document.getElementById('hero');
    const $langBar=document.getElementById('langBar');
    const $title=document.getElementById('title');
    const $subtitle=document.getElementById('subtitle');
    const $titleStoreName=document.getElementById('title-store-name');
    const $thanksNotice=document.getElementById('thanksNotice');
    const $thanksMessage=document.getElementById('thanksMessage');

    let selected=new Set();
    let currentStore=getStoreFromURL()||'leegarnei';
    let currentLang='zh';
    let storeMeta=null, availableLangs=[], storeNames=null;
    let googleReviewUrl_global='';
    let isGenerated=false;

    const genButtonTemplate=()=>`<span class="spinner"></span><span id="btnGen">${LANGS[currentLang].ui.gen}</span>`;

    // ä¸€é–‹å§‹æŠŠé»‘è‰²æŒ‰éˆ•è—èµ·ä¾†ä¸¦æ¬åˆ° textarea ä¸‹æ–¹
    $openGoogle.style.display='none';
    $output.insertAdjacentElement('afterend',$openGoogle);

    function applyBasicLinks(nameText){
      $titleStoreName.textContent=nameText||currentStore||'Store';
      const q=encodeURIComponent(currentStore||'Big Way');
      $openGoogle.href='https://www.google.com/search?q='+q+'+google+reviews';
      googleReviewUrl_global=$openGoogle.href;
    }

    function langHasContent(langKey,data){
      const cfg=LANGS[langKey]; if(!cfg) return false;
      return cfg.chips.some(k => (data && String(data[k]||'').trim()));
    }

    function buildLangBar(){
      $langBar.innerHTML='';
      availableLangs.forEach(k=>{
        const btn=document.createElement('button');
        btn.textContent=LANGS[k].label; btn.className=(k===currentLang)?'active':'';
        btn.onclick=()=>{currentLang=k; renderUI(); buildLangBar(); buildChipsFromMeta();};
        $langBar.appendChild(btn);
      });
    }

    function fitTitle(){
      const max=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fs-title-max'))||28;
      const min=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fs-title-min'))||18;
      let size=max; $title.style.fontSize=size+'px'; const w=$title.clientWidth;
      while($title.scrollWidth>w && size>min){ size-=1; $title.style.fontSize=size+'px'; }
    }

    function renderUI(){
      const ui=LANGS[currentLang].ui;
      const localizedName=storeNameForLang(storeNames,currentLang)||pick(storeMeta,'name')||currentStore||'Store';
      $title.innerHTML=ui.title.replace('{name}',`<span id="title-store-name">${localizedName}</span>`);
      $subtitle.textContent=ui.sub;
      $gen.innerHTML=genButtonTemplate();
      $openGoogle.textContent=ui.open;
      $output.placeholder=ui.placeholder;
      const thanksCopy={
        zh:'æ„Ÿè¬æ‚¨æä¾›å¯¶è²´å›é¥‹ã€‚<b>è«‹å‡ºç¤ºæ­¤ç•«é¢</b>å³å¯å‘åº—å“¡å…Œæ›',
        en:'Thank you for your feedback. <b>Show this screen</b> to redeem with the staff.',
        ko:'ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤. <b>ì´ í™”ë©´ì„ ì œì‹œ</b>í•˜ì‹œë©´ ì§ì›ì´ ë¦¬ì›Œë“œë¥¼ ë“œë¦½ë‹ˆë‹¤.',
        ja:'ã”æ„è¦‹ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<b>ã“ã®ç”»é¢ã‚’ã”æç¤º</b>ã„ãŸã ãã¨ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰ç‰¹å…¸ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚',
        fr:'Merci pour votre avis. <b>PrÃ©sentez cet Ã©cran</b> pour lâ€™Ã©changer auprÃ¨s du personnel.',
        es:'Gracias por tu opiniÃ³n. <b>Muestra esta pantalla</b> al personal para canjearla.'
      }[currentLang]||'Thank you for your feedback. <b>Show this screen</b> to redeem with the staff.';
      $thanksMessage.innerHTML=thanksCopy;
      const hasReview=isGenerated && ($output.value||'').trim()!=='';
      $thanksNotice.style.display=hasReview?'block':'none';
      $output.style.display=hasReview?'block':'none';
      $openGoogle.style.display=hasReview?'block':'none';
      requestAnimationFrame(fitTitle);
    }

    function buildChipsFromMeta(){
      const cfg=LANGS[currentLang]; const data=storeMeta||{}; let tags=[];
      cfg.chips.forEach(k=>{const raw=pick(data,k); if(raw) tags=tags.concat(String(raw).split(','));});
      tags=uniq(tags).slice(0,18);
      if(tags.length===0){tags=['boba','rice','dumpling','Nice service','clean environment','Couple date','family reunion','Fried noodles'];}
      selected.clear(); $chips.innerHTML='';
      tags.forEach(tag=>{
        const el=document.createElement('div'); el.className='chip';
        el.innerHTML=`<span class="chip-text">${tag.trim()}</span>`;
        el.onclick=()=>{if(selected.has(tag))selected.delete(tag);else selected.add(tag); el.classList.toggle('on');};
        $chips.appendChild(el);
      });
    }

    function applyThemeFromMeta(d){
      const apiBlue=(pick(d,'themeBlue')||'').trim();
      const apiOn=(pick(d,'themeOnBlue')||'').trim();
      const cssBase=getComputedStyle(document.documentElement).getPropertyValue('--blue').trim()||'#0A84FF';
      applyBlueScale(apiBlue||cssBase,apiOn);
    }

    async function loadStoreMeta(){
      try{
        const res=await fetch('/api/store?storeid='+encodeURIComponent(currentStore));
        const data=await res.json(); if(!res.ok) throw new Error(data?.error||('HTTP '+res.status));
        storeMeta=data; applyThemeFromMeta(data);
        storeNames=parseStoreNameMulti(pick(data,'name','storeName','title')||currentStore);
        applyBasicLinks(storeNameForLang(storeNames,currentLang));
        const order=['zh','en','ko','ja','fr','es']; availableLangs=order.filter(k=>langHasContent(k,data));
        if(availableLangs.length===0) availableLangs=['zh','en']; if(!availableLangs.includes(currentLang)) currentLang=availableLangs[0];
        const heroUrl=pick(data,'heroUrl','cover','banner','placePhotoUrl','photoUrl');
        const logoUrl=pick(data,'logoUrl','logo','image','icon');
        setImgEl($hero,heroUrl,pick(data,'placePhotoUrl','photoUrl'));
        setImgEl($logo,logoUrl,pick(data,'placePhotoUrl','photoUrl'),$logoBadge);
        if(data.placeId){ const url='https://search.google.com/local/writereview?placeid='+encodeURIComponent(data.placeId); $openGoogle.href=url; googleReviewUrl_global=url; }
        renderUI(); buildLangBar(); buildChipsFromMeta();
      }catch(e){
        const cssBase=getComputedStyle(document.documentElement).getPropertyValue('--blue').trim()||'#0A84FF';
        applyBlueScale(cssBase,''); storeNames=parseStoreNameMulti(currentStore);
        applyBasicLinks(storeNameForLang(storeNames,currentLang)); renderUI(); buildLangBar(); buildChipsFromMeta();
      }
    }

    (function init(){const cssBase=getComputedStyle(document.documentElement).getPropertyValue('--blue').trim()||'#0A84FF'; applyBlueScale(cssBase,'');})();
    applyBasicLinks('Store'); renderUI(); loadStoreMeta(); addEventListener('resize',()=>requestAnimationFrame(fitTitle));

    // é»‘è‰²æŒ‰éˆ•é»æ“Šï¼šå…ˆè¤‡è£½ï¼Œå†é–‹å•Ÿ
    $openGoogle.addEventListener('click', async (e)=>{
      e.preventDefault();
      const txt=($output.value||'').trim();
      if(!txt){ $status.textContent='å°šç„¡å…§å®¹å¯è¤‡è£½'; return; }
      try{ await navigator.clipboard.writeText(txt); $status.textContent='ğŸ“‹ å·²è¤‡è£½ï¼'; }catch{ $status.textContent='è«‹æ‰‹å‹•è¤‡è£½'; }
      try{ window.open(googleReviewUrl_global,'_blank'); }catch{}
    });

    async function generate(){
      const storeid=(currentStore||'').trim();
      if(!storeid){ $status.textContent=(currentLang==='zh')?'è«‹å…ˆæŒ‡å®š StoreIDã€‚':'Please set StoreID first.'; return; }
      const selectedTags=Array.from(selected);
      if(selectedTags.length===0){ $status.textContent={en:'Please select at least one tag.', zh:'è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¨™ç±¤ã€‚'}[currentLang]||'Please select at least one tag.'; return; }
      const body={storeid, selectedTags, variant:1, minChars:90, maxChars:160, lang:currentLang};

      $gen.classList.add('loading'); $gen.disabled=true;
      $gen.innerHTML=`<span class="spinner"></span>${{en:'Composingâ€¦',zh:'æ’°å¯«ä¸­â€¦'}[currentLang]||'Composingâ€¦'}`;
      $status.textContent='';

      try{
        const res=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        const data=await res.json(); if(!res.ok) throw new Error(data?.error||('HTTP '+res.status));

        // æˆåŠŸï¼šæ›´æ–° textareaï¼Œé¡¯ç¤ºè¤‡è£½æŒ‰éˆ•èˆ‡æç¤ºæ–‡å­—ï¼›ä¸è‡ªå‹•é–‹é ã€ä¸æ”¹å‹•æ¨™ç±¤å€
        const reviewText=data.reviewText||''; $output.value=reviewText;
        if(data?.store?.placeId){ googleReviewUrl_global='https://search.google.com/local/writereview?placeid='+encodeURIComponent(data.store.placeId); $openGoogle.href=googleReviewUrl_global; }

        isGenerated=true;
        renderUI();

        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        $status.textContent=({zh:'âœ… è©•è«–å·²ç”¢ç”Ÿï¼',en:'âœ… Review generated!'}[currentLang]||'âœ… Done')+' ('+(data.latencyMs||'-')+' ms)';
      }catch(err){
        $status.textContent=({zh:'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š',en:'âŒ Error: '}[currentLang]||'âŒ Error: ')+err.message;
      }finally{
        $gen.classList.remove('loading'); $gen.disabled=false; $gen.innerHTML=genButtonTemplate();
      }
    }

    document.getElementById('gen').addEventListener('click', generate);
  </script>

  <!-- ğŸ”¥ HOTFIXï¼šå¼·åˆ¶ä¸è‡ªå‹•é–‹é ã€æ¨™ç±¤ä¸è¢«å–ä»£ã€åªä¿ç•™å–®ä¸€æŒ‰éˆ• -->
  <script>
  (function hotfix(){
    const chips = document.getElementById('chips');
    const output = document.getElementById('output');
    const openBtn = document.getElementById('openGoogle');
    const status = document.getElementById('status');
    // ä»»ä½•æ™‚å€™ chips è¢«éš±è—/ç§»é™¤ï¼Œç«‹å³å¾©åŸ
    if (chips) {
      const mo = new MutationObserver(()=>{
        chips.style.display='grid';
        chips.hidden=false;
      });
      mo.observe(document.body,{childList:true,subtree:true});
    }
    // ç¢ºä¿é»‘è‰²æŒ‰éˆ•å°±åœ¨ textarea ä¸‹æ–¹ï¼ˆå¦‚æœæœ‰å…¶ä»–ç¨‹å¼ç§»èµ°ï¼‰
    if (openBtn && output && openBtn.previousElementSibling!==output) {
      output.insertAdjacentElement('afterend', openBtn);
    }
    // ç¦æ­¢èƒŒæ™¯ç¨‹å¼è‡ªå‹• window.openï¼ˆåªå…è¨±å¾ openBtn çš„é»æ“Šè§¸ç™¼ï¼‰
    const _open = window.open;
    window.open = function(url, target, features){
      const fromBtn = (document.activeElement === openBtn) || (url && String(url).includes('writereview'));
      return fromBtn ? _open.call(window, url, target, features) : null;
    };
    // ç§»é™¤ä»»ä½•ã€Œæ„Ÿè¬æ‚¨çš„å›é¥‹ï¼æˆ‘å€‘å·²ç‚ºæ‚¨é–‹å•Ÿ Google è©•è«–åˆ†é ã€‚ã€æç¤ºå€å¡Š
    const killThanks = ()=>{
      document.querySelectorAll('*').forEach(el=>{
        const t=(el.textContent||'').trim();
        const keep = el.closest('[data-keep-thanks="true"]');
        if ((t.includes('æ„Ÿè¬æ‚¨çš„å›é¥‹') || t.includes('æˆ‘å€‘å·²ç‚ºæ‚¨é–‹å•Ÿ Google è©•è«–åˆ†é ')) && !keep) {
          if (!el.contains(chips) && el.remove) el.remove();
        }
      });
    };
    new MutationObserver(killThanks).observe(document.body,{childList:true,subtree:true});
    killThanks();
    // å†ä¿éšªï¼šçµ¦ openBtn å†ç¶ä¸€æ¬¡è¡Œç‚ºï¼ˆå…ˆè¤‡è£½å†é–‹å•Ÿï¼‰
    openBtn && openBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const txt=(output.value||'').trim();
      if(!txt){ status && (status.textContent='å°šç„¡å…§å®¹å¯è¤‡è£½'); return; }
      try{ await navigator.clipboard.writeText(txt); status && (status.textContent='ğŸ“‹ å·²è¤‡è£½ï¼'); }catch{ status && (status.textContent='è«‹æ‰‹å‹•è¤‡è£½'); }
      try{ _open.call(window, window.googleReviewUrl_global || openBtn.href, '_blank'); }catch{}
    }, { capture:false });
  })();
  </script>
</body>
</html>


