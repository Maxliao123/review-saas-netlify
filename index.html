<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Google Review · AI 一則短評</title>
  <style>
    :root { --bg:#f5f4f2; --fg:#1f2937; --card:#ffffff; --muted:#6b7280; --pri:#0ea5e9; --chip:#e5f2fb; --chip-on:#0ea5e9; --chip-on-fg:#fff; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font:16px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"PingFang TC","Noto Sans TC","Microsoft JhengHei",sans-serif; }
    .wrap { max-width:980px; margin:56px auto; padding:0 20px; }
    .card { background:var(--card); border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.06); padding:28px; }
    .brand { display:flex; align-items:center; gap:12px; margin-bottom:8px; }
    .logo { width:40px; height:40px; border-radius:10px; object-fit:cover; background:#eee; }
    h1 { margin:0; font-size:24px; }
    .sub { color:var(--muted); margin:10px 0 18px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .field { display:flex; gap:10px; align-items:center; }
    .field input { height:36px; padding:0 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none; }
    .field input:focus { border-color:var(--pri); box-shadow:0 0 0 3px rgba(14,165,233,.15); }
    .chip { padding:8px 12px; background:var(--chip); border-radius:999px; cursor:pointer; user-select:none; transition:.15s; }
    .chip.on { background:var(--chip-on); color:var(--chip-on-fg); }
    .btn { height:40px; padding:0 14px; border:0; border-radius:12px; cursor:pointer; background:var(--pri); color:#fff; font-weight:600; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .btn.secondary { background:#111827; }
    .btn.ghost { background:#eef2f7; color:#111827; }
    textarea { width:100%; min-height:140px; resize:vertical; padding:12px; border:1px solid #e5e7eb; border-radius:12px; outline:none; }
    textarea:focus { border-color:var(--pri); box-shadow:0 0 0 3px rgba(14,165,233,.15); }
    .muted { color:var(--muted); font-size:13px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin:12px 0; }
    .footer-actions { display:flex; gap:10px; align-items:center; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <img id="storeLogo" class="logo" alt="logo" />
        <h1>為「<span id="storeName">門市</span>」寫一則短評</h1>
      </div>
      <div class="sub">勾選幾個重點，再按「生成（AI）」就會幫你寫出自然的一段評論。</div>

      <!-- 只有沒有帶 store 到網址時，才顯示這列 -->
      <div id="storeRow" class="row" style="margin-bottom:10px;">
        <div class="field">
          <label for="storeid" class="muted">StoreID：</label>
          <input id="storeid" placeholder="例如 leegarnei" />
        </div>
        <div class="field">
          <label for="addTag" class="muted">新增標籤：</label>
          <input id="addTag" placeholder="輸入後按 Enter" />
        </div>
      </div>

      <!-- 標籤 Chips -->
      <div id="chips" class="row" style="margin-bottom:16px;"></div>

      <!-- 動作按鈕（上） -->
      <div class="actions">
        <button id="gen" class="btn">✨ 生成（AI）</button>
        <button id="copy" class="btn ghost">📋 複製</button>
      </div>

      <!-- 結果 -->
      <textarea id="output" placeholder="這裡會顯示 AI 生成的短評…"></textarea>

      <!-- 動作按鈕（輸出框下方） -->
      <div class="footer-actions">
        <a id="openGoogle" class="btn secondary" target="_blank" rel="noopener noreferrer">🔍 開啟 Google 評論</a>
        <span class="muted" id="status" aria-live="polite"></span>
      </div>
    </div>
  </div>

  <script>
    // 解析網址 store（支援 ?store=xxx、/xxx、/s/xxx）
    function getStoreFromURL() {
      const url = new URL(location.href);
      const byQuery = (url.searchParams.get('store') || '').trim();
      if (byQuery) return byQuery;

      const parts = url.pathname.replace(/^\/+/, '').split('/');
      const first = (parts[0] || '').trim().toLowerCase();
      if (!first || first === 'index.html' || first === 'favicon.ico' || first === 'api') return '';
      if (first === 's' && parts[1]) return parts[1].trim();
      return parts[0] || '';
    }

    // 初始可選標籤（先寫死；之後可改從 Sheet 拉）
    const seedTags = [
      '黑糖鹿丸鮮奶','皇家九號奶茶','白桃烏龍','服務超親切','環境很舒服','適合拍照',
      '適合情侶約會','家庭聚餐','朋友小酌','鹹酥雞麵'
    ];

    const $chips = document.getElementById('chips');
    const $storeRow = document.getElementById('storeRow');
    const $storeid = document.getElementById('storeid');
    const $addTag = document.getElementById('addTag');
    const $gen = document.getElementById('gen');
    const $copy = document.getElementById('copy');
    const $output = document.getElementById('output');
    const $status = document.getElementById('status');
    const $storeName = document.getElementById('storeName');
    const $storeLogo = document.getElementById('storeLogo');
    const $openGoogle = document.getElementById('openGoogle');

    let selected = new Set();
    let currentStore = getStoreFromURL() || 'leegarnei'; // 方便開發預設
    let placeId = '';
    let logoUrl = '';

    // 若網址有 store，隱藏 StoreID 列；否則顯示輸入框
    if (getStoreFromURL()) {
      $storeRow.style.display = 'none';
    } else {
      $storeid.value = currentStore;
    }

    function renderChips(list){
      $chips.innerHTML = '';
      list.forEach(tag=>{
        const el = document.createElement('div');
        el.className = 'chip';
        el.textContent = tag;
        el.onclick = () => {
          if(selected.has(tag)) selected.delete(tag);
          else selected.add(tag);
          el.classList.toggle('on');
        };
        $chips.appendChild(el);
      });
    }

    function applyStoreVisual(nameText){
      $storeName.textContent = nameText || currentStore || '門市';
      if (logoUrl) $storeLogo.src = logoUrl; else $storeLogo.removeAttribute('src');

      // 預設「開啟 Google 評論」：若有 placeId 走 writereview，否則搜尋
      if (placeId) {
        $openGoogle.href = `https://search.google.com/local/writereview?placeid=${encodeURIComponent(placeId)}`;
      } else {
        const q = encodeURIComponent(nameText || currentStore || 'Big Way');
        $openGoogle.href = `https://www.google.com/search?q=${q}+google+reviews`;
      }
    }

    async function fetchStoreMeta(){
      try {
        const res = await fetch(`/api/store?storeid=${encodeURIComponent(currentStore)}`);
        if (!res.ok) throw new Error('store meta not found');
        const data = await res.json();
        placeId = data.placeId || '';
        logoUrl = data.logoUrl || '';
        applyStoreVisual(data.name || currentStore);
      } catch(e){
        placeId = '';
        logoUrl = '';
        applyStoreVisual(currentStore);
      }
    }

    renderChips(seedTags);
    fetchStoreMeta();

    // 新增自訂標籤（Enter）
    if ($addTag) {
      $addTag.addEventListener('keydown', e=>{
        if(e.key === 'Enter'){
          const v = $addTag.value.trim();
          if(!v) return;
          if(!seedTags.includes(v)){
            seedTags.unshift(v);
            renderChips(seedTags);
            const chip = [...$chips.children].find(c=>c.textContent===v);
            if(chip){ chip.click(); }
          }
          $addTag.value = '';
        }
      });
    }

    // 使用者手動改 StoreID（只有看得到輸入框時）
    if ($storeid) {
      $storeid.addEventListener('input', ()=>{
        currentStore = ($storeid.value || '').trim();
        placeId = ''; logoUrl = '';
        fetchStoreMeta();
      });
    }

    // 讓產文較不重複的小手段：送一個隨機 style/variant
    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)] }
    const styles = ['溫暖走心','活潑可愛','簡潔俐落','專業中立','真誠自然'];

    async function generate(){
      const storeid = (currentStore || '').trim();
      if(!storeid){
        $status.textContent = '請先指定 StoreID（於網址帶入 ?store=xxx 或在欄位輸入）。';
        return;
      }
      const selectedTags = Array.from(selected);
      // 防呆：至少選 1 個標籤
      if (selectedTags.length === 0) {
        selectedTags.push('整體體驗很棒');
      }

      $gen.disabled = true; $copy.disabled = true;
      const prevTxt = $gen.textContent;
      $gen.textContent = '生成中…';
      $status.textContent = '';

      try{
        const res = await fetch('/api/generate', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            storeid,
            selectedTags,
            variant: pickRandom(styles),    // 👈 增添隨機風格
            nonce: Date.now()               // 👈 加一點隨機性
          })
        });
        const data = await res.json();
        if(!res.ok){
          throw new Error(data?.error || ('HTTP '+res.status));
        }
        $output.value = data.reviewText || JSON.stringify(data, null, 2);
        $status.textContent = `✅ 完成（延遲 ${data.latencyMs ?? '-'} ms）`;

        // 若回傳有 placeId，覆蓋按鈕連結到寫評論視窗
        if (data?.store?.placeId) {
          placeId = data.store.placeId;
          $openGoogle.href = `https://search.google.com/local/writereview?placeid=${encodeURIComponent(placeId)}`;
        }
      }catch(err){
        $output.value = '';
        $status.textContent = '❌ 發生錯誤：' + err.message;
      }finally{
        $gen.disabled = false; $copy.disabled = false;
        $gen.textContent = prevTxt;
      }
    }

    async function copyText(){
      const t = $output.value.trim();
      if(!t){ $status.textContent = '尚無內容可複製'; return; }
      await navigator.clipboard.writeText(t);
      $status.textContent = '📋 已複製到剪貼簿';
    }

    document.getElementById('gen').addEventListener('click', generate);
    document.getElementById('copy').addEventListener('click', copyText);
  </script>
</body>
</html>


