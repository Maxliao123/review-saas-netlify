<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Smart Google Review Â· AI ä¸€å‰‡çŸ­è©•</title>
  <style>
    :root{
      --bg:#F5F7FB; --card:#FFFFFF; --fg:#0F172A; --muted:#64748B;
      --blue:#0A84FF; --blue-600:#0A84FF; --blue-500:#0A84FF; --blue-400:#49A2FF;
      --blue-300:#7CB9FF; --blue-200:#CDE5FF; --blue-100:#EAF4FF; --blue-050:#F3F9FF;
      --blue-hover:#49A2FF; --blue-active:#0A84FF; --on-blue:#FFFFFF;
      --chip-bg:var(--blue-100); --chip-bg-on:var(--blue-500); --chip-fg:#0F172A; --chip-fg-on:#FFFFFF;
      --fs-title-max:22px; --fs-title-min:16px; --fs-body:clamp(13px,1.2vw+10px,16px);
      --fs-chip:clamp(12px,1vw+8px,14px); --fs-btn:clamp(14px,1.2vw+11px,16px);
      --radius-lg:16px; --radius-md:12px; --radius-sm:10px;
      --shadow:0 10px 30px rgba(15,23,42,0.08); --shadow-soft:0 6px 20px rgba(15,23,42,0.06);
      --ring:0 0 0 3px color-mix(in oklab, var(--blue-300) 60%, transparent);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{margin:0; background:var(--bg); color:var(--fg); font:var(--fs-body)/1.55 system-ui,-apple-system,Inter,'PingFang TC','Noto Sans TC',sans-serif;}
    .wrap{max-width:760px; margin:auto; padding:12px;}
    .card{background:var(--card); border-radius:20px; box-shadow:var(--shadow); overflow:hidden; position:relative;}
    .hero-wrap{position:relative;}
    .hero{width:100%; height:220px; object-fit:cover; display:none;}
    @media (max-width:520px){ .hero{height:180px;} }
    .lang-pill{position:absolute; right:12px; top:12px; display:flex; gap:6px; padding:6px; border-radius:999px; background:rgba(15,23,42,.45); backdrop-filter:blur(6px);}
    .lang-pill button{border:0; background:transparent; padding:6px 12px; border-radius:999px; font-weight:700; color:#fff; min-width:42px; font-size:12px; cursor:pointer;}
    .lang-pill button.active{background:#0B1020; color:#fff;}
    .logo-badge{position:absolute; left:50%; bottom:-22px; transform:translateX(-50%); width:64px; height:64px; border-radius:14px; background:#fff; padding:8px; box-shadow:0 10px 30px rgba(15,23,42,.18), 0 2px 6px rgba(15,23,42,.1); display:none;}
    .logo-badge img{width:100%; height:100%; object-fit:contain;}
    @media (max-width:520px){ .logo-badge{width:56px; height:56px; bottom:-20px;} }
    .content{padding:26px 16px 14px; margin-top:14px;}
    .title{margin:0 0 6px 0; font-weight:800; line-height:1.2; font-size:var(--fs-title-max);}
    .sub{color:var(--muted); margin:0 0 10px 0;}
    
    /* "å•å·" å€å¡Šæ¨£å¼ */
    .chip-group {
      margin-bottom: 20px;
    }
    .chip-group:last-child {
      margin-bottom: 12px;
    }
    .chip-group-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--fg);
      margin: 0 0 12px 4px;
    }
    
    .chips{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px;}
    @media (min-width:540px){ .chips{grid-template-columns:repeat(3,minmax(0,1fr));}}
    
    /* Positive chip (unselected) */
    .chip{border-radius:999px; padding:10px 14px; background:var(--chip-bg); color:var(--chip-fg); display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; border:1px solid var(--blue-200); transition:all .15s; box-shadow:var(--shadow-soft); min-height:48px;}
    .chip:hover{transform:translateY(-1px); background:color-mix(in oklab, var(--blue-100) 60%, white);}
    .chip:focus-visible{outline:none; box-shadow:var(--ring);}

    .chip.on,
    .chip-cons.on {
      background:var(--chip-bg-on); 
      color:var(--chip-fg-on); 
      border-color:transparent;
    }
    .chip.on:hover,
    .chip-cons.on:hover {
      background: var(--blue-hover);
      transform: translateY(-1px);
    }
    
    /* Cons chip (unselected) */
    .chip-cons{
      background:var(--chip-bg-cons);
      border-color:var(--chip-bg-cons);
      color:var(--chip-fg-cons);
    }
    .chip-cons:not(.on):hover{
      background:var(--chip-bg-cons);
      transform:translateY(-1px);
    }

    /* âœ… è‡ªå®šç¾©è¼¸å…¥æ¡†æ¨™ç±¤æ¨£å¼ */
    .chip.custom-input {
      background: #fff;
      border: 1px dashed var(--blue-300);
      padding: 0;
      cursor: text;
      overflow: hidden;
    }
    .chip.custom-input:focus-within {
      border-color: var(--blue-500);
      box-shadow: var(--ring);
    }
    .chip.custom-input input {
      width: 100%;
      height: 100%;
      border: none;
      background: transparent;
      text-align: center;
      font-size: var(--fs-chip);
      font-weight: 600;
      color: var(--fg);
      padding: 0 14px;
      outline: none;
    }
    .chip.custom-input input::placeholder {
      color: var(--muted);
      font-weight: 400;
      opacity: 0.7;
    }

    .chip-text{font-size:var(--fs-chip); font-weight:600; text-align:center; line-height:1.25; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;}
    .actions{display:flex; gap:10px; margin:8px 0 8px;}

    .btn{flex:1; height:46px; border:0; border-radius:14px; font-weight:800; font-size:var(--fs-btn); display:flex; align-items:center; justify-content:center; text-align:center; cursor:pointer; box-shadow:var(--shadow-soft); transition:transform .08s, background-color .12s, box-shadow .12s; line-height:1.1; padding:0 18px;}
    .btn.primary{color:var(--on-blue); background:var(--blue-500); box-shadow:0 6px 16px color-mix(in oklab,var(--blue-500) 14%,transparent);}
    .btn.primary:hover{background:var(--blue-hover);}
    .btn.primary:active{transform:translateY(1px); background:var(--blue-active);}
    .btn.secondary{background:#0B1220; color:#fff; min-height:52px; border-radius:16px; display:flex; align-items:center; justify-content:center; line-height:1;}

    .btn{flex:1; height:46px; border:0; border-radius:14px; font-weight:800; font-size:var(--fs-btn); display:flex; align-items:center; justify-content:center; text-align:center; cursor:pointer; box-shadow:var(--shadow-soft); transition:transform .08s, background-color .12s, box-shadow .12s; line-height:1.2;}
    .btn{flex:1; height:46px; border:0; border-radius:14px; font-weight:800; font-size:var(--fs-btn); display:flex; align-items:center; justify-content:center; text-align:center; cursor:pointer; box-shadow:var(--shadow-soft); transition:transform .08s, background-color .12s, box-shadow .12s;}
    .btn.primary{color:var(--on-blue); background:var(--blue-500); box-shadow:0 6px 16px color-mix(in oklab,var(--blue-500) 14%,transparent);}
    .btn.primary:hover{background:var(--blue-hover);}
    .btn.primary:active{transform:translateY(1px); background:var(--blue-active);}
    .btn.secondary{background:#0B1220; color:#fff; height:52px; border-radius:16px; display:flex; align-items:center; justify-content:center;}

    .btn:disabled{opacity:.7; cursor:not-allowed;}
    .spinner{width:18px; height:18px; border:2px solid color-mix(in oklab, var(--on-blue) 45%, transparent); border-top-color:var(--on-blue); border-radius:50%; margin-right:8px; display:none; animation:spin .9s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    textarea{width:100%; margin:0; padding:12px 14px; min-height:120px; border:1px solid var(--blue-200); border-radius:14px; font-size:var(--fs-body); box-shadow:var(--shadow-soft);}

.thanks-notice{
  margin:12px 0 0;
  padding:14px;
  border-radius:var(--radius-md);
  background:#F3F4F6;
  color:#6B7280;
  box-shadow:var(--shadow-soft);
  font-size:14px;
  line-height:1.5;
  text-align:center;
}
    .footer-actions{ display:none; justify-content:center; margin-top:12px; }
    .footer-actions.show{ display:flex; }

    #openGoogle.btn.secondary{
      display:grid !important;
      place-items:center !important;
      height:52px !important;
      padding:0 18px !important;
      line-height:1 !important;
      white-space:nowrap;
    }
    #openGoogle.btn.secondary *{
      margin:0 !important;
      line-height:1 !important;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hero-wrap">
        <img id="hero" class="hero" alt="hero"/>
        <div id="langBar" class="lang-pill" aria-label="language switch"></div>
        <div id="logoBadge" class="logo-badge"><img id="logo" alt="logo"/></div>
      </div>

      <div class="content">
        <h1 id="title" class="title">ç‚ºã€Œ<span id="title-store-name">é–€å¸‚</span>ã€å¯«ä¸€å‰‡çŸ­è©•</h1>
        <p id="subtitle" class="sub">æŒ‘é¸ä»Šå¤©ä½ æœ€æœ‰æ„Ÿçš„å¹¾å€‹é‡é»ï¼Œæˆ‘å€‘æœƒå¹«ä½ æ•´ç†æˆçŸ­è©•ã€‚</p>

        <div id="chip-groups-container"></div>

        <div class="actions">
          <button id="gen" class="btn primary"></button>
        </div>

        <textarea id="output" placeholder="é€™è£¡æœƒé¡¯ç¤ºæ•´ç†å¾Œçš„ä¸€æ®µçŸ­è©•â€¦" style="display:none;"></textarea>

        <div id="footerActions" class="footer-actions">
          <a id="openGoogle" class="btn secondary" target="_blank" rel="noopener noreferrer">ğŸ“‹ è¤‡è£½ä¸¦é–‹å•Ÿgoogleè©•è«–</a>
        </div>

        <div id="thanksNotice" class="thanks-notice" data-keep-thanks="true" style="display:none;">
          <div id="thanksMessage"></div>
        </div>

        <div id="status" class="status" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <script>
  /* ---------- color utils ---------- */
  const hexToRgb=h=>{h=h.replace('#',''); if(h.length===3)h=h.split('').map(c=>c+c).join(''); const n=parseInt(h,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}};
// âœ… æ­£ç¢ºå¯«æ³•
const rgbToHex = (r, g, b) =>
  '#' + [r, g, b].map(v => ('0' + v.toString(16)).slice(-2)).join('');
//                                        â†‘ é€™å€‹ ) è¦åœ¨ slice ä¹‹å¾Œï¼Œjoin åœ¨æ•´å€‹é™£åˆ—å¤–é¢
  function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const M=Math.max(r,g,b),m=Math.min(r,g,b);let h,s,l=(M+m)/2;if(M===m){h=s=0}else{const d=M-m;s=l>0.5?d/(2-M-m):d/(M+m);switch(M){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}h/=6}return{h,s,l}}
  function hslToRgb(h,s,l){let r,g,b;if(s===0){r=g=b=l}else{const q=l<0.5?l*(1+s):l+s-l*s,p=2*l-q,f=t=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p};r=f(h+1/3);g=f(h);b=f(h-1/3)}return{r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255)}}
  const normHex=h=>{if(!h)return'';let s=String(h).trim();if(!s.startsWith('#'))s='#'+s;if(/^#([0-9a-fA-F]{3})$/.test(s)){const[,r,g,b]=s.match(/^#(.)(.)(.)$/);s='#'+r+r+g+g+b+b}return /^#([0-9a-fA-F]{6})$/.test(s)?s.toUpperCase():''};
  const lighten=(hex,d)=>{const {r,g,b}=hexToRgb(hex),hsl=rgbToHsl(r,g,b);hsl.l=Math.max(0,Math.min(1,hsl.l+Math.abs(d)));hsl.s=Math.max(0,Math.min(0.92,hsl.s*1.00));const rgb=hslToRgb(hsl.h,hsl.s,hsl.l);return rgbToHex(rgb.r,rgb.g,rgb.b)}
  const autoOnColor=bg=>{const {r,g,b}=hexToRgb(bg);const L=0.2126*(r/255)+0.7152*(g/255)+0.0722*(b/255);return (L<0.56)?'#FFFFFF':'#0B1220'}
  
  function applyBlueScale(baseHex,onHex){
    const base=normHex(baseHex)||'#0A84FF';
    const on=normHex(onHex)||autoOnColor(base);
    const root=document.documentElement;
    const vars={'--blue-600':base,'--blue-500':base,'--blue-450':lighten(base,.04),'--blue-400':lighten(base,.10),'--blue-300':lighten(base,.20),'--blue-200':lighten(base,.30),'--blue-100':lighten(base,.38),'--blue-050':lighten(base,.45),'--blue-hover':lighten(base,.06),'--blue-active':base,'--on-blue':on};
    Object.entries(vars).forEach(([k,v])=>root.style.setProperty(k,v));
    
    root.style.setProperty('--chip-bg','var(--blue-100)');
    
    root.style.setProperty('--chip-bg-on','var(--blue-450)');
    root.style.setProperty('--chip-fg-on','var(--on-blue)');
    
    root.style.setProperty('--chip-bg-cons', 'var(--blue-050)');
    root.style.setProperty('--chip-fg-cons', 'var(--muted)');
  }

  /* ---------- helpers ---------- */
  function getStoreFromURL(){const url=new URL(location.href);const byQuery=(url.searchParams.get('store')||url.searchParams.get('storeid')||'').trim();if(byQuery)return byQuery;const parts=url.pathname.replace(/^\/+/,'').split('/');const first=(parts[0]||'').trim().toLowerCase();if(!first||first==='index.html'||first==='favicon.ico'||first==='api')return'';if(first==='s'&&parts[1])return(parts[1]||'').trim();return parts[0]||''}
  const uniq=a=>Array.from(new Set((a||[]).map(s=>String(s||'').trim()).filter(Boolean)));
  const pick=(o,...keys)=>{for(const k of keys){const v=o&&o[k];if(v!==undefined&&v!==null&&String(v).trim()!=='')return v}return''}
  const withBuster=u=>(!u?'':(u+(u.includes('?')?'&':'?')+'v='+Date.now()))
  function setImgEl(imgEl,url,fallback,wrapper){const show=ok=>((wrapper||imgEl).style.display= ok?((wrapper||imgEl).classList.contains('hero')?'block':'flex'):'none');const src=url||fallback;if(!src)return show(false);imgEl.onload=()=>show(true);imgEl.onerror=()=>show(false);imgEl.src=withBuster(src)}

  function parseStoreNameMulti(s){
    const out={zh:'',en:'',ko:'',ja:'',fr:'',es:'',_raw:(s||'').trim()}; if(!s) return out;
    const str=String(s).trim();
    if(/[a-z]{2}\s*=/.test(str)){str.split(',').forEach(p=>{const[k,v]=p.split('=');if(!k||!v)return;const kk=k.trim().toLowerCase();const vv=v.trim();if(out.hasOwnProperty(kk))out[kk]=vv});return out;}
    const parts=str.split(',').map(x=>x.trim()).filter(Boolean);
    const isLatin=t=>/[A-Za-z]/.test(t), isKo=t=>/[ê°€-í£]/.test(t), isJa=t=>/[\u3040-\u30ff\u31f0-\u31ff\uFF66-\uFF9D]/.test(t);
    parts.forEach(p=>{ if(!out.en&&isLatin(p)){out.en=p;return} if(!out.ko&&isKo(p)){out.ko=p;return} if(!out.ja&&isJa(p)){out.ja=p;return} if(!out.zh){out.zh=p;return}});
    return out;
  }
  function storeNameForLang(map,lang){
    if(!map) return '';
    const order={zh:['zh','en','ko','ja','fr','es'],en:['en','zh','ko','ja','fr','es'],ko:['ko','zh','en','ja','fr','es'],ja:['ja','zh','en','ko','fr','es'],fr:['fr','en','zh','ko','ja','es'],es:['es','en','zh','ko','ja','fr']}[lang]||['en','zh','ko','ja','fr','es'];
    for(const k of order){const v=(map[k]||'').trim(); if(v) return v} return (map._raw||'').trim();
  }

  // å¤šèªç³» copy
  const LANGS={
    en:{
      label:'EN',
      ui:{title:'How was your experience at "{name}"?',sub:'Select the tags that best match your feelings, and they will be automatically compiled into a Google Review draft for you.',gen:'âœï¸ Generate & Claim Reward',open:'Copy & Open Google',placeholder:'Your summarized review will appear hereâ€¦'},
      customPlaceholder: 'Or type here...',
      customConsPlaceholder: 'Or type another suggestion...'
    },
    zh:{
      label:'ä¸­',
      ui:{title:'ã€Œ{name}ã€çš„ç”¨é¤é«”é©—å¦‚ä½•ï¼Ÿ',sub:'è«‹é»é¸å¹¾å€‹æœ€ç¬¦åˆæ‚¨æ„Ÿå—çš„æ¨™ç±¤ï¼Œå°‡è‡ªå‹•ç‚ºæ‚¨å½™æ•´æˆä¸€ä»½ Google è©•è«–è‰ç¨¿ã€‚',gen:'âœï¸ ç”¢ç”Ÿè©•è«–ä¸¦é ˜å–çå‹µ',open:'ğŸ“‹ è¤‡è£½ä¸¦é–‹å•Ÿgoogleè©•è«–',placeholder:'é€™è£¡æœƒé¡¯ç¤ºæ•´ç†å¾Œçš„ä¸€æ®µçŸ­è©•â€¦'},
      customPlaceholder: 'æˆ–è¼¸å…¥å…¶ä»–é¤é»...',
      customConsPlaceholder: 'æˆ–è¼¸å…¥å…¶ä»–å»ºè­°...'
    },
    ko:{
      label:'í•œêµ­ì–´',
      ui:{title:'â€œ{name}â€ì—ì„œì˜ ê²½í—˜ì€ ì–´ë– ì…¨ë‚˜ìš”?',sub:'ëŠë¼ì‹  ì ê³¼ ê°€ì¥ ì¼ì¹˜í•˜ëŠ” íƒœê·¸ë¥¼ ì„ íƒí•˜ì‹œë©´, Google ë¦¬ë·° ì´ˆì•ˆìœ¼ë¡œ ìë™ ì·¨í•©ë©ë‹ˆë‹¤.',gen:'âœï¸ ì‘ì„± ë° ë¦¬ì›Œë“œ ë°›ê¸°',open:'ğŸ“‹ ë³µì‚¬ ë° Google ì—´ê¸°',placeholder:'ìš”ì•½ëœ ë¦¬ë·°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤â€¦'},
      customPlaceholder: 'ì§ì ‘ ì…ë ¥...',
      customConsPlaceholder: 'ë‹¤ë¥¸ ì œì•ˆì„ ì…ë ¥...'
    },
    ja:{
      label:'æ—¥æœ¬èª',
      ui:{title:'ã€Œ{name}ã€ã§ã®ã”ä½“é¨“ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ',sub:'ã”æ„Ÿæƒ³ã«æœ€ã‚‚è¿‘ã„ã‚¿ã‚°ã‚’ã„ãã¤ã‹é¸æŠã—ã¦ãã ã•ã„ã€‚Google ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ä¸‹æ›¸ããŒè‡ªå‹•çš„ã«ä½œæˆã•ã‚Œã¾ã™ã€‚',gen:'âœï¸ ä½œæˆã—ã¦ç‰¹å…¸ã‚’å—ã‘å–ã‚‹',open:'ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¦ Google ã‚’é–‹ã',placeholder:'è¦ç´„ã—ãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™â€¦'},
      customPlaceholder: 'ãã®ä»–ã‚’å…¥åŠ›...',
      customConsPlaceholder: 'ã»ã‹ã®ææ¡ˆã‚’å…¥åŠ›...'
    },
    fr:{
      label:'FR',
      ui:{title:'Comment Ã©tait votre expÃ©rience chez Â« {name} Â» ?',sub:'SÃ©lectionnez les points qui correspondent Ã  votre ressenti, et ils seront automatiquement compilÃ©s en un brouillon d\'avis Google.',gen:'âœï¸ RÃ©diger & RÃ©compense',open:'ğŸ“‹ Copier & Ouvrir Google',placeholder:'Votre avis synthÃ©tisÃ© sâ€™affichera iciâ€¦'},
      customPlaceholder: 'Ou tapez ici...',
      customConsPlaceholder: 'Ou Ã©crivez une autre suggestion...'
    },
    es:{
      label:'ES',
      ui:{title:'Â¿QuÃ© tal tu experiencia en Â«{name}Â»?',sub:'Elige las etiquetas que mejor describan tu experiencia y se compilarÃ¡n automÃ¡ticamente en un borrador de reseÃ±a de Google.',gen:'âœï¸ Redactar y Reclamar',open:'ğŸ“‹ Copier y Abrir Google',placeholder:'AquÃ­ aparecerÃ¡ tu reseÃ±aâ€¦'},
      customPlaceholder: 'O escriba aquÃ­...',
      customConsPlaceholder: 'O escriba otra sugerencia...'
    }
  };
  
  const CONS_FIELDS = new Set(['consEn','consCn','consKo','consJa','consFr','consEs','cons']);

  const CHIP_GROUPS_CONFIG = [
    {
      id: 'food',
      keys: ['top3', 'newItems'], 
      title: {
        zh: "ä»Šå¤©æœ€æœ‰å°è±¡çš„é¤é»ï¼Ÿ",
        en: "What did you enjoy most about the food?",
        ko: "ì˜¤ëŠ˜ ê°€ì¥ ì¸ìƒ ê¹Šì—ˆë˜ ë©”ë‰´ëŠ” ë¬´ì—‡ì¸ê°€ìš”?",
        ja: "ä»Šæ—¥æœ€ã‚‚å°è±¡ã«æ®‹ã£ãŸãŠæ–™ç†ã¯ï¼Ÿ",
        fr: "Qu'avez-vous le plus apprÃ©ciÃ© dans les plats ?",
        es: "Â¿QuÃ© fue lo que mÃ¡s le gustÃ³ de la comida?"
      }
    },
    {
      id: 'features',
      keys: ['features'],
      title: {
        zh: "æœ‰å“ªäº›è®“ä½ å°è±¡æ·±åˆ»çš„ç‰¹è‰²ï¼Ÿ",
        en: "What features stood out to you?",
        ko: "ì¸ìƒ ê¹Šì—ˆë˜ íŠ¹ì§•ì´ ìˆë‚˜ìš”?",
        ja: "å°è±¡ã«æ®‹ã£ãŸç‰¹å¾´ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
        fr: "Quelles caractÃ©ristiques vous ont marquÃ© ?",
        es: "Â¿QuÃ© caracterÃ­sticas le parecieron notables?"
      }
    },
    {
      id: 'occasion',
      keys: ['ambiance'],
      title: {
        zh: "é€™æ¬¡çš„ç”¨é¤å ´åˆæ˜¯ï¼Ÿ",
        en: "What was the occasion for this visit?",
        ko: "ì´ë²ˆ ë°©ë¬¸ ëª©ì ì€ ë¬´ì—‡ì´ì—ˆë‚˜ìš”?",
        ja: "ä»Šå›ã®åˆ©ç”¨ã‚·ãƒ¼ãƒ³ã¯ï¼Ÿ",
        fr: "Quelle Ã©tait l'occasion de cette visite ?",
        es: "Â¿CuÃ¡l fue el motivo de su visita?"
      }
    },
    {
      id: 'suggestions',
      keys: ['cons'],
      isConsGroup: true,
      title: {
        zh: "æœ‰ä»€éº¼æˆ‘å€‘å¯ä»¥åšå¾—æ›´å¥½çš„åœ°æ–¹ï¼Ÿ(é¸å¡«)",
        en: "Anything we can do better? (Optional)",
        ko: "ê°œì„ í•  ì ì´ ìˆì„ê¹Œìš”? (ì„ íƒ ì‚¬í•­)",
        ja: "æ”¹å–„ã§ãã‚‹ç‚¹ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ (ä»»æ„)",
        fr: "Pouvons-nous nous amÃ©liorer ? (Optionnel)",
        es: "Â¿Hay algo que podamos mejorar? (Opcional)"
      }
    }
  ];

  const $chipGroupsContainer=document.getElementById('chip-groups-container');
  const $gen=document.getElementById('gen');
  const $openGoogle=document.getElementById('openGoogle');
  const $output=document.getElementById('output');
  const $status=document.getElementById('status');
  const $logo=document.getElementById('logo');
  const $logoBadge=document.getElementById('logoBadge');
  const $hero=document.getElementById('hero');
  const $langBar=document.getElementById('langBar');
  const $title=document.getElementById('title');
  const $subtitle=document.getElementById('subtitle');
  const $titleStoreName=document.getElementById('title-store-name');
  const $thanksNotice=document.getElementById('thanksNotice');
  const $thanksMessage=document.getElementById('thanksMessage');

  let selected=new Map();
  let currentStore=getStoreFromURL()||'leegarnei';
  let currentLang='zh';
  let storeMeta=null, availableLangs=[], storeNames=null;
  let googleReviewUrl_global='';
  let isGenerated=false;
  let currentReviewId = null; // â­ ç›®å‰é€™ä¸€å‰‡è©•è«–åœ¨ DB çš„ id

  const genButtonTemplate=()=>`<span class="spinner"></span><span id="btnGen">${LANGS[currentLang].ui.gen}</span>`;

  $openGoogle.style.display='none';

  function applyBasicLinks(nameText){
    $titleStoreName.textContent=nameText||currentStore||'Store';
    const q=encodeURIComponent(currentStore||'Big Way');
    $openGoogle.href='https://www.google.com/search?q='+q+'+google+reviews';
    googleReviewUrl_global=$openGoogle.href;
  }

  function langHasContent(langKey,data){
    if(!data) return false;
    const suffix = (langKey === 'zh') ? 'Cn' : (langKey.charAt(0).toUpperCase() + langKey.slice(1));
    const keysToCheck = ['top3','features','ambiance','newItems','cons', `top3${suffix}`, `features${suffix}`, `ambiance${suffix}`, `newItems${suffix}`, `cons${suffix}`];
    return keysToCheck.some(k => (data[k] || '').trim());
  }

  function buildLangBar(){
    $langBar.innerHTML='';
    availableLangs.forEach(k=>{
      const btn=document.createElement('button');
      btn.textContent=LANGS[k].label; btn.className=(k===currentLang)?'active':'';
      btn.onclick=()=>{currentLang=k; renderUI(); buildLangBar(); buildChipsFromMeta();};
      $langBar.appendChild(btn);
    });
  }

  function fitTitle(){
    const max=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fs-title-max'))||28;
    const min=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fs-title-min'))||18;
    let size=max; $title.style.fontSize=size+'px'; const w=$title.clientWidth;
    while($title.scrollWidth>w && size>min){ size-=1; $title.style.fontSize=size+'px'; }
  }

  function renderUI(){
    const ui=LANGS[currentLang].ui;
    const localizedName=storeNameForLang(storeNames,currentLang)||pick(storeMeta,'name')||currentStore||'Store';
    $title.innerHTML=ui.title.replace('{name}',`<span id="title-store-name">${localizedName}</span>`);
    $subtitle.textContent=ui.sub;
    $gen.innerHTML=genButtonTemplate();
    $openGoogle.textContent=ui.open;
    $output.placeholder=ui.placeholder;

    const thanksCopy={
      zh:'æ„Ÿè¬æ‚¨æä¾›å¯¶è²´å›é¥‹ã€‚<b>è«‹å‡ºç¤ºæ­¤ç•«é¢</b>å³å¯å‘åº—å“¡å…Œæ›',
      en:'Thank you for your feedback. <b>Show this screen</b> to redeem with the staff.',
      ko:'ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤. <b>ì´ í™”ë©´ì„ ì œì‹œ</b>í•˜ì‹œë©´ ì§ì›ì´ ë¦¬ì›Œë“œë¥¼ ë“œë¦½ë‹ˆë‹¤.',
      ja:'ã”æ„è¦‹ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚<b>ã“ã®ç”»é¢ã‚’ã”æç¤º</b>ã„ãŸã ãã¨ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰ç‰¹å…¸ã‚’å—ã‘å–ã‚Œã¾ã™ã€‚',
      fr:'Merci pour votre avis. <b>PrÃ©sentez cet Ã©cran</b> pour lâ€™Ã©changer auprÃ¨s du personnel.',
      es:'Gracias por tu opiniÃ³n. <b>Muestra esta pantalla</b> al personal para canjearla.'
    }[currentLang]||'Thank you for your feedback. <b>Show this screen</b> to redeem with the staff.';
    $thanksMessage.innerHTML=thanksCopy;

    const hasReview = isGenerated && ($output.value||'').trim()!=='';

    $thanksNotice.style.display = hasReview ? 'block' : 'none';
    $output.style.display       = hasReview ? 'block' : 'none';

    const $footerActions = document.getElementById('footerActions');
    if ($footerActions){
      $footerActions.classList.toggle('show', hasReview);
      $openGoogle.style.display = hasReview ? 'block' : 'none';
    }else{
      $openGoogle.style.display = hasReview ? 'block' : 'none';
    }

    $openGoogle.setAttribute('aria-hidden', hasReview ? 'false' : 'true');
    $openGoogle.tabIndex = hasReview ? 0 : -1;

    requestAnimationFrame(fitTitle);
  }

  function buildChipsFromMeta(){
    const data = storeMeta || {};
    $chipGroupsContainer.innerHTML = '';
    selected.clear();
    
    const allTagsRendered = new Set();
    const langSuffix = (currentLang === 'zh') ? 'Cn' : (currentLang.charAt(0).toUpperCase() + currentLang.slice(1));

    CHIP_GROUPS_CONFIG.forEach(group => {
      const isConsGroup = !!group.isConsGroup;

      // æ¯å€‹ group å…§ï¼Œç”¨ Map å»é‡ï¼Œä¸¦åŠ ä¸Š sourceKeyï¼ˆtop3/features/ambiance/newItems/consï¼‰
      const seenInThisGroup = new Map();

      group.keys.forEach(baseKey => {
  // å¦‚æœæœ‰å°æ‡‰èªç³»çš„æ¬„ä½ï¼Œå°±åªç”¨é‚£å€‹ï¼›
  // æ²’æœ‰æ™‚æ‰ fallback ç”¨ baseKeyï¼ˆé€šå¸¸æ˜¯ä¸­æ–‡ï¼‰
  const langKey = baseKey + langSuffix;
  const hasLang = (data[langKey] || '').trim() !== '';
  const keysForLang = hasLang ? [langKey] : [baseKey];

  keysForLang.forEach(key => {
    const raw = data[key] || '';
    if (!raw) return;
    String(raw).split(',').forEach(tag => {
      const t = (tag || '').trim();
      if (!t) return;
      if (!seenInThisGroup.has(t) && !allTagsRendered.has(t)) {
        seenInThisGroup.set(t, {
          tag: t,
          isCons: isConsGroup,
          sourceKey: baseKey
        });
      }
    });
  });
});


      const uniqueTagsData = Array.from(seenInThisGroup.values());
      
      if (uniqueTagsData.length === 0 && group.id !== 'food') {
        return; 
      } else if (uniqueTagsData.length === 0 && group.id === 'food') {
        // food ç¾¤çµ„å°±ç®—æ²’æœ‰é è¨­æ¨™ç±¤ï¼Œä¹Ÿè¦ renderï¼Œå› ç‚ºè¦æ”¾è‡ªè¨‚è¼¸å…¥æ¡†
      }

      const $groupWrapper = document.createElement('div');
      $groupWrapper.className = 'chip-group';
      if (isConsGroup) $groupWrapper.classList.add('cons-group');

      const $groupTitle = document.createElement('h3');
      $groupTitle.className = 'chip-group-title';
      $groupTitle.textContent = group.title[currentLang] || group.title['en'];
      
      const $chipsGrid = document.createElement('div');
      $chipsGrid.className = 'chips';

      uniqueTagsData.forEach(({ tag, isCons, sourceKey }) => {
        allTagsRendered.add(tag); 
        
        const el = document.createElement('div');
        el.className = isCons ? 'chip chip-cons' : 'chip';
        el.innerHTML = `<span class="chip-text">${tag.trim()}</span>`;
        
        el.onclick = () => {
          if (selected.has(tag)) {
            selected.delete(tag);
          } else {
            selected.set(tag, { isCons, sourceKey });
          }
          el.classList.toggle('on');
        };
        $chipsGrid.appendChild(el);
      });

      // food ç¾¤çµ„åŠ ã€Œè‡ªè¨‚é¤é»ã€è¼¸å…¥æ¡†
      if (group.id === 'food') {
        const inputWrapper = document.createElement('div');
        inputWrapper.className = 'chip custom-input';
        
        const inputEl = document.createElement('input');
        inputEl.type = 'text';
        inputEl.id = 'custom-food-input';
        inputEl.placeholder = LANGS[currentLang]?.customPlaceholder || 'Or type here...';
        inputEl.onclick = (e) => e.stopPropagation();

        inputWrapper.appendChild(inputEl);
        $chipsGrid.appendChild(inputWrapper);
      }

      // å»ºè­°ç¾¤çµ„åŠ ã€Œè‡ªè¨‚å»ºè­°ã€è¼¸å…¥æ¡†
      if (isConsGroup) {
        const consInputWrapper = document.createElement('div');
        consInputWrapper.className = 'chip custom-input chip-cons';
        
        const consInputEl = document.createElement('input');
        consInputEl.type = 'text';
        consInputEl.id = 'custom-cons-input';
        consInputEl.placeholder = LANGS[currentLang]?.customConsPlaceholder 
          || LANGS[currentLang]?.customPlaceholder 
          || 'Or type here...';
        consInputEl.onclick = (e) => e.stopPropagation();

        consInputWrapper.appendChild(consInputEl);
        $chipsGrid.appendChild(consInputWrapper);
      }

      $groupWrapper.appendChild($groupTitle);
      $groupWrapper.appendChild($chipsGrid);
      $chipGroupsContainer.appendChild($groupWrapper);
    });
    
    if ($chipGroupsContainer.innerHTML === '') {
       $chipGroupsContainer.innerHTML = `<p style="color:var(--muted); margin:10px 4px;">(${LANGS[currentLang]?.ui?.sub || 'Please select your feedback.'})</p>`;
    }
  }

  function applyThemeFromMeta(d){
    const apiBlue=(pick(d,'themeBlue')||'').trim();
    const apiOn=(pick(d,'themeOnBlue')||'').trim();
    const cssBase=getComputedStyle(document.documentElement).getPropertyValue('--blue').trim()||'#0A84FF';
    applyBlueScale(apiBlue||cssBase,apiOn);
  }

  async function loadStoreMeta(){
    try{
      const res=await fetch('/api/store?storeid='+encodeURIComponent(currentStore));
      const data=await res.json(); if(!res.ok) throw new Error(data?.error||('HTTP '+res.status));
      storeMeta=data; applyThemeFromMeta(data);
      storeNames=parseStoreNameMulti(pick(data,'name','storeName','title')||currentStore);
      applyBasicLinks(storeNameForLang(storeNames,currentLang));
      const order=['zh','en','ko','ja','fr','es']; availableLangs=order.filter(k=>langHasContent(k,data));
      if(availableLangs.length===0) availableLangs=['zh','en']; if(!availableLangs.includes(currentLang)) currentLang=availableLangs[0];
      const heroUrl=pick(data,'heroUrl','cover','banner','placePhotoUrl','photoUrl');
      const logoUrl=pick(data,'logoUrl','logo','image','icon');
      setImgEl($hero,heroUrl,pick(data,'placePhotoUrl','photoUrl'));
      setImgEl($logo,logoUrl,pick(data,'placePhotoUrl','photoUrl'),$logoBadge);
if (data.placeId) {
  const mapsUrl =
    'https://www.google.com/maps/search/?api=1&query=' +
    encodeURIComponent(data.displayName || data.name || '') +
    '&query_place_id=' +
    encodeURIComponent(data.placeId);

  $openGoogle.href = mapsUrl;
  googleReviewUrl_global = mapsUrl;
}
      renderUI(); buildLangBar(); buildChipsFromMeta();
    }catch(e){
      const cssBase=getComputedStyle(document.documentElement).getPropertyValue('--blue').trim()||'#0A84FF';
      applyBlueScale(cssBase,''); storeNames=parseStoreNameMulti(currentStore);
      applyBasicLinks(storeNameForLang(storeNames,currentLang)); renderUI(); buildLangBar(); buildChipsFromMeta();
    }
  }

  (function init(){const cssBase=getComputedStyle(document.documentElement).getPropertyValue('--blue').trim()||'#0A84FF'; applyBlueScale(cssBase,'');})();
  applyBasicLinks('Store'); renderUI(); loadStoreMeta(); addEventListener('resize',()=>requestAnimationFrame(fitTitle));

  // â­ mark likely_posted = true
  async function markAsPosted(reviewId) {
    if (!reviewId) return;
    try {
      await fetch("/.netlify/functions/confirm", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ reviewId })
      });
    } catch (e) {
      console.error("markAsPosted error:", e);
    }
  }

  $openGoogle.addEventListener('click', async (e)=>{
    e.preventDefault();
    const txt = ($output.value || '').trim();
    if (!txt) {
      $status.textContent = 'å°šç„¡å…§å®¹å¯è¤‡è£½';
      return;
    }

    try {
      await markAsPosted(currentReviewId);
    } catch (err) {
      console.error(err);
    }

    try {
      await navigator.clipboard.writeText(txt);
      $status.textContent = '';
    } catch {
      $status.textContent = 'è«‹æ‰‹å‹•è¤‡è£½';
    }

    try {
      window.open(googleReviewUrl_global, '_blank');
    } catch {}
  });


  async function generate(){
    const storeid=(currentStore||'').trim();
    if(!storeid){ $status.textContent=(currentLang==='zh')?'è«‹å…ˆæŒ‡å®š StoreIDã€‚':'Please set StoreID first.'; return; }

    const allSelections = Array.from(selected.entries());

    // å…ˆæ‹†å‡ºæ­£è©• / è² è©• tagsï¼ˆçµ¦ AI ç”¨ï¼‰
    const positiveTags = allSelections
      .filter(([, data]) => !data.isCons)
      .map(([tag]) => tag);

    const consTags = allSelections
      .filter(([, data]) => data.isCons)
      .map(([tag]) => tag);

    // å†ä¾ sourceKey åˆ†åˆ°å„ bucket
    const posTop3Tags = allSelections
      .filter(([, data]) => !data.isCons && data.sourceKey === 'top3')
      .map(([tag]) => tag);

    const posFeaturesTags = allSelections
      .filter(([, data]) => !data.isCons && data.sourceKey === 'features')
      .map(([tag]) => tag);

    const posAmbianceTags = allSelections
      .filter(([, data]) => !data.isCons && data.sourceKey === 'ambiance')
      .map(([tag]) => tag);

    const posNewItemsTags = allSelections
      .filter(([, data]) => !data.isCons && data.sourceKey === 'newItems')
      .map(([tag]) => tag);

    // è‡ªè¨‚è¼¸å…¥
    const customInput = document.getElementById('custom-food-input');
    const customFoodTag = customInput && customInput.value.trim()
      ? customInput.value.trim()
      : '';

    if (customFoodTag) {
      positiveTags.push(customFoodTag);
    }

    const customConsInput = document.getElementById('custom-cons-input');
    const customConsTag = customConsInput && customConsInput.value.trim()
      ? customConsInput.value.trim()
      : '';

    if (customConsTag) {
      consTags.push(customConsTag);
    }

    if(positiveTags.length === 0 && consTags.length === 0){
      $status.textContent={
        en:'Please select at least one tag.',
        zh:'è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ¨™ç±¤ã€‚'
      }[currentLang]||'Please select at least one tag.';
      return;
    }

    const tagBuckets = {
      posTop3: posTop3Tags,
      posFeatures: posFeaturesTags,
      posAmbiance: posAmbianceTags,
      posNewItems: posNewItemsTags,
      customFood: customFoodTag || null,
      cons: consTags,
      customCons: customConsTag || null,
    };
    
    const body={
      storeid,
      positiveTags,
      consTags,
      variant:1, minChars:90, maxChars:160, lang:currentLang,
      tagBuckets
    };

    $gen.classList.add('loading'); $gen.disabled=true;
    $gen.innerHTML=`<span class="spinner"></span>${{en:'Composingâ€¦',zh:'æ’°å¯«ä¸­â€¦'}[currentLang]||'Composingâ€¦'}`;
    $status.textContent='';

    try{
      const res=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
      const data=await res.json(); if(!res.ok) throw new Error(data?.error||('HTTP '+res.status));

      currentReviewId = data.reviewId || null;

      const reviewText=data.reviewText||''; $output.value=reviewText;
    if (data?.store?.placeId) {
  const mapsUrl =
    'https://www.google.com/maps/search/?api=1&query=' +
    encodeURIComponent(data.store.name || '') +
    '&query_place_id=' +
    encodeURIComponent(data.store.placeId);

  googleReviewUrl_global = mapsUrl;
  $openGoogle.href = mapsUrl;
}

      isGenerated=true;
      renderUI();

    }catch(err){
      $status.textContent=({zh:'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š',en:'âŒ Error: '}[currentLang]||'âŒ Error: ')+err.message;
    }finally{
      $gen.classList.remove('loading'); $gen.disabled=false; $gen.innerHTML=genButtonTemplate();
    }
  }

  document.getElementById('gen').addEventListener('click', generate);
  </script>

  <script>
  (function hotfix(){
    const $chipContainer = document.getElementById('chip-groups-container');
    const output = document.getElementById('output');
    const openBtn = document.getElementById('openGoogle');
    const status = document.getElementById('status');

    if ($chipContainer) {
      const mo = new MutationObserver(()=>{
        $chipContainer.style.display='block';
        $chipContainer.hidden=false;
      });
      mo.observe(document.body,{childList:true,subtree:true});
    }

    const _open = window.open;
    window.open = function(url, target, features){
      const fromBtn = (document.activeElement === openBtn) || (url && String(url).includes('writereview'));
      return fromBtn ? _open.call(window, url, target, features) : null;
    };

    const killThanks = ()=>{
      document.querySelectorAll('*').forEach(el=>{
        const t=(el.textContent||'').trim();
        const keep = el.closest('[data-keep-thanks="true"]');
        if ((t.includes('æ„Ÿè¬æ‚¨çš„å›é¥‹') || t.includes('æˆ‘å€‘å·²ç‚ºæ‚¨é–‹å•Ÿ Google è©•è«–åˆ†é ')) && !keep) {
          if ($chipContainer && !el.contains($chipContainer) && el.remove) el.remove();
        }
      });
    };
    new MutationObserver(killThanks).observe(document.body,{childList:true,subtree:true});
    killThanks();

    // hotfix è£¡é€™å€‹ click handler åªè™•ç†ç€è¦½å™¨é™åˆ¶ï¼Œä¸å½±éŸ¿ä¸Šé¢é‚£å€‹ markAsPosted
    openBtn && openBtn.addEventListener('click', async (e)=>{
      e.preventDefault();
      const txt=(output.value||'').trim();
      if(!txt){ status && (status.textContent='å°šç„¡å…§å®¹å¯è¤‡è£½'); return; }
      try{ await navigator.clipboard.writeText(txt); status && (status.textContent=''); }catch{ status && (status.textContent='è«‹æ‰‹å‹•è¤‡è£½'); }
      try{ _open.call(window, window.googleReviewUrl_global || openBtn.href, '_blank'); }catch{}
    }, { capture:false });
  })();
  </script>
</body>
</html>


