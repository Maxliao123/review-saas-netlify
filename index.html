<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Smart Google Review Â· AI ä¸€å‰‡çŸ­è©•</title>
  <style>
    :root{
      /* ===== Cupertino palette (å–®ä¸€ä¸»è‰² + ä¸­æ€§è‰²) ===== */
      --bg:#f6f7f9;          /* ç³»çµ±åº•è‰² */
      --card:#ffffff;        /* å¡ç‰‡åº•è‰² */
      --fg:#0f172a;          /* ä¸»è¦æ–‡å­— (slate-900) */
      --muted:#667085;       /* æ¬¡è¦æ–‡å­— */
      --tint:#0a84ff;        /* iOS ç³»çµ±è— */
      --tint-700:#0668c8;    /* æ·±æŒ‰ */
      --tint-50:#e6f0ff;     /* æ·ºåº• */
      --chip:#ecf3ff;        /* æœªé¸ä¸­æ¨™ç±¤åº• */
      --chip-on:#0a84ff;     /* å·²é¸ä¸­æ¨™ç±¤åº• */
      --chip-on-fg:#fff;

      /* æ’ç‰ˆå°ºå¯¸ï¼ˆå£“ç¸®å‚ç›´ç©ºé–“ï¼‰ */
      --fs-h1: clamp(20px, 2.4vw + 12px, 28px);
      --fs-h1b: clamp(18px, 2.0vw + 10px, 24px); /* åº—åè¡Œ */
      --fs-body: clamp(14px, 1.1vw + 10px, 16px);
      --fs-chip: clamp(13px, 1.0vw + 9px, 15px);
      --fs-btn:  clamp(15px, 1.1vw + 10px, 17px);

      --radius:14px;
      --radius-lg:18px;
      --shadow:0 4px 16px rgba(0,0,0,.08);
      --shadow-strong:0 10px 30px rgba(0,0,0,.16);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{margin:0; background:var(--bg); color:var(--fg); font:var(--fs-body)/1.5 ui-sans-serif,system-ui,'Inter','SF Pro Text','PingFang TC','Noto Sans TC',sans-serif;}
    .wrap{max-width:720px; margin:auto; padding:12px;}
    .card{background:var(--card); border-radius:20px; box-shadow:var(--shadow); overflow:hidden; position:relative;}

    /* ===== HERO + æµ®å±¤ ===== */
    .hero-wrap{position:relative;}
    .hero{width:100%; height:200px; object-fit:cover; display:block;}
    @media (max-width:520px){ .hero{height:168px;} }

    /* èªè¨€è† å›Šï¼ˆå›ºå®šå³ä¸Šï¼‰ */
    .lang-pill{
      position:absolute; right:12px; top:12px;
      display:flex; gap:6px; padding:4px; border-radius:999px;
      background:rgba(16,18,27,.46); backdrop-filter:blur(6px);
    }
    .lang-pill button{
      border:0; background:transparent; padding:6px 10px; border-radius:999px;
      font-weight:700; cursor:pointer; color:#fff; min-width:40px; font-size:12px;
    }
    .lang-pill button.active{background:#0b1220; color:#fff;}

    /* Logo å¾½ç« ï¼šç½®ä¸­è·¨ç•Œ */
    .logo-badge{
      position:absolute; left:50%; bottom:-22px; transform:translateX(-50%);
      width:60px; height:60px; border-radius:16px; object-fit:cover; display:none;
      background:#fff; padding:8px; box-shadow:var(--shadow-strong);
    }
    @media (max-width:520px){ .logo-badge{width:56px; height:56px; bottom:-20px;} }

    /* ===== å…§å®¹å€ ===== */
    .content{padding:22px 14px 14px; margin-top:12px;} /* è®“å‡ºå¾½ç« ç©ºé–“ + å£“ç¸®å‚ç›´ */
    .title-wrap{margin:0 0 8px 0;}
    .h1{margin:0 0 6px 0; font-weight:800; font-size:var(--fs-h1); line-height:1.22;}
    .h1b{margin:0; font-weight:800; font-size:var(--fs-h1b); line-height:1.25; color:#1f2937;}
    .sub{color:var(--muted); margin:6px 0 12px 0;}

    /* æ¨™ç±¤ç¶²æ ¼ï¼šæ‰‹æ©Ÿ 2 æ¬„ï¼Œæ¡Œé¢ 3 æ¬„ï¼›å…©è¡Œå­—å›ºå®šé«˜åº¦ */
    #chips{ display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:10px; }
    @media (max-width:640px){ #chips{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
    .chip{
      display:flex; align-items:center; justify-content:center; text-align:center;
      padding:10px 12px; border-radius:999px; background:var(--chip);
      color:#0f172a; cursor:pointer; font-size:var(--fs-chip); font-weight:700;
      min-height:56px; max-height:56px; line-height:1.15;
      box-shadow:inset 0 0 0 1px rgba(10,132,255,.15);
      transition:transform .06s ease, background .15s ease, color .15s ease, box-shadow .15s ease;
    }
    .chip:active{ transform:translateY(1px); }
    .chip.on{ background:var(--chip-on); color:var(--chip-on-fg); box-shadow:none; }
    .chip > span{ display:block; white-space:normal; word-break:break-word; max-width:100%;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

    /* å‹•ä½œæŒ‰éˆ•åˆ—ï¼šç·Šæ¹Š */
    .actions{display:flex; gap:10px; margin:12px 0 10px;}
    .btn{
      flex:1; height:46px; border:0; border-radius:14px; font-weight:800;
      font-size:var(--fs-btn); display:flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .btn.primary{
      color:#fff; background:linear-gradient(180deg, #0a84ff, #096fe6);
      box-shadow:0 6px 16px rgba(10,132,255,.28), inset 0 -1px 0 rgba(255,255,255,.2);
    }
    .btn.primary:active{ background:linear-gradient(180deg, #096fe6, #085ec2); }
    .btn.secondary{background:#f3f5f8; color:#185adb; box-shadow:inset 0 0 0 1px rgba(10,132,255,.18);}
    .btn.secondary:active{ background:#e9eef6; }
    .btn:disabled{opacity:.75; cursor:not-allowed;}
    .spinner{width:18px; height:18px; border:2px solid rgba(255,255,255,.45);
      border-top-color:#fff; border-radius:50%; margin-right:8px; display:none; animation:spin .9s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn.loading .spinner{display:inline-block;}

    /* æ–‡æœ¬æ¡†ï¼šé è¨­åŠ é«˜ï¼Œèšç„¦å†åŠ é«˜ï¼Œåœ“è§’èˆ‡æé‚Šä¸€è‡´ */
    textarea{
      width:100%; padding:12px; border:1px solid #d9e2f1; border-radius:16px;
      font-size:var(--fs-body); min-height:120px; transition:min-height .15s ease, border-color .15s ease, box-shadow .15s ease;
      outline:none; box-shadow:inset 0 1px 0 rgba(255,255,255,.5), 0 0 0 0 rgba(10,132,255,.2);
    }
    textarea:focus{ min-height:160px; border-color:rgba(10,132,255,.55); box-shadow:0 0 0 4px rgba(10,132,255,.15); }

    .footer-actions{display:flex; justify-content:center; margin-top:12px;}
    .anchor{ width:100%; height:54px; border-radius:18px; display:flex; align-items:center; justify-content:center;
      background:#0b1220; color:#fff; text-decoration:none; font-weight:800; box-shadow:var(--shadow); }
    .anchor span{ text-decoration:underline; }
    .status{color:var(--muted); font-size:12px; text-align:center; padding:10px 0 6px;}

    /* åªæœ‰æ²’å¸¶ store åƒæ•¸æ™‚æ‰é¡¯ç¤ºï¼ˆç›¸å®¹ï¼‰ */
    #storeRow{display:none;}
    .row{display:flex; flex-wrap:wrap; gap:6px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- HERO + æµ®å±¤ -->
      <div class="hero-wrap">
        <img id="hero" class="hero" alt="hero" onerror="this.style.display='none'"/>
        <img id="logo" class="logo-badge" alt="logo" onerror="this.style.display='none'"/>
        <div id="langBar" class="lang-pill" aria-label="language switch"></div>
      </div>

      <div class="content">
        <!-- å…©æ®µå¼æ¨™é¡Œï¼šå‹•ä½œå¥ + åº—åè¡Œï¼ˆé•·åå®Œæ•´é¡¯ç¤ºï¼‰ -->
        <div class="title-wrap">
          <h1 id="titleAction" class="h1">ç‚ºé€™å®¶åº—å¯«ä¸€å‰‡çŸ­è©•</h1>
          <p id="titleName" class="h1b">ã€Œ<span id="title-store-name">é–€å¸‚</span>ã€</p>
        </div>

        <p id="subtitle" class="sub">æŒ‘é¸ä»Šå¤©ä½ æœ€æœ‰æ„Ÿçš„é‡é»ï¼Œé»ä¸€ä¸‹ä¸‹æ–¹æŒ‰éˆ•ï¼Œæˆ‘å€‘æœƒå¹«ä½ æ•´ç†æˆçŸ­è©•ã€‚</p>

        <div id="storeRow" class="row" style="margin-bottom:10px;">
          <div class="field"><label class="status" id="labStore">StoreIDï¼š</label><input id="store-input" placeholder="leegarnei" /></div>
          <div class="field"><label class="status" id="labAddTag">æ–°å¢æ¨™ç±¤ï¼š</label><input id="addTag" placeholder="è¼¸å…¥å¾ŒæŒ‰ Enter" /></div>
        </div>

        <div id="chips"></div>

        <div class="actions">
          <button id="gen" class="btn primary"><span class="spinner"></span><span id="btnGen">âœï¸ å¹«æˆ‘æ’°å¯«</span></button>
          <button id="copy" class="btn secondary"><span id="btnCopy">ğŸ“‹ è¤‡è£½</span></button>
        </div>

        <textarea id="output" placeholder="é€™è£¡æœƒé¡¯ç¤ºæ•´ç†å¾Œçš„ä¸€æ®µçŸ­è©•â€¦"></textarea>

        <div class="footer-actions">
          <a id="openGoogle" class="anchor" target="_blank" rel="noopener noreferrer">ğŸ” <span id="btnOpen" style="margin-left:6px;">é–‹å•Ÿ Google è©•è«–</span></a>
        </div>

        <div id="status" class="status" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <script>
    /* ===== å·¥å…· ===== */
    function getStoreFromURL() {
      const url = new URL(location.href);
      const byQuery = (url.searchParams.get('store') || url.searchParams.get('storeid') || '').trim();
      if (byQuery) return byQuery;
      const parts = url.pathname.replace(/^\/+/, '').split('/');
      const first = (parts[0] || '').trim().toLowerCase();
      if (!first || first === 'index.html' || first === 'favicon.ico' || first === 'api') return '';
      if (first === 's' && parts[1]) return (parts[1] || '').trim();
      return parts[0] || '';
    }
    function uniq(arr){ const out=[], seen={}; arr.forEach(s=>{ s=(s||'').trim(); if(s && !seen[s]){ seen[s]=1; out.push(s);} }); return out; }
    function withBuster(u){ if(!u) return ''; const sep = u.includes('?') ? '&':'?'; return u + sep + 'v=' + Date.now(); }
    function setImg(img, primary, fallback){
      if (primary) {
        img.onerror = function(){
          if (fallback && img.src !== fallback) { img.onerror = function(){ img.style.display='none'; }; img.src = withBuster(fallback); }
          else { img.style.display='none'; }
        };
        img.src = withBuster(primary); img.style.display='block'; return;
      }
      if (fallback) { img.onerror=function(){img.style.display='none'}; img.src=withBuster(fallback); img.style.display='block'; return; }
      img.style.display='none';
    }

    /* ===== å¤šèªè¨­å®š ===== */
    const LANGS = {
      en:{label:'EN', chips:['top3En','featuresEn','ambianceEn','newItemsEn'],
        ui:{
          action:'Write a short review',
          nameTitle:'â€œ{name}â€',
          sub:'Pick what stood out today, then tap the button â€” weâ€™ll help you turn it into a short review.',
          store:'StoreID:', addtag:'Add tag:',
          gen:'âœï¸ Compose', copy:'ğŸ“‹ Copy', open:'Open Google Reviews',
          placeholder:'Your summarized review will appear hereâ€¦',
          loading:'Composingâ€¦', done:'âœ… Done (latency ', err:'âŒ Error: '
        }},
      zh:{label:'ä¸­', chips:['top3Cn','featuresCn','ambianceCn','newItemsCn'],
        ui:{
          action:'ç‚ºé€™å®¶åº—å¯«ä¸€å‰‡çŸ­è©•',
          nameTitle:'ã€Œ{name}ã€',
          sub:'æŒ‘é¸ä»Šå¤©ä½ æœ€æœ‰æ„Ÿçš„é‡é»ï¼Œé»ä¸€ä¸‹ä¸‹æ–¹æŒ‰éˆ•ï¼Œæˆ‘å€‘æœƒå¹«ä½ æ•´ç†æˆçŸ­è©•ã€‚',
          store:'StoreIDï¼š', addtag:'æ–°å¢æ¨™ç±¤ï¼š',
          gen:'âœï¸ å¹«æˆ‘æ’°å¯«', copy:'ğŸ“‹ è¤‡è£½', open:'é–‹å•Ÿ Google è©•è«–',
          placeholder:'é€™è£¡æœƒé¡¯ç¤ºæ•´ç†å¾Œçš„ä¸€æ®µçŸ­è©•â€¦',
          loading:'æ’°å¯«ä¸­â€¦', done:'âœ… å®Œæˆï¼ˆå»¶é² ', err:'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š'
        }},
      ko:{label:'í•œêµ­ì–´', chips:['top3Ko','featuresKo','ambianceKo','newItemsKo'],
        ui:{
          action:'í•œ ì¤„ ë¦¬ë·° ì‘ì„±',
          nameTitle:'â€œ{name}â€',
          sub:'ì˜¤ëŠ˜ ì¸ìƒ ê¹Šì—ˆë˜ í¬ì¸íŠ¸ë¥¼ ê³ ë¥¸ ë’¤ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, í•œ ì¤„ ë¦¬ë·°ë¡œ ì •ë¦¬í•´ ë“œë ¤ìš”.',
          store:'StoreID:', addtag:'íƒœê·¸ ì¶”ê°€:',
          gen:'âœï¸ ì‘ì„±', copy:'ğŸ“‹ ë³µì‚¬', open:'Google ë¦¬ë·° ì—´ê¸°',
          placeholder:'ìš”ì•½ëœ ë¦¬ë·°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤â€¦',
          loading:'ì‘ì„± ì¤‘â€¦', done:'âœ… ì™„ë£Œ(ì§€ì—° ', err:'âŒ ì˜¤ë¥˜: '
        }},
      ja:{label:'æ—¥æœ¬èª', chips:['top3Ja','featuresJa','ambianceJa','newItemsJa'],
        ui:{
          action:'ä¸€è¨€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ã',
          nameTitle:'ã€Œ{name}ã€',
          sub:'ä»Šæ—¥å°è±¡ã«æ®‹ã£ãŸãƒã‚¤ãƒ³ãƒˆã‚’é¸ã‚“ã§ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ä¸€è¨€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã¾ã¨ã‚ã¾ã™ã€‚',
          store:'StoreID:', addtag:'ã‚¿ã‚°è¿½åŠ ï¼š',
          gen:'âœï¸ ä½œæˆ', copy:'ğŸ“‹ ã‚³ãƒ”ãƒ¼', open:'Google å£ã‚³ãƒŸã‚’é–‹ã',
          placeholder:'è¦ç´„ã—ãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™â€¦',
          loading:'ä½œæˆä¸­â€¦', done:'âœ… å®Œäº†ï¼ˆé…å»¶ ', err:'âŒ ã‚¨ãƒ©ãƒ¼: '
        }},
      fr:{label:'FR', chips:['top3Fr','featuresFr','ambianceFr','newItemsFr'],
        ui:{
          action:'RÃ©diger un court avis',
          nameTitle:'Â« {name} Â»',
          sub:'Choisissez ce qui vous a marquÃ© aujourdâ€™hui, puis touchez le bouton â€” on le rÃ©sume en un court avis.',
          store:'StoreID:', addtag:'Nouveau tag :',
          gen:'âœï¸ RÃ©diger', copy:'ğŸ“‹ Copier', open:'Ouvrir les avis Google',
          placeholder:'Votre avis synthÃ©tisÃ© sâ€™affichera iciâ€¦',
          loading:'RÃ©dactionâ€¦', done:'âœ… TerminÃ© (latence ', err:'âŒ Erreur : '
        }},
      es:{label:'ES', chips:['top3Es','featuresEs','ambianceEs','newItemsEs'],
        ui:{
          action:'Escribe una reseÃ±a breve',
          nameTitle:'Â«{name}Â»',
          sub:'Elige lo que mÃ¡s te llamÃ³ la atenciÃ³n y pulsa el botÃ³n: lo convertimos en una reseÃ±a breve.',
          store:'StoreID:', addtag:'AÃ±adir etiqueta:',
          gen:'âœï¸ Redactar', copy:'ğŸ“‹ Copiar', open:'Abrir reseÃ±as de Google',
          placeholder:'AquÃ­ aparecerÃ¡ tu reseÃ±a resumidaâ€¦',
          loading:'Redactandoâ€¦', done:'âœ… Listo (latencia ', err:'âŒ Error: '
        }},
    };

    /* ===== DOM & ç‹€æ…‹ ===== */
    const $chips = document.getElementById('chips');
    const $storeRow = document.getElementById('storeRow');
    const $storeInput = document.getElementById('store-input');
    const $addTag = document.getElementById('addTag');
    const $gen = document.getElementById('gen');
    const $copy = document.getElementById('copy');
    const $output = document.getElementById('output');
    const $status = document.getElementById('status');
    const $openGoogle = document.getElementById('openGoogle');
    const $logo = document.getElementById('logo');
    const $hero = document.getElementById('hero');
    const $langBar = document.getElementById('langBar');
    const $titleAction = document.getElementById('titleAction');
    const $titleName = document.getElementById('titleName');
    const $subtitle = document.getElementById('subtitle');
    const $btnGen = document.getElementById('btnGen');
    const $btnCopy = document.getElementById('btnCopy');
    const $btnOpen = document.getElementById('btnOpen');
    const $titleStoreName = document.getElementById('title-store-name');

    let selected = new Set();
    let currentStore = getStoreFromURL() || 'leegarnei';
    let currentLang = 'zh';
    let storeMeta = null;
    let availableLangs = [];
    let storeNames = null;

    if (!getStoreFromURL()) { $storeRow.style.display='flex'; if ($storeInput) $storeInput.value=currentStore; }

    function applyBasicLinks(nameText){
      $titleStoreName.textContent = nameText || currentStore || 'Store';
      const q = encodeURIComponent(currentStore || 'Big Way');
      $openGoogle.href = 'https://www.google.com/search?q=' + q + '+google+reviews';
    }

    /* å¤šèªåº—åè§£æ */
    function parseStoreNameMulti(s){
      const out = { zh:'', en:'', ko:'', ja:'', fr:'', es:'', _raw:(s||'').trim() };
      if (!s) return out;
      const str = String(s).trim();
      const hasEq = /[a-z]{2}\s*=/.test(str);
      if (hasEq) {
        str.split(',').forEach(pair=>{
          const [kRaw,vRaw] = pair.split('=');
          if (!kRaw || !vRaw) return;
          const k = kRaw.trim().toLowerCase();
          const v = vRaw.trim();
          if (['zh','en','ko','ja','fr','es'].includes(k)) out[k] = v;
        });
        return out;
      }
      const parts = str.split(',').map(x=>x.trim()).filter(Boolean);
      const isLatin = t => /[A-Za-z]/.test(t);
      const isKorean = t => /[ê°€-í£]/.test(t);
      const isJapanese = t => /[\u3040-\u30ff\u31f0-\u31ff\uFF66-\uFF9D]/.test(t);
      parts.forEach(p=>{
        if (!out.en && isLatin(p)) { out.en = p; return; }
        if (!out.ko && isKorean(p)) { out.ko = p; return; }
        if (!out.ja && isJapanese(p)) { out.ja = p; return; }
        if (!out.zh) { out.zh = p; return; }
      });
      return out;
    }
    function storeNameForLang(nameMap, lang){
      if (!nameMap) return '';
      const tryOrder = {
        zh: ['zh','en','ko','ja','fr','es'],
        en: ['en','zh','ko','ja','fr','es'],
        ko: ['ko','zh','en','ja','fr','es'],
        ja: ['ja','zh','en','ko','fr','es'],
        fr: ['fr','en','zh','ko','ja','es'],
        es: ['es','en','zh','ko','ja','fr'],
      }[lang] || ['en','zh','ko','ja','fr','es'];
      for (const code of tryOrder) {
        const v = (nameMap[code]||'').trim();
        if (v) return v;
      }
      return (nameMap._raw || '').trim();
    }

    /* èªè¨€èˆ‡ Chips */
    function langHasContent(langKey, data){
      const cfg = LANGS[langKey]; if(!cfg) return false;
      return cfg.chips.some(k => (data[k]||'').trim());
    }
    function buildLangBar(){
      $langBar.innerHTML = '';
      availableLangs.forEach(k=>{
        const btn = document.createElement('button');
        btn.textContent = LANGS[k].label;
        btn.className = (k===currentLang)?'active':'';
        btn.onclick = ()=>{
          currentLang = k;
          renderUI();
          buildLangBar();
          buildChipsFromMeta();
        };
        $langBar.appendChild(btn);
      });
    }
    function renderUI(){
      const ui = LANGS[currentLang].ui;
      const name = storeNameForLang(storeNames, currentLang) || storeMeta?.name || currentStore || 'Store';
      $titleAction.textContent = ui.action;
      $titleName.innerHTML = ui.nameTitle.replace('{name}', `<span id="title-store-name">${name}</span>`);
      $subtitle.textContent = ui.sub;
      document.getElementById('labStore')?.textContent = ui.store || 'StoreID:';
      document.getElementById('labAddTag')?.textContent = ui.addtag || 'Add tag:';
      $btnGen.textContent = ui.gen;
      $btnCopy.textContent = ui.copy;
      $btnOpen.textContent = ui.open;
      $output.placeholder = ui.placeholder;
    }
    function buildChipsFromMeta(){
      const cfg = LANGS[currentLang]; const data = storeMeta || {};
      let tags = [];
      cfg.chips.forEach(k=>{ if(data[k]) tags = tags.concat(String(data[k]).split(',')); });
      tags = uniq(tags).slice(0,18);
      if (tags.length===0){
        if (currentLang!=='en' && storeMeta && langHasContent('en', storeMeta)){
          currentLang='en'; renderUI(); buildLangBar(); return buildChipsFromMeta();
        }
        tags = ['boba','rice','dumpling','Nice service','clean environment','Couple date','family reunion','Fried noodles'];
      }
      selected.clear();
      $chips.innerHTML = '';
      tags.forEach(tag=>{
        const el = document.createElement('div');
        el.className='chip'; el.innerHTML=`<span>${tag.trim()}</span>`;
        el.onclick=()=>{ if(selected.has(tag)) selected.delete(tag); else selected.add(tag); el.classList.toggle('on'); };
        $chips.appendChild(el);
      });
    }

    /* è¼‰å…¥åº—å®¶ meta */
    async function loadStoreMeta(){
      try{
        const res = await fetch('/api/store?storeid=' + encodeURIComponent(currentStore));
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || ('HTTP '+res.status));
        storeMeta = data;
        storeNames = parseStoreNameMulti(data.name || '');

        applyBasicLinks(storeNameForLang(storeNames, currentLang) || data.name || currentStore);

        const order = ['en','zh','ko','fr','ja','es'];
        availableLangs = order.filter(k => langHasContent(k, data));
        if (availableLangs.length===0) availableLangs = ['en'];
        if (!availableLangs.includes(currentLang)) currentLang = availableLangs[0];

        setImg($logo, data.logoUrl, data.placePhotoUrl);
        setImg($hero, data.heroUrl, data.placePhotoUrl);
        $logo.style.display = 'block';

        if (data.placeId) $openGoogle.href = 'https://search.google.com/local/writereview?placeid=' + encodeURIComponent(data.placeId);

        renderUI(); buildLangBar(); buildChipsFromMeta();
      }catch(e){
        console.error('loadStoreMeta error:', e);
        applyBasicLinks('Store'); $logo.style.display='none'; $hero.style.display='none';
        renderUI(); buildLangBar(); buildChipsFromMeta();
      }
    }

    // ç›¸å®¹ï¼šæ‰‹å‹•è¼¸å…¥ StoreID
    const $storeInputEl = document.getElementById('store-input');
    if ($storeInputEl) $storeInputEl.addEventListener('input', ()=>{ currentStore = ($storeInputEl.value||'').trim(); applyBasicLinks(); });

    // æ–°å¢è‡ªè¨‚æ¨™ç±¤
    if ($addTag) $addTag.addEventListener('keydown', e=>{
      if (e.key==='Enter'){
        const v = ($addTag.value||'').trim(); if(!v) return;
        const el = document.createElement('div'); el.className='chip on'; el.innerHTML=`<span>${v}</span>`;
        selected.add(v); el.onclick=()=>{ if(selected.has(v)) selected.delete(v); else selected.add(v); el.classList.toggle('on'); };
        $chips.prepend(el); $addTag.value='';
      }
    });

    // åˆå§‹åŒ–
    applyBasicLinks('Store'); loadStoreMeta();

    /* ç”¢ç”Ÿ / è¤‡è£½ */
    async function generate(){
      const storeid = (currentStore || '').trim();
      if (!storeid){ $status.textContent = (currentLang==='zh')?'è«‹å…ˆæŒ‡å®š StoreIDã€‚':'Please set StoreID first.'; return; }
      const selectedTags = Array.from(selected);
      const body = { storeid, selectedTags, lang: currentLang, variant:1, minChars:90, maxChars:160 };

      const loadingLabel = LANGS[currentLang].ui.loading || 'Generatingâ€¦';
      $gen.classList.add('loading'); $gen.disabled=true; $copy.disabled=true;
      const prev = $gen.innerHTML; $gen.innerHTML = '<span class="spinner"></span>' + loadingLabel;
      $status.textContent='';

      try{
        const res = await fetch('/api/generate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || ('HTTP '+res.status));
        $output.value = data.reviewText || JSON.stringify(data,null,2);
        const okText = (LANGS[currentLang].ui.done || 'âœ… Done (latency ') + (data.latencyMs || '-') + ' ms)';
        $status.textContent = okText;
        if (data?.store?.placeId) $openGoogle.href = 'https://search.google.com/local/writereview?placeid=' + encodeURIComponent(data.store.placeId);
      }catch(err){
        $output.value='';
        $status.textContent = (LANGS[currentLang].ui.err || 'âŒ Error: ') + err.message;
      }finally{
        $gen.classList.remove('loading'); $gen.disabled=false; $copy.disabled=false; $gen.innerHTML = prev;
      }
    }
    async function copyText(){
      const t = ($output.value||'').trim();
      const msgOK = { en:'ğŸ“‹ Copied to clipboard', zh:'ğŸ“‹ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', ko:'ğŸ“‹ ë³µì‚¬ ì™„ë£Œ', ja:'ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼', fr:'ğŸ“‹ CopiÃ©', es:'ğŸ“‹ Copiado' }[currentLang];
      const msgNG = { en:'Please copy manually', zh:'è«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½', ko:'ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ ì£¼ì„¸ìš”', ja:'æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„', fr:'Copiez manuellement', es:'Copia manualmente' }[currentLang];
      if(!t){ $status.textContent = { en:'Nothing to copy', zh:'å°šç„¡å…§å®¹å¯è¤‡è£½', ko:'ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤', ja:'ã‚³ãƒ”ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“', fr:'Rien Ã  copier', es:'Nada para copiar' }[currentLang]; return; }
      try{ await navigator.clipboard.writeText(t); $status.textContent = msgOK; }
      catch{ $status.textContent = msgNG; }
    }
    document.getElementById('gen').addEventListener('click', generate);
    document.getElementById('copy').addEventListener('click', copyText);
  </script>
</body>
</html>




