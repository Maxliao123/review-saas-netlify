<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Smart Google Review · AI 一則短評</title>
  <style>
    :root{
      --bg:#f6f8fa; --card:#fff; --fg:#1f2937; --muted:#6b7280;
      --pri:#0ea5e9; --chip:#e5f2fb; --chip-on:#0ea5e9; --chip-on-fg:#fff;
      --fs-title: clamp(18px, 2.2vw + 12px, 26px);
      --fs-body:  clamp(13px, 1.2vw + 10px, 16px);
      --fs-chip:  clamp(12px, 1vw  + 9px, 14px);
      --fs-btn:   clamp(14px, 1.2vw + 11px, 16px);
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{margin:0; background:var(--bg); color:var(--fg); font:var(--fs-body)/1.5 'Inter','PingFang TC','Noto Sans TC',sans-serif;}
    .wrap{max-width:480px; margin:auto; padding:12px;}
    .card{background:var(--card); border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.06); overflow:hidden;}
    .hero{width:100%; height:120px; object-fit:cover; display:none;}
    @media (min-width:768px){ .hero{height:180px;} }

    .title-bar{display:flex; align-items:center; justify-content:space-between; padding:12px 14px 6px; gap:8px;}
    .title{display:flex; align-items:center; gap:8px;}
    .title h1{margin:0; font-size:var(--fs-title); line-height:1.25; font-weight:800;}
    .logo{width:36px; height:36px; border-radius:8px; object-fit:cover; display:none;}
    .sub{color:var(--muted); padding:0 14px 10px;}

    /* 語言切換：Segmented control（只出現有資料的語言） */
    .lang{display:flex; background:#e5e7eb; border-radius:999px; padding:3px; gap:3px;}
    .lang button{
      border:0; background:transparent; padding:6px 10px; border-radius:999px;
      font-weight:700; cursor:pointer; color:#374151; min-width:44px;
    }
    .lang button.active{background:#111827; color:#fff;}

    /* Chips：固定三欄、等寬 */
    #chips{
      display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:8px; padding:0 14px 6px;
    }
    .chip{
      width:100%; padding:9px 8px; border-radius:999px; text-align:center;
      background:var(--chip); color:var(--fg); cursor:pointer; font-size:var(--fs-chip);
      user-select:none; white-space:nowrap; transition:.15s;
    }
    .chip.on{background:var(--chip-on); color:var(--chip-on-fg);}

    .actions{display:flex; gap:8px; padding:10px 14px 8px;}
    .btn{
      flex:1; height:44px; border:0; border-radius:12px; font-weight:700;
      font-size:var(--fs-btn); display:flex; align-items:center; justify-content:center; cursor:pointer;
    }
    .btn.primary{background:var(--pri); color:#fff;}
    .btn.secondary{background:#111827; color:#fff;}
    .btn:disabled{opacity:.7; cursor:not-allowed;}
    .spinner{width:18px; height:18px; border:2px solid rgba(255,255,255,.45);
      border-top-color:#fff; border-radius:50%; margin-right:8px; display:none; animation:spin .9s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn.loading .spinner{display:inline-block;}

    textarea{width:calc(100% - 28px); margin:0 14px 10px; padding:10px; min-height:64px; resize:vertical;
      border:1px solid #e5e7eb; border-radius:10px; font-size:var(--fs-body);}
    .footer-actions{display:flex; justify-content:center; padding:0 14px 16px;}
    .status{color:var(--muted); font-size:12px; text-align:center; padding:0 14px 14px;}
    #storeRow{display:none;} /* 只有沒帶 store 參數時才顯示（相容） */
    .row{display:flex; flex-wrap:wrap; gap:6px; padding:0 14px 6px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <img id="hero" class="hero" alt="hero" onerror="this.style.display='none'"/>

      <div class="title-bar">
        <div class="title">
          <img id="logo" class="logo" alt="logo" onerror="this.style.display='none'"/>
          <h1 id="title">為「<span id="title-store-name">門市</span>」寫一則短評</h1>
        </div>
        <div id="langBar" class="lang" aria-label="language switch"></div>
      </div>

      <div id="subtitle" class="sub">挑幾個重點，按「生成（AI）」就能得到自然的一段評論。</div>

      <div id="storeRow" class="row" style="margin-bottom:10px;">
        <div class="field"><label class="status" id="labStore">StoreID：</label><input id="store-input" placeholder="leegarnei" /></div>
        <div class="field"><label class="status" id="labAddTag">新增標籤：</label><input id="addTag" placeholder="輸入後按 Enter" /></div>
      </div>

      <div id="chips" style="margin-bottom:6px;"></div>

      <div class="actions">
        <button id="gen" class="btn primary"><span class="spinner"></span><span id="btnGen">✨ 生成（AI）</span></button>
        <button id="copy" class="btn"><span id="btnCopy">📋 複製</span></button>
      </div>

      <textarea id="output" placeholder="這裡會顯示 AI 生成的短評…"></textarea>

      <div class="footer-actions">
        <a id="openGoogle" class="btn secondary" target="_blank" rel="noopener noreferrer">🔍 <span id="btnOpen">開啟 Google 評論</span></a>
      </div>

      <div id="status" class="status" aria-live="polite"></div>
    </div>
  </div>

  <script>
    /* -------- 基礎工具 -------- */
    function getStoreFromURL() {
      const url = new URL(location.href);
      const byQuery = (url.searchParams.get('store') || url.searchParams.get('storeid') || '').trim();
      if (byQuery) return byQuery;
      const parts = url.pathname.replace(/^\/+/, '').split('/');
      const first = (parts[0] || '').trim().toLowerCase();
      if (!first || first === 'index.html' || first === 'favicon.ico' || first === 'api') return '';
      if (first === 's' && parts[1]) return (parts[1] || '').trim();
      return parts[0] || '';
    }
    function uniq(arr){ const out=[], seen={}; arr.forEach(s=>{ s=(s||'').trim(); if(s && !seen[s]){ seen[s]=1; out.push(s);} }); return out; }
    function withBuster(u){ if(!u) return ''; const sep = u.includes('?') ? '&':'?'; return u + sep + 'v=' + Date.now(); }
    function setImg(img, primary, fallback){
      if (primary) {
        img.onerror = function(){
          if (fallback && img.src !== fallback) { img.onerror = function(){ img.style.display='none'; }; img.src = withBuster(fallback); }
          else { img.style.display='none'; }
        };
        img.src = withBuster(primary); img.style.display='block'; return;
      }
      if (fallback) { img.onerror=function(){img.style.display='none'}; img.src=withBuster(fallback); img.style.display='block'; return; }
      img.style.display='none';
    }

    /* -------- 多語設定（Sheet 欄位對應） --------
       EN: D-G  -> top3En/featuresEn/ambianceEn/newItemsEn
       CN: J-M  -> top3Cn/featuresCn/ambianceCn/newItemsCn
       KO: N-Q  -> ...Ko
       FR: R-U  -> ...Fr
       JA: V-Y  -> ...Ja
       ES: Z-AC -> ...Es
    -------------------------------------------- */
    const LANGS = {
      en: { label:'EN', chips:['top3En','featuresEn','ambianceEn','newItemsEn'],
        ui:{title:'Write a short review for “{name}”', sub:'Pick a few highlights, then tap “Generate (AI)”.',
            store:'StoreID:', addtag:'Add tag:', gen:'✨ Generate (AI)', copy:'📋 Copy', open:'Open Google Reviews',
            placeholder:'Your AI review will appear here…'} },
      zh: { label:'中', chips:['top3Cn','featuresCn','ambianceCn','newItemsCn'],
        ui:{title:'為「{name}」寫一則短評', sub:'挑幾個重點，按「生成（AI）」就能得到自然的一段評論。',
            store:'StoreID：', addtag:'新增標籤：', gen:'✨ 生成（AI）', copy:'📋 複製', open:'開啟 Google 評論',
            placeholder:'這裡會顯示 AI 生成的短評…'} },
      ko: { label:'한국어', chips:['top3Ko','featuresKo','ambianceKo','newItemsKo'],
        ui:{title:'“{name}” 리뷰 한 줄', sub:'키워드를 고르고 “AI 생성”을 눌러 주세요.',
            store:'StoreID:', addtag:'태그 추가:', gen:'✨ AI 생성', copy:'📋 복사', open:'Google 리뷰 열기',
            placeholder:'AI가 생성한 리뷰가 여기에 표시됩니다…'} },
      fr: { label:'FR', chips:['top3Fr','featuresFr','ambianceFr','newItemsFr'],
        ui:{title:'Écrire un avis court pour « {name} »', sub:'Choisissez quelques points, puis « Générer (IA) ».',
            store:'StoreID:', addtag:'Nouveau tag :', gen:'✨ Générer (IA)', copy:'📋 Copier', open:'Ouvrir les avis Google',
            placeholder:'Votre avis généré apparaîtra ici…'} },
      ja: { label:'日本語', chips:['top3Ja','featuresJa','ambianceJa','newItemsJa'],
        ui:{title:'「{name}」へ一言レビュー', sub:'いくつかのポイントを選んで「AI 生成」を押してください。',
            store:'StoreID:', addtag:'タグ追加：', gen:'✨ AI 生成', copy:'📋 コピー', open:'Google 口コミを開く',
            placeholder:'AI が生成したレビューが表示されます…'} },
      es: { label:'ES', chips:['top3Es','featuresEs','ambianceEs','newItemsEs'],
        ui:{title:'Escribe una reseña corta para «{name}»', sub:'Elige algunos puntos y pulsa «Generar (IA)».',
            store:'StoreID:', addtag:'Añadir etiqueta:', gen:'✨ Generar (IA)', copy:'📋 Copiar', open:'Abrir reseñas de Google',
            placeholder:'La reseña generada aparecerá aquí…'} },
    };

    /* -------- DOM 與狀態 -------- */
    const $chips = document.getElementById('chips');
    const $storeRow = document.getElementById('storeRow');
    const $storeInput = document.getElementById('store-input');
    const $addTag = document.getElementById('addTag');
    const $gen = document.getElementById('gen');
    const $copy = document.getElementById('copy');
    const $output = document.getElementById('output');
    const $status = document.getElementById('status');
    const $titleStoreName = document.getElementById('title-store-name');
    const $openGoogle = document.getElementById('openGoogle');
    const $logo = document.getElementById('logo');
    const $hero = document.getElementById('hero');
    const $langBar = document.getElementById('langBar');
    const $title = document.getElementById('title');
    const $subtitle = document.getElementById('subtitle');
    const $labStore = document.getElementById('labStore');
    const $labAddTag = document.getElementById('labAddTag');
    const $btnGen = document.getElementById('btnGen');
    const $btnCopy = document.getElementById('btnCopy');
    const $btnOpen = document.getElementById('btnOpen');

    let selected = new Set();
    let currentStore = getStoreFromURL() || 'leegarnei';
    let currentLang = 'en';       // 預設英語（你的需求）
    let storeMeta = null;
    let availableLangs = [];

    if (!getStoreFromURL()) { $storeRow.style.display='flex'; if ($storeInput) $storeInput.value=currentStore; }

    function applyBasicLinks(nameText){
      $titleStoreName.textContent = nameText || currentStore || 'Store';
      const q = encodeURIComponent(currentStore || 'Big Way');
      $openGoogle.href = 'https://www.google.com/search?q=' + q + '+google+reviews';
    }

    /* -------- 語言 UI 與 Chips -------- */
    function langHasContent(langKey, data){
      const cfg = LANGS[langKey]; if(!cfg) return false;
      return cfg.chips.some(k => (data[k]||'').trim());
    }
    function buildLangBar(){
      $langBar.innerHTML = '';
      availableLangs.forEach(k=>{
        const btn = document.createElement('button');
        btn.textContent = LANGS[k].label;
        btn.className = (k===currentLang)?'active':'';
        btn.onclick = ()=>{ currentLang=k; renderUI(); buildChipsFromMeta(); };
        $langBar.appendChild(btn);
      });
    }
    function renderUI(){
      const ui = LANGS[currentLang].ui;
      const name = storeMeta?.name || currentStore || 'Store';
      $title.innerHTML = ui.title.replace('{name}', `<span id="title-store-name">${name}</span>`);
      $subtitle.textContent = ui.sub;
      $labStore.textContent = ui.store;
      $labAddTag.textContent = ui.addtag;
      $btnGen.textContent = ui.gen;
      $btnCopy.textContent = ui.copy;
      $btnOpen.textContent = ui.open;
      $output.placeholder = ui.placeholder;
    }
    function buildChipsFromMeta(){
      const cfg = LANGS[currentLang]; const data = storeMeta || {};
      let tags = [];
      cfg.chips.forEach(k=>{ if(data[k]) tags = tags.concat(String(data[k]).split(',')); });
      tags = uniq(tags).slice(0,18);
      if (tags.length===0){
        if (currentLang!=='en' && storeMeta && langHasContent('en', storeMeta)){
          currentLang='en'; renderUI(); buildLangBar(); return buildChipsFromMeta();
        }
        tags = ['boba','rice','dumpling','Nice service','clean environment','Couple date','family reunion','Fried noodles'];
      }
      selected.clear();
      $chips.innerHTML = '';
      tags.forEach(tag=>{
        const el = document.createElement('div');
        el.className='chip'; el.textContent=tag.trim();
        el.onclick=()=>{ if(selected.has(tag)) selected.delete(tag); else selected.add(tag); el.classList.toggle('on'); };
        $chips.appendChild(el);
      });
    }

    /* -------- 載入店家 meta -------- */
    async function loadStoreMeta(){
      try{
        const res = await fetch('/api/store?storeid=' + encodeURIComponent(currentStore));
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || ('HTTP '+res.status));
        storeMeta = data;

        applyBasicLinks(data.name || currentStore);

        const order = ['en','zh','ko','fr','ja','es'];
        availableLangs = order.filter(k => langHasContent(k, data));
        if (availableLangs.length===0) availableLangs = ['en'];
        if (!availableLangs.includes(currentLang)) currentLang = availableLangs[0];

        setImg($logo, data.logoUrl, data.placePhotoUrl);
        setImg($hero, data.heroUrl, data.placePhotoUrl);

        if (data.placeId) $openGoogle.href = 'https://search.google.com/local/writereview?placeid=' + encodeURIComponent(data.placeId);

        renderUI(); buildLangBar(); buildChipsFromMeta();
      }catch(e){
        console.error('loadStoreMeta error:', e);
        applyBasicLinks('Store'); $logo.style.display='none'; $hero.style.display='none';
      }
    }

    // 手動輸入 StoreID（相容）
    if ($storeInput) $storeInput.addEventListener('input', ()=>{ currentStore = ($storeInput.value||'').trim(); applyBasicLinks(); });

    // 新增自訂標籤
    if ($addTag) $addTag.addEventListener('keydown', e=>{
      if (e.key==='Enter'){
        const v = ($addTag.value||'').trim(); if(!v) return;
        const el = document.createElement('div'); el.className='chip on'; el.textContent=v;
        selected.add(v); el.onclick=()=>{ if(selected.has(v)) selected.delete(v); else selected.add(v); el.classList.toggle('on'); };
        $chips.prepend(el); $addTag.value='';
      }
    });

    // 初始化
    applyBasicLinks('Store'); loadStoreMeta();

    /* -------- 產生 / 複製 -------- */
    async function generate(){
      const storeid = (currentStore || '').trim();
      if (!storeid){ $status.textContent = (currentLang==='zh')?'請先指定 StoreID。':'Please set StoreID first.'; return; }
      const selectedTags = Array.from(selected);
      const body = { storeid, selectedTags, variant:1, minChars:90, maxChars:160 };

      $gen.classList.add('loading'); $gen.disabled=true; $copy.disabled=true;
      const prev = $gen.innerHTML; $gen.innerHTML = '<span class="spinner"></span>' + (currentLang==='zh'?'生成中…':'Generating…');
      $status.textContent='';

      try{
        const res = await fetch('/api/generate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || ('HTTP '+res.status));
        $output.value = data.reviewText || JSON.stringify(data,null,2);
        const okText = (currentLang==='zh')?'✅ 完成（延遲 ':'✅ Done (latency ';
        $status.textContent = okText + (data.latencyMs || '-') + ' ms)';
        if (data?.store?.placeId) $openGoogle.href = 'https://search.google.com/local/writereview?placeid=' + encodeURIComponent(data.store.placeId);
      }catch(err){
        $output.value=''; $status.textContent = (currentLang==='zh')?'❌ 發生錯誤：':'❌ Error: ' + err.message;
      }finally{
        $gen.classList.remove('loading'); $gen.disabled=false; $copy.disabled=false; $gen.innerHTML = prev;
      }
    }
    async function copyText(){
      const t = ($output.value||'').trim();
      if(!t){ $status.textContent = (currentLang==='zh')?'尚無內容可複製':'Nothing to copy'; return; }
      try{ await navigator.clipboard.writeText(t); $status.textContent = (currentLang==='zh')?'📋 已複製到剪貼簿':'📋 Copied to clipboard'; }
      catch{ $status.textContent = (currentLang==='zh')?'請手動選取文字複製':'Please copy manually'; }
    }
    document.getElementById('gen').addEventListener('click', generate);
    document.getElementById('copy').addEventListener('click', copyText);
  </script>
</body>
</html>

