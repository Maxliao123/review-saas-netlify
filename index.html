<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Google Review Â· AI ä¸€å‰‡çŸ­è©•</title>
  <style>
    :root { --bg:#f5f4f2; --fg:#1f2937; --card:#ffffff; --muted:#6b7280; --pri:#0ea5e9; --chip:#e5f2fb; --chip-on:#0ea5e9; --chip-on-fg:#fff; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--fg); font:16px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"PingFang TC","Noto Sans TC","Microsoft JhengHei",sans-serif; }
    .wrap { max-width:980px; margin:56px auto; padding:0 20px; }
    .card { background:var(--card); border-radius:16px; box-shadow:0 10px 24px rgba(0,0,0,.06); padding:28px; }
    .hero { width:100%; height:180px; object-fit:cover; border-radius:12px; display:none; margin-bottom:16px; }
    .title { display:flex; align-items:center; gap:10px; margin:0 0 6px; font-size:28px; }
    .logo { width:44px; height:44px; border-radius:10px; object-fit:cover; background:#eee; display:none; }
    .sub { color:var(--muted); margin-bottom:18px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .field { display:flex; gap:10px; align-items:center; }
    .field input { height:36px; padding:0 12px; border:1px solid #e5e7eb; border-radius:10px; outline:none; }
    .field input:focus { border-color:var(--pri); box-shadow:0 0 0 3px rgba(14,165,233,.15); }
    .chip { padding:8px 12px; background:var(--chip); border-radius:999px; cursor:pointer; user-select:none; transition:.15s; }
    .chip.on { background:var(--chip-on); color:var(--chip-on-fg); }
    .btn { height:40px; padding:0 14px; border:0; border-radius:12px; cursor:pointer; background:var(--pri); color:#fff; font-weight:600; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .btn.secondary { background:#111827; }
    .btn.ghost { background:#eef2f7; color:#111827; }
    textarea { width:100%; min-height:140px; resize:vertical; padding:12px; border:1px solid #e5e7eb; border-radius:12px; outline:none; }
    textarea:focus { border-color:var(--pri); box-shadow:0 0 0 3px rgba(14,165,233,.15); }
    .muted { color:var(--muted); font-size:13px; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px; }
    .footer-actions { display:flex; gap:10px; align-items:center; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- hero -->
      <img id="hero" class="hero" alt="hero" referrerpolicy="no-referrer" onerror="this.style.display='none'"/>

      <!-- æ¨™é¡Œï¼ˆå« logoï¼‰ -->
      <div class="title">
        <img id="logo" class="logo" alt="logo" referrerpolicy="no-referrer" onerror="this.style.display='none'"/>
        <h1 style="margin:0;">ç‚ºã€Œ<span id="title-store-name">é–€å¸‚</span>ã€å¯«ä¸€å‰‡çŸ­è©•</h1>
      </div>

      <div class="sub">å‹¾é¸å¹¾å€‹é‡é»ï¼Œå†æŒ‰ã€Œç”Ÿæˆï¼ˆAIï¼‰ã€å°±æœƒå¹«ä½ å¯«å‡ºè‡ªç„¶çš„ä¸€æ®µè©•è«–ã€‚</div>

      <!-- åªæœ‰æ²’æœ‰å¸¶ store åƒæ•¸æ™‚æ‰é¡¯ç¤º -->
      <div id="storeRow" class="row" style="margin-bottom:10px;">
        <div class="field">
          <label for="store-input" class="muted">StoreIDï¼š</label>
          <input id="store-input" placeholder="ä¾‹å¦‚ leegarnei" />
        </div>
        <div class="field">
          <label for="addTag" class="muted">æ–°å¢æ¨™ç±¤ï¼š</label>
          <input id="addTag" placeholder="è¼¸å…¥å¾ŒæŒ‰ Enter" />
        </div>
      </div>

      <!-- æ¨™ç±¤ Chips -->
      <div id="chips" class="row" style="margin-bottom:16px;"></div>

      <!-- å‹•ä½œæŒ‰éˆ•ï¼ˆä¸Šï¼‰ -->
      <div class="actions">
        <button id="gen" class="btn">âœ¨ ç”Ÿæˆï¼ˆAIï¼‰</button>
        <button id="copy" class="btn ghost">ğŸ“‹ è¤‡è£½</button>
      </div>

      <!-- çµæœ -->
      <textarea id="output" placeholder="é€™è£¡æœƒé¡¯ç¤º AI ç”Ÿæˆçš„çŸ­è©•â€¦"></textarea>

      <!-- å‹•ä½œæŒ‰éˆ•ï¼ˆè¼¸å‡ºæ¡†ä¸‹æ–¹ï¼‰ -->
      <div class="footer-actions">
        <a id="openGoogle" class="btn secondary" target="_blank" rel="noopener noreferrer">ğŸ” é–‹å•Ÿ Google è©•è«–</a>
        <span class="muted" id="status" aria-live="polite"></span>
      </div>
    </div>
  </div>

  <script>
    // è®€å– URL çš„ store / storeid
    function getStoreFromURL() {
      var url = new URL(location.href);
      var byQuery = (url.searchParams.get('store') || url.searchParams.get('storeid') || '').trim();
      if (byQuery) return byQuery;
      // è·¯å¾‘å‹ï¼ˆä¿ç•™ç›¸å®¹æ€§ï¼‰
      var parts = url.pathname.replace(/^\/+/, '').split('/');
      var first = (parts[0] || '').trim().toLowerCase();
      if (!first || first === 'index.html' || first === 'favicon.ico' || first === 'api') return '';
      if (first === 's' && parts[1]) return (parts[1] || '').trim();
      return parts[0] || '';
    }

    // DOM å…ƒç´ 
    var $chips = document.getElementById('chips');
    var $storeRow = document.getElementById('storeRow');
    var $storeInput = document.getElementById('store-input');
    var $addTag = document.getElementById('addTag');
    var $gen = document.getElementById('gen');
    var $copy = document.getElementById('copy');
    var $output = document.getElementById('output');
    var $status = document.getElementById('status');
    var $titleStoreName = document.getElementById('title-store-name');
    var $openGoogle = document.getElementById('openGoogle');
    var $logo = document.getElementById('logo');
    var $hero = document.getElementById('hero');

    // ç‹€æ…‹
    var selected = new Set();
    var currentStore = getStoreFromURL() || 'leegarnei';

    // æ˜¯å¦é¡¯ç¤º StoreID æ¬„ä½
    if (getStoreFromURL()) {
      $storeRow.style.display = 'none';
    } else {
      if ($storeInput) $storeInput.value = currentStore;
    }

    // å·¥å…·ï¼šå”¯ä¸€åŒ–
    function uniq(arr) {
      var out = [], seen = {};
      for (var i=0;i<arr.length;i++){
        var s = (arr[i] || '').trim();
        if (!s) continue;
        if (!seen[s]) { seen[s] = true; out.push(s); }
      }
      return out;
    }

    // ç”¢ç”Ÿèˆ‡åˆ‡æ› Tag
    function toggleTag(t) {
      if (selected.has(t)) selected.delete(t);
      else selected.add(t);
      // åŒæ­¥ UI æ¨£å¼
      var children = $chips.children;
      for (var i=0;i<children.length;i++) {
        var el = children[i];
        if (el.textContent === t) el.classList.toggle('on');
      }
    }

    function renderTagChips(tags) {
      $chips.innerHTML = '';
      for (var i=0;i<tags.length;i++){
        (function(tag){
          var el = document.createElement('div');
          el.className = 'chip';
          el.textContent = tag;
          el.onclick = function(){ toggleTag(tag); };
          $chips.appendChild(el);
        })(tags[i]);
      }
    }

    // å¾ meta å»ºç«‹ chipsï¼ˆtop3/features/ambiance/newItemsï¼‰
    function buildChipsFromMeta(data) {
      var tags = [];
      if (data.top3)     tags = tags.concat(data.top3.split(','));
      if (data.features) tags = tags.concat(data.features.split(','));
      if (data.ambiance) tags = tags.concat(data.ambiance.split(','));
      if (data.newItems) tags = tags.concat(data.newItems.split(','));
      tags = uniq(tags).slice(0, 20);
      if (tags.length === 0) {
        // å¾Œå‚™ï¼šé è¨­ç¨®å­
        tags = ['é»‘ç³–é¹¿ä¸¸é®®å¥¶','çš‡å®¶ä¹è™Ÿå¥¶èŒ¶','ç™½æ¡ƒçƒé¾','æœå‹™è¶…è¦ªåˆ‡','ç’°å¢ƒå¾ˆèˆ’æœ','é©åˆæ‹ç…§',
                'é©åˆæƒ…ä¾¶ç´„æœƒ','å®¶åº­èšé¤','æœ‹å‹å°é…Œ','é¹¹é…¥é›éºµ'];
      }
      renderTagChips(tags);
    }

    // æ›´æ–°é é¢æ¨™é¡Œèˆ‡ Google æœå°‹é€£çµï¼ˆè‹¥ç„¡ placeIdï¼‰
    function applyBasicLinks(nameText) {
      $titleStoreName.textContent = nameText || currentStore || 'é–€å¸‚';
      var q = encodeURIComponent(currentStore || 'Big Way');
      $openGoogle.href = 'https://www.google.com/search?q=' + q + '+google+reviews';
    }

    // ---- åœ–ç‰‡è¼‰å…¥å…±ç”¨å·¥å…·ï¼ˆç ´å¿«å– + Driveâ†’Places å‚™æ´ï¼‰----
    function withBuster(u){
      if(!u) return '';
      var sep = u.indexOf('?') >= 0 ? '&' : '?';
      return u + sep + 'v=' + Date.now();
    }
    function setImg(img, primary, fallback){
      if (primary) {
        img.onerror = function(){
          if (fallback && img.src !== fallback) {
            img.onerror = function(){ img.style.display = 'none'; };
            img.src = withBuster(fallback);
          } else {
            img.style.display = 'none';
          }
        };
        img.src = withBuster(primary);
        img.style.display = 'block';
        return;
      }
      if (fallback) {
        img.onerror = function(){ img.style.display = 'none'; };
        img.src = withBuster(fallback);
        img.style.display = 'block';
        return;
      }
      img.style.display = 'none';
    }

    // è¼‰å…¥åº—å®¶ metaï¼ˆå«åœ–ç‰‡èˆ‡ placeIdï¼‰
    async function loadStoreMeta() {
      try {
        var res = await fetch('/api/store?storeid=' + encodeURIComponent(currentStore));
        var data = await res.json();
        if (!res.ok) throw new Error((data && data.error) ? data.error : ('HTTP ' + res.status));

        // 1) åº—å
        applyBasicLinks(data.name || currentStore);

        // 2) æ¨™ç±¤
        buildChipsFromMeta(data);

        // 3) LOGOï¼šDrive â†’ Places å‚™æ´ â†’ éš±è—
        setImg($logo, data.logoUrl, data.placePhotoUrl);

        // 4) HEROï¼šDrive â†’ Places å‚™æ´ â†’ éš±è—
        setImg($hero, data.heroUrl, data.placePhotoUrl);

        // 5) ç›´æ¥é–‹å¯«è©•è«–ï¼ˆè‹¥æœ‰ placeIdï¼‰
        if (data.placeId) {
          $openGoogle.href = 'https://search.google.com/local/writereview?placeid=' + encodeURIComponent(data.placeId);
        }
      } catch (e) {
        console.error('loadStoreMeta error:', e);
        applyBasicLinks('é–€å¸‚');
        $logo.style.display = 'none';
        $hero.style.display = 'none';
      }
    }

    // ç›£è½ã€Œæ‰‹å‹•è¼¸å…¥ StoreIDã€
    if ($storeInput) {
      $storeInput.addEventListener('input', function(){
        currentStore = ($storeInput.value || '').trim();
        applyBasicLinks();
      });
    }

    // æ–°å¢è‡ªè¨‚æ¨™ç±¤
    if ($addTag) {
      $addTag.addEventListener('keydown', function(e){
        if (e.key === 'Enter') {
          var v = ($addTag.value || '').trim();
          if (!v) return;
          var tags = [];
          for (var i=0;i<$chips.children.length;i++) tags.push($chips.children[i].textContent);
          if (tags.indexOf(v) === -1) {
            tags.unshift(v);
            renderTagChips(tags);
            // é è¨­é¸å–æ–°åŠ å…¥çš„
            var kids = $chips.children;
            for (var j=0;j<kids.length;j++){
              if (kids[j].textContent === v) { kids[j].click(); break; }
            }
          }
          $addTag.value = '';
        }
      });
    }

    // åˆå§‹åŒ–
    applyBasicLinks('é–€å¸‚');
    loadStoreMeta();

    // ç”ŸæˆçŸ­è©•
    async function generate(){
      var storeid = (currentStore || '').trim();
      if (!storeid) { $status.textContent = 'è«‹å…ˆæŒ‡å®š StoreIDã€‚'; return; }
      var selectedTags = Array.from(selected);

      var body = { storeid: storeid, selectedTags: selectedTags, variant: 1, minChars: 90, maxChars: 160 };

      $gen.disabled = true; $copy.disabled = true;
      var prevTxt = $gen.textContent;
      $gen.textContent = 'ç”Ÿæˆä¸­â€¦';
      $status.textContent = '';

      try {
        var res = await fetch('/api/generate', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        var data = await res.json();
        if (!res.ok) throw new Error((data && data.error) ? data.error : ('HTTP ' + res.status));

        $output.value = data.reviewText || JSON.stringify(data, null, 2);
        $status.textContent = 'âœ… å®Œæˆï¼ˆå»¶é² ' + (data.latencyMs || '-') + ' msï¼‰';

        if (data && data.store && data.store.placeId) {
          $openGoogle.href = 'https://search.google.com/local/writereview?placeid=' + encodeURIComponent(data.store.placeId);
        }
      } catch (err) {
        $output.value = '';
        $status.textContent = 'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message;
      } finally {
        $gen.disabled = false; $copy.disabled = false;
        $gen.textContent = prevTxt;
      }
    }

    async function copyText(){
      var t = ($output.value || '').trim();
      if(!t){ $status.textContent = 'å°šç„¡å…§å®¹å¯è¤‡è£½'; return; }
      try {
        await navigator.clipboard.writeText(t);
        $status.textContent = 'ğŸ“‹ å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿';
      } catch(_e) {
        $status.textContent = 'è«‹æ‰‹å‹•é¸å–æ–‡å­—è¤‡è£½';
      }
    }

    document.getElementById('gen').addEventListener('click', generate);
    document.getElementById('copy').addEventListener('click', copyText);
  </script>
</body>
</html>

